<!DOCTYPE html>
<!-- saved from url=(0041)https://ambitious-grim-station.anvil.app/ -->
<html lang="en" class="js anvil-runner runner sizes customelements history pointerevents postmessage postmessage-structuredclones webgl websockets cssanimations csscolumns csscolumns-width csscolumns-span csscolumns-fill csscolumns-gap csscolumns-rule csscolumns-rulecolor csscolumns-rulestyle csscolumns-rulewidth csscolumns-breakbefore csscolumns-breakafter csscolumns-breakinside flexbox picture srcset webworkers"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!--<base href="https://ambitious-grim-station.anvil.app/">--><base href=".">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="referrer" content="never"> <!-- Yes, this is "legacy", but Safari and Edge don't support 'no-referrer' yet -->

  <meta name="og:title" content="Connect4_Team">
  <meta name="title" content="Connect4_Team">
  <meta name="og:type" content="website">
  <meta name="og:url" content="https://ambitious-grim-station.anvil.app">
  <meta name="og:image" content="https://ambitious-grim-station.anvil.app/_/theme/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg">
  <!--<xmeta name="og:image:width" content="400">-->
  <!--<xmeta name="og:image:height" content="400">-->
  <!--<xmeta name="og:site_name" content="Anvil">-->
  <meta name="og:description" content="This app is built with Anvil, the platform for building full-stack web apps quickly and robustly.">
  <meta name="description" content="This app is built with Anvil, the platform for building full-stack web apps quickly and robustly.">


  <title>Connect4_Team</title>

  <!-- <link rel="stylesheet" href="https://ambitious-grim-station.anvil.app/_/static/runtime/css/bootstrap.css?sha=adc8ee1e2b08f322404a" crossorigin/> -->
  <!-- <link rel="stylesheet" href="https://ambitious-grim-station.anvil.app/_/static/runtime/css/bootstrap-theme.min.css?sha=f2e1cc227d6bbb4192e4" crossorigin/> -->
  <style>
  .anvil-spinner{width:70px;height:70px}
  .anvil-spinner{color:#9A4523}
  </style>
  <link rel="stylesheet" href="./Connect4_Team_files/bootstrap.css" crossorigin="">
<link rel="stylesheet" href="./Connect4_Team_files/bootstrap-theme.min.css" crossorigin="">
<link rel="stylesheet" href="./Connect4_Team_files/animate.min.css" crossorigin="">
  <link rel="stylesheet" href="./Connect4_Team_files/runner.min.css" crossorigin="">
  <link rel="stylesheet" href="./Connect4_Team_files/runner-v3.min.css" crossorigin="">
  <link rel="stylesheet" href="./Connect4_Team_files/daterangepicker.min.css" crossorigin="">
  <!-- <link rel="stylesheet" href="https://ambitious-grim-station.anvil.app/_/static/runtime/node_modules/animate.css/animate.min.css?sha=8fe3fa119255adb5e0c1" crossorigin/> -->

  <link rel="stylesheet" href="./Connect4_Team_files/font-awesome.min.css" crossorigin="">

  <!-- Favicon things -->
  <link rel="icon" href="./Connect4_Team_files/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg">
  <link rel="manifest" href="https://ambitious-grim-station.anvil.app/_/manifest.json?buildTime=0">
  <link rel="apple-touch-icon" href="./Connect4_Team_files/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg">
  <meta name="apple-mobile-web-app-title" content="Connect4_Team">
  <meta name="application-name" content="Connect4_Team">
  <meta name="msapplication-TileColor" content="#2b5797">
  <meta name="msapplication-TileImage" content="https://ambitious-grim-station.anvil.app/_/theme/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg">
  <meta name="theme-color" content="#9A4523">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <style></style>
  <style>:root {
--anvil-color-Secondary-Container-f19c:#FFDBCF;
--anvil-color-Tertiary-Container-6be1:#F2E2A7;
--anvil-color-On-Background-3cff:#201A18;
--anvil-color-Disabled-Container-27f2:rgba(32, 26, 24, 0.12);
--anvil-color-On-Tertiary-5096:#FFFFFF;
--anvil-color-Outline-ee21:#85736D;
--anvil-color-On-Primary-Container-9a87:#380D00;
--anvil-color-Dark-Overlay-2-36f7:rgba(44, 22, 13, 0.12);
--anvil-color-On-Secondary-3a6e:#FFFFFF;
--anvil-color-On-Secondary-Container-2717:#2C160D;
--anvil-color-Primary-Container-3216:#FFDBCF;
--anvil-color-Secondary-c7a9:#77574C;
--anvil-color-On-Surface-Variant-7f9a:#53433E;
--anvil-color-Surface-Variant-c5a6:#F5DED6;
--anvil-color-Light-Overlay-1-bf28:rgba(255, 255, 255, 0.08);
--anvil-color-Tertiary-0e91:#695E2F;
--anvil-color-Light-Overlay-2-c245:rgba(255, 255, 255, 0.12);
--anvil-color-Primary-Overlay-2-c8f1:rgba(154, 69, 35, 0.08);
--anvil-color-Primary-6ee8:#9A4523;
--anvil-color-On-Tertiary-Container-f7b2:#221B00;
--anvil-color-Primary-Overlay-3-3ddf:rgba(154, 69, 35, 0.11);
--anvil-color-Primary-Overlay-1-ea6d:rgba(154, 69, 35, 0.05);
--anvil-color-On-Surface-ee20:#201A18;
--anvil-color-On-Disabled-f939:rgba(32, 26, 24, 0.38);
--anvil-color-Error-6b19:#BA1A1A;
--anvil-color-Background-fb89:#FFFBFF;
--anvil-color-Dark-Overlay-1-6be4:rgba(44, 22, 13, 0.08);
--anvil-color-Surface-70aa:#FFFBFF;
--anvil-color-On-Primary-d4ad:#FFFFFF;
}</style>
  
<style>
/**
 This CSS implements the Material Design 3 look and feel for Anvil apps.
 **/

/* Stop panel-cols cutting off drop shadows */
.anvil-panel-col {
  padding-bottom: 10px;
  margin-bottom: -10px;
}

.content > .placeholder {
  margin: 16px;
  color: #888;
  font-size: 18px;
  outline: 1px dotted;
  padding: 16px;
  text-align: center;
}

/* Put things on a 4px grid (none of this 7px nonsense) */
.has-text .anvil-component-icon.left-icon { margin-right: 8px; }
.has-text .anvil-component-icon.right-icon { margin-left: 8px; }

a>.anvil-component-icon.left_edge-icon,
a>.anvil-component-icon.right_edge-icon,
.anvil-label>.anvil-component-icon.left_edge-icon,
.anvil-label>.anvil-component-icon.right_edge-icon {
  padding-top: 8px;
  padding-bottom: 8px;
}
.anvil-label>.label-text, a>.link-text {
  padding-top: 8px;
  padding-bottom: 8px;
}
.file-loader>label {
    padding: 8px;
}
.checkbox label, .radio label {
    padding-top: 8px; padding-right: 8px; padding-bottom: 8px;
}

/*TODO: see if this spacing stuff needs to be changed*/
.anvil-spacing-above-none { margin-top: 0px; }
.anvil-spacing-above-small { margin-top: 4px; }
.anvil-spacing-above-medium { margin-top: 8px; }
.anvil-spacing-above-large { margin-top: 16px; }
.anvil-spacing-below-none { margin-bottom: 0px; }
.anvil-spacing-below-small { margin-bottom: 4px; }
.anvil-spacing-below-medium { margin-bottom: 8px; }
.anvil-spacing-below-large { margin-bottom: 16px; }


.col-padding.col-padding-tiny { padding: 0 2px; }
.column-panel.col-padding-tiny > .anvil-panel-section > .anvil-panel-section-container > .anvil-panel-section-gutter { margin: 0 -2px; }

.col-padding.col-padding-small { padding: 0 4px; }
.column-panel.col-padding-small > .anvil-panel-section > .anvil-panel-section-container > .anvil-panel-section-gutter { margin: 0 -4px; }

.col-padding.col-padding-medium { padding: 0 8px; }
.column-panel.col-padding-medium > .anvil-panel-section > .anvil-panel-section-container > .anvil-panel-section-gutter { margin: 0 -8px; }

.col-padding.col-padding-large { padding: 0 12px; }
.column-panel.col-padding-large > .anvil-panel-section > .anvil-panel-section-container > .anvil-panel-section-gutter { margin: 0 -12px; }

.col-padding.col-padding-huge { padding: 0 20px; }
.column-panel.col-padding-huge > .anvil-panel-section > .anvil-panel-section-container > .anvil-panel-section-gutter { margin: 0 -20px; }

.flow-panel.flow-spacing-tiny > .flow-panel-gutter { margin: 0 -2px; }
.flow-panel.flow-spacing-tiny > .flow-panel-gutter > .flow-panel-item { 
  margin-left: 2px;
  margin-right: 2px;
}

.flow-panel.flow-spacing-small > .flow-panel-gutter { margin: 0 -4px; }
.flow-panel.flow-spacing-small > .flow-panel-gutter > .flow-panel-item { 
  margin-left: 4px;
  margin-right: 4px;
}

.flow-panel.flow-spacing-medium > .flow-panel-gutter { margin: 0 -8px; }
.flow-panel.flow-spacing-medium > .flow-panel-gutter > .flow-panel-item { 
  margin-left: 8px;
  margin-right: 8px;
}

.flow-panel.flow-spacing-large > .flow-panel-gutter { margin: 0 -12px; }
.flow-panel.flow-spacing-large > .flow-panel-gutter > .flow-panel-item { 
  margin-left: 12px;
  margin-right: 12px;
}

.flow-panel.flow-spacing-huge > .flow-panel-gutter { margin: 0 -20px; }
.flow-panel.flow-spacing-huge > .flow-panel-gutter > .flow-panel-item{ 
  margin-left: 20px;
  margin-right: 20px;
}


/* Typography */
body {
  font-family: Roboto, Noto, Arial, sans-serif;
  font-size: 14px;
  line-height: 1.4286;
  color: var(--anvil-color-On-Surface-ee20);
  background-color: var(--anvil-color-Background-fb89);
  min-height: calc(100vh - 56px)
}

@media print {
  body {
    background-color: white;
  }
}

a, a:focus {
  text-decoration: none;
  color: var(--anvil-color-Primary-6ee8);
}

a:hover, a:active {
color: var(--anvil-color-On-Primary-Container-9a87);
}

.anvil-role-display {
  font-size: 57px;
  line-height: 64px;
  font-weight: 400;
}

.anvil-role-headline {
  font-size: 32px;
  line-height: 40px;
  font-weight: 400;
}

.anvil-role-title {
  font-size: 22px;
  line-height: 28px;
  font-weight: 500;
}

.anvil-role-body {
  font-size: 14px;
  line-height: 20px;
  font-weight: 400;
}

.anvil-role-input-prompt {
  font-size: 16px;
  line-height: 1.5;
}

.anvil-role-body > .label-text, .anvil-role-body .link-text {
  padding-top: 0;
  padding-bottom: 0;
}

/* Page structure: App bar with optional left nav */
.structure {
/*   display: flex;
  flex-direction: column; */
  min-height: 100vh;
  min-height: calc(100vh - 50px);
/*   height: 0; /* To make flex-grow work in IE */
}

/* However, this breaks the designer's height measurement. IE isn't supported for the designer, so set it back. */
.designer .structure {
  height: initial;
}

.app-bar {
  z-index: 1000;
  position: fixed;
  top: 0;
  top: 50px;
  right: 0;
  left: 0;
/*   flex: 0 0;
  flex-basis: auto;
  flex-basis: content; */
}

.nav-holder {
  display: flex;
/*   flex-grow: 1;
  overflow-y: initial; */
}

@media print {
  .nav-holder {
    overflow-y: initial;
  }
}


/* Mobile and desktop margins for content */
.content > * > .anvil-container {
  padding: 8px;
}

@media(min-width:991px) {
  .content > * > .anvil-container {
    padding: 16px 24px;
  }
}

.content .anvil-measure-this {
  padding-bottom: 1px; /* Prevent margin collapse messing up embedding */
}

/* Allow overflows to show drop shadows in ColumnPanels
   This can create unwanted scrollbars; we compensate for this at the top level with .nav-holder .content {overflow-x: hidden;}
*/
.anvil-container-overflow {
  overflow-x: visible;
  overflow-y: visible;
}

/* Desktop: Nav bar pinned */

.nav-holder {
  display: flex;
  flex-direction: row;
}

.nav-holder .left-nav {
  position: fixed;
/*   top: 0; */
  left: 0;
  flex-shrink: 0;
  min-width: 240px;
  max-width: 400px;
}

.nav-shield {
  display: none;
}

/* Mobile: Nav bar is a modal overlay */

@media(max-width:998px) {
  html:not(.designer) .nav-holder {
    display: block;
  }
  html:not(.designer) .nav-holder .left-nav {
    top: 0;
    bottom: 0;
    width: calc(100% - 56px);
    max-width: 360px;
    z-index: 3;
    border-right: none;
    border-radius: 0 20px 20px 0;
  /* 16dp */ box-shadow: 0 16px 24px 2px rgba(0, 0, 0, 0.14), 0 6px 30px 5px rgba(0, 0, 0, 0.12), 0 8px 10px -5px rgba(0, 0, 0, 0.2);

    display: none;
    transition: right 0.5s;
    height: 100%;
  }
  
  html:not(.designer) .nav-holder .left-nav.shown {
    display: block;
  }
  .nav-shield.shown {
    display: block;
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 2;
    background-color: rgba(0,0,0,0.2);
  }
 }

.nav-holder .left-nav, .left-nav-placeholder {
  display: flex;
  flex-direction: column;
  background: linear-gradient(0deg, var(--anvil-color-Primary-Overlay-1-ea6d), var(--anvil-color-Primary-Overlay-1-ea6d)), var(--anvil-color-Background-fb89);
/*   border-right: 1px solid #e0e0e0; */
  font-size: 14px;
  font-weight: 500;
  color: var(--anvil-color-On-Surface-Variant-7f9a);
  overflow-x: hidden;
  overflow-y: auto;
  position: fixed;
/*   top: 54px; */
  height: calc(100% - 54px); /*todo: fix on mobile*/
}


.left-nav-placeholder {
  display: block;
  padding: 8px;
  line-height: 1;
  width: 58px;
}
.left-nav-placeholder .prompt {
  display: inline-block;
  white-space: nowrap;
  transform: translate(-50%,0) rotate(-90deg) translate(-50%,0) translate(15px,16px);
  padding: 16px 16px;
  color: #888;
  outline: 1px dotted #888;
  visibility: hidden;
}
.anvil-highlight .left-nav-placeholder .prompt {
  visibility: visible;
}

.left-nav > .column-panel {
  padding: 24px 0;
}
.left-nav > .column-panel > .anvil-panel-section > .anvil-panel-section-container:not(.full-width-row) {
  margin: 0 16px;
  width: initial;
  max-width: initial;
  overflow-x: visible;
}
.left-nav > .column-panel > .anvil-panel-section:first-child > .anvil-panel-section-container.full-width-row {
  margin-top: -24px;
}
.left-nav > .column-panel > .anvil-panel-section > .anvil-panel-section-container > .anvil-panel-section-gutter > .anvil-panel-row > .anvil-panel-col {
  overflow-x: visible;
}

/* Make all the sidebar icons look nice */

.left-nav .anvil-component-icon.left-icon {
  width: 0;
  margin-right: 24px;
  position: relative;
}

.left-nav .anvil-component-icon.left_edge-icon, .left-nav .anvil-component-icon.right_edge-icon {
  left: 16px;
  padding-top: 2px;
  width: 0;
}

.left-nav .anvil-component-icon.right_edge-icon {
  left: initial;
  right: 16px;
  top: 0;
  padding-top: 2px;
}

/* Sidebar links (and labels with edge icons) go +16px wider
   (Top-level columns in ColumnPanels get overflow-x visible [see above]to enable this)
*/

.left-nav a, .left-nav .anvil-label, .left-nav .anvil-label.left_edge-icon, .left-nav .anvil-label.right_edge-icon {
  color: var(--anvil-color-On-Surface-Variant-7f9a);
  margin: 0 -8px;
  padding: 4px 16px;
  border-radius: 100px;
}

.left-nav .anvil-component.left_edge-icon {
  padding-left: 72px;
}

.left-nav a:hover, .app-bar a:hover, .app-bar a:active {
  background: linear-gradient(0deg, var(--anvil-color-Dark-Overlay-1-6be4), var(--anvil-color-Dark-Overlay-1-6be4)), linear-gradient(0deg, var(--anvil-color-Primary-Overlay-1-ea6d), var(--anvil-color-Primary-Overlay-1-ea6d)), var(--anvil-color-Background-fb89);
  opacity: 100%;
}

.left-nav a.anvil-role-selected, .app-bar a.anvil-role-selected  {
  background-color: var(--anvil-color-Secondary-Container-f19c);
  color: var(--anvil-color-On-Secondary-Container-2717);
}

.left-nav a.anvil-role-selected:hover, .app-bar a.anvil-role-selected:hover {
  background: linear-gradient(0deg, var(--anvil-color-Dark-Overlay-1-6be4), var(--anvil-color-Dark-Overlay-1-6be4)), var(--anvil-color-Secondary-Container-f19c);
}

.designer .nav-holder .left-nav {
  min-width: 56px;
}

.designer .nav-holder .left-nav > .anvil-component {
  min-width: 160px;
}

.nav-holder .left-nav > .anvil-component {
  margin-top: 0;
  margin-bottom: 0;
}

.nav-holder {
  flex: 1;
}

.content {
  flex: 1;
  overflow-x: hidden;
}

/* Components: App Bar */
.app-bar {
  min-height: 56px;
  padding: 0 16px 0 72px;
  position: fixed;
  width: 100%;
  
  line-height: 40px;
  font-size: 20px;

  background-color: var(--anvil-color-Surface-70aa);
  transition: background-color 250ms;
  -webkit-transition: background-color 250ms;
  -moz-transition: background-color 250ms;
  -o-transition: background-color 250ms;
  
  z-index: 1;
}

.app-bar.scrolled {
  background: linear-gradient(0deg, var(--anvil-color-Primary-Overlay-2-c8f1), var(--anvil-color-Primary-Overlay-2-c8f1)), var(--anvil-color-Background-fb89);
  transition: background 250ms;
  -webkit-transition: background 250ms;
  -moz-transition: background 250ms;
  -o-transition: background 250ms;
}

.app-bar .anvil-component {
  margin-top: 0;
  margin-bottom: 0;
}

.app-bar > .sidebar-toggle { display:block; float:left;  margin-left: -61px; }
.app-bar > .top-left-btn { float: left; margin-left: -60px; margin-right: -40px; }
.app-bar > .title { float: left; }
.app-bar > .title > .placeholder { outline: 1px dotted; padding-left: 16px; padding-right: 16px; margin: 8px 8px 0; display:none; }
.app-bar > .app-bar-nav { float: right; font-weight: normal; }
.app-bar > .app-bar-nav .placeholder { margin-top: 8px; padding: 0 8px; }
.anvil-highlight .app-bar > .app-bar-nav .placeholder { outline: 1px dotted #ccc; }
.anvil-highlight .app-bar > .title > .placeholder { display:block; }

.app-bar a, .app-bar .anvil-component {
  display: block;
  color: var(--anvil-color-On-Surface-ee20);
  line-height: 30px;
  min-width: 30px;
  min-height: 30px;
  margin: 5px 4px 0;
}

.app-bar .title .anvil-component {
  margin-left: 0;
}

.app-bar input.anvil-component, .app-bar .anvil-component input {
  line-height: 30px;
  color: white;
}

.app-bar select.form-control {
  height: 43px; /* 30px line height + 12px padding + 1px border */
}

.app-bar .anvil-component-icon-present .anvil-component-icon, .app-bar .sidebar-toggle .fa {
  width: 30px;
  text-align: center;
}

/* Don't put spacing on the top-level container (eg FlowPanel) */
.app-bar-nav > .anvil-container {
  margin: 0;
  padding: 0;
  min-height: 56px;
}

.anvil-highlight .app-bar-nav > .anvil-container:not(.has-components):not(a) {
  outline: 1px dotted #fff;
  margin-top: 8px;
  min-height: 40px;
  padding: 5px 8px;
}

.anvil-highlight .app-bar-nav > .anvil-container:not(.has-components):not(a)::after {  
  content: "Drop Links here"
}

/* Rejig margin vs padding to give links the halo */
.app-bar a, .app-bar a.anvil-component {
  padding: 5px;
  margin: 8px 0 0;
  border-radius: 20px;
}

.app-bar a .link-text {
  padding: 0 4px;
}
.app-bar a.has-text .anvil-component-icon.left {
  margin-right: 4px;
}
.app-bar a.has-text .anvil-component-icon.right {
  margin-left: 4px;
}


/* Component: Dialog (alert), Notification */
.modal-content, body>div[data-notify="container"] {
  border-radius: 28px;
  background: linear-gradient(0deg, var(--anvil-color-Primary-Overlay-3-3ddf), var(--anvil-color-Primary-Overlay-3-3ddf)), var(--anvil-color-Background-fb89);
  box-shadow: none;
  border: none;
}

.modal-header {
  padding: 24px 24px 0px;
  font-size: 24px;
  line-height: 32px;
  border: 0;
  color: var(--anvil-color-On-Surface-ee20);
}

.modal-body {
  padding: 24px;
  font-size: 16px;
  color: var(--anvil-color-On-Surface-Variant-7f9a);
}

.modal-footer {
  padding: 0px 8px 14px 24px;
  border: 0;
}

.modal-footer .btn, .modal-footer .btn:focus, .modal-footer .btn:active {
  box-shadow: none;
  top: 0;
}

/* Notifications */
body>div[data-notify="container"] {
  background: linear-gradient(0deg, var(--anvil-color-Primary-Overlay-3-3ddf), var(--anvil-color-Primary-Overlay-3-3ddf)), var(--anvil-color-Background-fb89);
  border: none;
  padding: 24px;
  /* 24dp */ box-shadow: 0 9px 46px 8px rgba(0, 0, 0, 0.14), 0 11px 15px -7px rgba(0, 0, 0, 0.12), 0 24px 38px 3px rgba(0, 0, 0, 0.2);
}

body>div[data-notify="container"]>span[data-notify="title"] {
  display: block;
  font-size: 18px;
  font-weight: 500;
  color: var(--anvil-color-On-Surface-ee20);
}

body>div[data-notify="container"]>span[data-notify="message"] {
  display: block;
  padding: 20px 0 0;
  font-size: 16px;
  color: var(--anvil-color-On-Surface-Variant-7f9a);  
}

body>div[data-notify="container"].alert-success{
  background-color: #d4edda;
}

body>div[data-notify="container"].alert-success>span[data-notify="title"]{
  color: #155724;
}

body>div[data-notify="container"].alert-danger{
  background-color: #f8d7da;
}

body>div[data-notify="container"].alert-danger>span[data-notify="title"]{
  color: #721c24;
}

body>div[data-notify="container"].alert-warning{
  background-color: #fff3cd;
}

body>div[data-notify="container"].alert-warning>span[data-notify="title"]{
  color: #856404;
}

button.close > span, button.close {
  color:var(--anvil-color-On-Background-3cff);
  text-shadow: 0 1px 0 var(--anvil-color-Background-fb89);
}

/* Component: Button */

.btn, .btn-default, .file-loader>label {
  border-radius: 100px;
  font-size: 14px;
  font-weight: 500;
  padding: 10px 24px;
  min-height: 40px;
  letter-spacing: 0.1px;

  border: 0;
  background-image: none;
  background-color: transparent;
  color: var(--anvil-color-Primary-6ee8);
  text-shadow: none;
  box-shadow: none;
  -webkit-box-shadow: none;
  
  position: relative;
}

.btn:hover,.file-loader>label:hover {
  background-color: var(--anvil-color-Light-Overlay-1-bf28);
  background-image: none;
  outline: none;
  color: var(--anvil-color-Primary-6ee8);
}

.btn:active, .btn:focus, .btn:active:focus, .file-loader>label:active, .file-loader>label:focus, .file-loader>label:active:focus {
  background-color: var(--anvil-color-Light-Overlay-2-c245);
  background-image: none;
  outline: none;
  box-shadow: none;
  color: var(--anvil-color-Primary-6ee8);
}


.anvil-role-outlined-button > .btn, .anvil-role-outlined-button.file-loader>label {
  color: var(--anvil-color-Primary-6ee8);
  border: solid 1px var(--anvil-color-Outline-ee21);
}

.anvil-role-outlined-button > .btn:hover, .anvil-role-outlined-button.file-loader>label:hover {
  background-color: var(--anvil-color-Light-Overlay-1-bf28);
}

.anvil-role-outlined-button > .btn:focus, .anvil-role-outlined-button > .btn:active, 
.anvil-role-outlined-button.file-loader>label:focus, .anvil-role-outlined-button.file-loader>label:active{
  background-color: var(--anvil-color-Light-Overlay-2-c245);
  color: var(--anvil-color-Primary-6ee8);
}

.anvil-role-filled-button > .btn, .btn-primary, .anvil-role-filled-button.file-loader>label {
  background-color: var(--anvil-color-Primary-6ee8);
  color: var(--anvil-color-On-Primary-d4ad); 
}

.anvil-role-filled-button > .btn:hover, .btn-primary:hover, .anvil-role-filled-button.file-loader>label:hover {
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
  background: linear-gradient(0deg, var(--anvil-color-Light-Overlay-1-bf28), var(--anvil-color-Light-Overlay-1-bf28)), var(--anvil-color-Primary-6ee8);
  color: var(--anvil-color-On-Primary-d4ad); 
}

.anvil-role-filled-button > .btn:focus, .btn-primary:focus, .anvil-role-filled-button > .btn:active, 
.btn-primary:active, .anvil-role-filled-button > .btn:active:hover, .btn-primary:active:hover,
.anvil-role-filled-button.file-loader>label:focus, .anvil-role-filled-button.file-loader>label:active, 
.anvil-role-filled-button.file-loader>label:active:focus
{
  background: linear-gradient(0deg, var(--anvil-color-Light-Overlay-2-c245), var(--anvil-color-Light-Overlay-2-c245)), var(--anvil-color-Primary-6ee8);
  color: var(--anvil-color-On-Primary-d4ad); 
}

.anvil-role-elevated-button > .btn, .anvil-role-elevated-button.file-loader>label {
  color: var(--anvil-color-Primary-6ee8);
  background-color: var(--anvil-color-Surface-70aa);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
}

.anvil-role-elevated-button > .btn:focus, .anvil-role-elevated-button > .btn:active, 
.anvil-role-elevated-button > .btn:active:focus, .anvil-role-elevated-button.file-loader>label:focus, 
.anvil-role-elevated-button.file-loader>label:active, .anvil-role-elevated-button.file-loader>label:active:focus {
  background: linear-gradient(0deg, var(--anvil-color-Light-Overlay-2-c245), var(--anvil-color-Light-Overlay-2-c245)), var(--anvil-color-Surface-70aa);
  color: var(--anvil-color-Primary-6ee8);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
}

.anvil-role-elevated-button > .btn:hover, .anvil-role-elevated-button.file-loader>label:hover {
  background: linear-gradient(0deg, var(--anvil-color-Light-Overlay-1-bf28), var(--anvil-color-Light-Overlay-1-bf28)), var(--anvil-color-Surface-70aa);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3), 0 2px 6px 2px rgba(0, 0, 0, 0.15);
}

.anvil-role-tonal-button > .btn, .anvil-role-tonal-button.file-loader>label {
  color: var(--anvil-color-On-Secondary-Container-2717);
  background-color: var(--anvil-color-Secondary-Container-f19c);
}

.anvil-role-tonal-button > .btn:focus, .anvil-role-tonal-button > .btn:active, .anvil-role-tonal-button > .btn:active:focus, 
.anvil-role-tonal-button.file-loader>label:focus, .anvil-role-tonal-button.file-loader>label:active, .anvil-role-tonal-button.file-loader>label:focus:active {
  background: linear-gradient(0deg, var(--anvil-color-Dark-Overlay-2-36f7), var(--anvil-color-Dark-Overlay-2-36f7)), var(--anvil-color-Secondary-Container-f19c);
  color: var(--anvil-color-On-Secondary-Container-2717);
}

.anvil-role-tonal-button > .btn:hover, .anvil-role-tonal-button.file-loader>label:hover{
  background: linear-gradient(0deg, var(--anvil-color-Dark-Overlay-1-6be4), var(--anvil-color-Dark-Overlay-1-6be4)), var(--anvil-color-Secondary-Container-f19c);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
  color: var(--anvil-color-On-Secondary-Container-2717);
}

.btn-default[disabled], .btn-default[disabled]:hover, .file-loader.anvil-disabled>label, .file-loader.anvil-disabled>label:hover {
  background: transparent;
  color: var(--anvil-color-On-Disabled-f939);
}

.anvil-role-tonal-button > .btn[disabled], .anvil-role-tonal-button> .btn[disabled]:hover, 
.anvil-role-tonal-button.file-loader.anvil-disabled>label, .anvil-role-tonal-button.file-loader.anvil-disabled>label:hover, 
.anvil-role-filled-button > .btn[disabled], .anvil-role-filled-button > .btn[disabled]:hover, 
.anvil-role-filled-button.file-loader.anvil-disabled>label, .anvil-role-filled-button.file-loader.anvil-disabled>label:hover, 
.anvil-role-elevated-button > .btn[disabled], .anvil-role-elevated-button > .btn[disabled]:hover, 
.anvil-role-elevated-button.file-loader.anvil-disabled>label, .anvil-role-elevated-button.file-loader.anvil-disabled>label:hover { 
  background: var(--anvil-color-Disabled-Container-27f2);
  color: var(--anvil-color-On-Disabled-f939);
  box-shadow: none;
}

.anvil-role-outlined-button > .btn[disabled], .anvil-role-outlined-button.file-loader.anvil-disabled>label {
  border-color: var(--anvil-color-On-Disabled-f939);
  background-color: transparent;
}


/* Component: Card */

.anvil-role-outlined-card {
  overflow: hidden;
  border-radius: 12px;
  background-color: var(--anvil-color-Surface-70aa);
  border: solid 1px var(--anvil-color-Outline-ee21);
  padding: 15px;
}

.anvil-role-elevated-card {
  overflow: hidden;
  border-radius: 12px;
  background-color: var(--anvil-color-Surface-70aa);
  /* 2dp */  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3), 0 2px 6px 2px rgba(0, 0, 0, 0.15);
  padding: 15px;
}

.anvil-role-tonal-card {
  overflow: hidden;
  border-radius: 12px;
  background-color: var(--anvil-color-Surface-Variant-c5a6);
  padding: 15px;
}


/* full_width_row sections go full bleed */
.column-panel.anvil-role-card > .anvil-panel-section > .anvil-panel-section-container.full-width-row {
  margin-left: -12px;
  margin-right: -12px;
  width: initial;
  max-width: initial;
}

/* If the first row of a card is a full_width_row, it goes to the top */
.column-panel.anvil-role-card > .anvil-panel-section:first-child > .anvil-panel-section-container.full-width-row {
  margin-top: -8px;
}
.column-panel.anvil-role-card > .anvil-panel-section:last-child > .anvil-panel-section-container.full-width-row {
  margin-bottom: -8px;
}



/* Component: TextBox + TextArea */

/*this affects dropdowns, text boxes and text areas:*/
input.anvil-component, textarea.anvil-component, .anvil-component select, .anvil-datepicker input {
  font-size: 16px;
  line-height: 1.5;
  border-radius: 4px 4px 0 0;
  background-color: var(--anvil-color-Surface-Variant-c5a6);
  color: var(--anvil-color-On-Surface-Variant-7f9a);
  box-shadow: none;
}

.anvil-dropdown {
  font-size: 16px;
}

.anvil-component select {
  font-size: inherit;
}

input.anvil-component, .anvil-component select, .anvil-datepicker input, textarea.anvil-component {
  padding: 8px 16px;
  border: 0;
  border-bottom: 1px solid var(--anvil-color-Outline-ee21);
}

.anvil-dropdown select.form-control {
  
  -webkit-appearance: none;
  -moz-appearance: none;
/*   padding: 8px 2em 4px 0; */
  
  /* ew ew ew - select elements are weird and don't obey line-height, so we just
     set the height explicitly. Ugh. */
  height: calc(1.5em + 13px); /* 8px + 4px padding + 1px border = 13px */
}

.anvil-dropdown {
  position: relative;
}
/* Select arrow styling */
.anvil-dropdown form:before {
    content: "\25BC";
    position: absolute;
    right: 0;
    font-size: 80%;
    line-height: calc(1.8em + 8px);
    color: var(--anvil-color-Outline-ee21);
    pointer-events:none;
    padding: 4px 4px;
}

.anvil-component select, .anvil-datepicker input { margin-bottom: 4px; }
input.anvil-component.anvil-spacing-below-none { margin-bottom: 4px; }
input.anvil-component.anvil-spacing-below-small { margin-bottom: 8px; }
input.anvil-component.anvil-spacing-below-medium { margin-bottom: 12px; }
input.anvil-component.anvil-spacing-below-large { margin-bottom: 20px; }

input.anvil-component::-webkit-input-placeholder, textarea.anvil-component::-webkit-input-placeholder {
  color: var(--anvil-color-On-Surface-ee20);
}
input.anvil-component::-moz-placeholder, textarea.anvil-component::-moz-placeholder {
  color: var(--anvil-color-On-Surface-ee20);
}
input.anvil-component::placeholder, textarea.anvil-component::placeholder  {
  color: var(--anvil-color-On-Surface-ee20);
}

.app-bar input.anvil-component::-webkit-input-placeholder, .app-bar textarea.anvil-component::-webkit-input-placeholder {
  color: var(--anvil-color-On-Surface-ee20);
}
.app-bar input.anvil-component::-moz-placeholder, .app-bar textarea.anvil-component::-moz-placeholder {
  color: var(--anvil-color-On-Surface-ee20);
}
.app-bar input.anvil-component::placeholder, .app-bar textarea.anvil-component::placeholder  {
  color: var(--anvil-color-On-Surface-ee20);
}

input.anvil-component:hover, input.anvil-component:focus, textarea.anvil-component:hover, textarea.anvil-component:focus, 
.anvil-component select:hover, .anvil-component select:focus, .anvil-datepicker input:hover, .anvil-datepicker input:focus {
  border-bottom: 2px solid var(--anvil-color-Primary-6ee8);
  padding-bottom: 7px;
  box-shadow: none;
}


input.anvil-component[disabled], .anvil-component select[disabled], .anvil-datepicker input[disabled], textarea.anvil-component[disabled], 
textarea.anvil-component.anvil-role-input-error[disabled], input.anvil-component.anvil-role-input-error[disabled], 
.anvil-component.anvil-role-input-error select[disabled], .anvil-datepicker.anvil-role-input-error input[disabled] {
  background-color: var(--anvil-color-Dark-Overlay-1-6be4);
  color: var(--anvil-color-On-Disabled-f939);
  border-bottom: 1px solid var(--anvil-color-On-Disabled-f939);
  padding-bottom: 8px;
}

.anvil-component select:hover, .anvil-component select:focus {
  padding-bottom: 3px;
}

/* Outlined role for text areas, text boxes, drop downs and date pickers */
textarea.anvil-component.anvil-role-outlined, input.anvil-component.anvil-role-outlined, 
.anvil-component.anvil-role-outlined select, .anvil-datepicker.anvil-role-outlined input {
  background-color: transparent;
  border: 1px solid var(--anvil-color-Outline-ee21);
  border-radius: 4px;
  color: var(--anvil-color-On-Surface-ee20);
}

textarea.anvil-component.anvil-role-outlined:hover, textarea.anvil-component.anvil-role-outlined:focus, 
input.anvil-component.anvil-role-outlined:hover, input.anvil-component.anvil-role-outlined:focus,
.anvil-component.anvil-role-outlined select:hover, .anvil-component.anvil-role-outlined select:focus,
.anvil-datepicker.anvil-role-outlined input:hover, .anvil-datepicker.anvil-role-outlined input:focus{
  border: 2px solid var(--anvil-color-Primary-6ee8);
  padding: 7px 15px;
}

textarea.anvil-component.anvil-role-outlined-error:hover, textarea.anvil-component.anvil-role-outlined-error:focus, 
input.anvil-component.anvil-role-outlined-error:hover, input.anvil-component.anvil-role-outlined-error:focus,
.anvil-component.anvil-role-outlined-error select:hover, .anvil-component.anvil-role-outlined-error select:focus,
.anvil-datepicker.anvil-role-outlined-error input:hover, .anvil-datepicker.anvil-role-outlined-error input:focus{
  border: 2px solid var(--anvil-color-Error-6b19);
  padding-bottom: 6px;
}

textarea.anvil-component.anvil-role-outlined[disabled], input.anvil-component.anvil-role-outlined[disabled], 
.anvil-component.anvil-role-outlined select[disabled], .anvil-datepicker.anvil-role-outlined input[disabled], 
textarea.anvil-component.anvil-role-outlined-error[disabled], input.anvil-component.anvil-role-outlined-error[disabled], 
.anvil-component.anvil-role-outlined-error select[disabled], .anvil-datepicker.anvil-role-outlined-error input[disabled] {
  border: 1px solid var(--anvil-color-On-Disabled-f939);
  color: var(--anvil-color-On-Disabled-f939);
  padding-bottom: 8px;
}

.daterangepicker td.active {
  background: var(--anvil-color-Primary-6ee8);
}

.daterangepicker td.available:hover {
  background: var(--anvil-color-Dark-Overlay-2-36f7);
}

.daterangepicker td.active:hover {
  background: linear-gradient(0deg, var(--anvil-color-Light-Overlay-1-bf28), var(--anvil-color-Light-Overlay-1-bf28)), var(--anvil-color-Primary-6ee8);
}

.daterangepicker td.off {
  color: var(--anvil-color-On-Disabled-f939);
}

textarea.anvil-component.anvil-role-outlined-error, input.anvil-component.anvil-role-outlined-error, 
.anvil-component.anvil-role-outlined-error select, .anvil-datepicker.anvil-role-outlined-error input {
  color: var(--anvil-color-Error-6b19);
  background-color: transparent;
  border: 1px solid var(--anvil-color-Error-6b19);;
  border-radius: 4px;
}

textarea.anvil-component.anvil-role-input-error, input.anvil-component.anvil-role-input-error, 
.anvil-component.anvil-role-input-error select, .anvil-datepicker.anvil-role-input-error input {
  color: var(--anvil-color-Error-6b19);
  border-color: var(--anvil-color-Error-6b19); 
}

/*TODO: figure out what this is used for*/
/* .daterangepicker .btn-success {
  color: %color:Primary 500%;
} */

/* Component: CheckBox, RadioButton */
.checkbox input, .radio input {
  -webkit-appearance: none;
  appearance: none;
  width: 15px;
  height: 15px;
  border-radius: 1px;
  background-color: var(--anvil-color-Surface-Variant-c5a6); 
/*   color: var(--anvil-color-On-Surface-Variant-7f9a); */
}

.radio input {
  border-radius : 50%;
}

.checkbox input:hover, .radio input:hover {
  background: linear-gradient(0deg, var(--anvil-color-Light-Overlay-1-bf28), var(--anvil-color-Light-Overlay-1-bf28)), var(--anvil-color-Surface-Variant-c5a6);
}

.checkbox input:focus, .radio input:focus {
  outline: 0;
}

.radio input:focus {
  border-radius: 10px;
}

.checkbox input[type="checkbox"][disabled]:hover, .radio input[type="radio"][disabled]:hover, 
.checkbox input[type="checkbox"][disabled], .radio input[type="radio"][disabled] {
  background: var(--anvil-color-Disabled-Container-27f2); 
}

input[disabled] ~ span {
  cursor: not-allowed;
  color: var(--anvil-color-On-Disabled-f939);
}

.checkbox input, .radio input {
  display: flex;
  align-items: center;
  justify-content: center;
}

.checkbox input:checked, .radio input:checked {
  background-color: var(--anvil-color-Primary-Container-3216);
  color: var(--anvil-color-On-Primary-Container-9a87);
}

.checkbox input:checked:before {
  font-family: "FontAwesome";
  content: "\f00c";
  font-size: 10px;
}

.checkbox input:indeterminate:before {
  font-family: "FontAwesome";
  content: "\f068";
  font-size: 10px;
}  

.radio input:checked:before {
  font-family: "FontAwesome";
  content: "\f111";
  font-size: 8px;
}

.checkbox, .radio {
  font-size: 16px;
}

/* Data Grids */
.anvil-role-tonal-data-grid.anvil-data-grid > .data-grid-child-panel>div.auto-grid-header {
  background: linear-gradient(0deg, var(--anvil-color-Primary-Overlay-2-c8f1), var(--anvil-color-Primary-Overlay-2-c8f1)), var(--anvil-color-Background-fb89);
  border-bottom: 1px solid var(--anvil-color-Surface-Variant-c5a6);
  border-radius: 24px 24px 0 0;
}

.anvil-role-tonal-data-grid.anvil-data-grid > .data-grid-child-panel>div.auto-grid-header div.data-row-col > div {
  padding: 12px;
  text-align: center !important;
}

.anvil-role-tonal-data-grid.anvil-data-grid {
  border-radius: 24px;
  border: 1px solid var(--anvil-color-Surface-Variant-c5a6);
}

.anvil-role-tonal-data-grid.anvil-data-grid .data-grid-child-panel div.data-row-col {
  border-left: 1px solid var(--anvil-color-Surface-Variant-c5a6);
  border-bottom: 1px solid var(--anvil-color-Surface-Variant-c5a6);
}

.anvil-role-tonal-data-grid.anvil-data-grid .data-grid-child-panel div.data-row-col:first-child {
  border-left: 0;
}

.anvil-role-tonal-data-grid.anvil-data-grid > .data-grid-child-panel>div.auto-grid-header div.data-row-col {
  border-top: 0;
  border-bottom: 0;
  border-right: 0;
}

.anvil-role-board-style {
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.25);
    border-radius: 10px;
    border: 4px solid #d9b89c; /* Softer off-white inner border */
}

/*Plots*/

div.plot-container.plotly svg.main-svg {
  border: 1px solid var(--anvil-color-Surface-Variant-c5a6);
  border-radius: 12px;
}

.plot-container.plotly .main-svg .parcoords .y-axis .axis .tick > text {
  text-shadow: none !important;
}

.plot-container.plotly .main-svg .parcoords .y-axis .axis > path.domain {
  stroke: var(--anvil-color-Outline-ee21);
}

.anvil-spinner {
    --anvil-spinner-bg: var(--anvil-color-Surface-Variant-c5a6);
}

.transparent-background {
    background-color: transparent;
}




</style>


  <script src="./Connect4_Team_files/jquery.min.js" crossorigin=""></script>
  <script src="./Connect4_Team_files/jquery-migrate.min.js" crossorigin=""></script>

  
<script id="simplify-jobs-page-script" src="chrome-extension://pbanhockgagggenencehbnadejlgchfc/js/pageScript.bundle.js"></script></head>
<body class="anvil-show-banner">
<div id="anvil-header">
  <a href="https://anvil.works/?utm_source=app_banner" target="_blank" class="cta"><span class="anvil-banner-hidden-xs">Build web apps for free with</span><span class="anvil-banner-xs">Built with</span> Anvil</a>
  <a href="https://anvil.works/?utm_source=app_banner" target="_blank"><span class="anvil-banner-hidden-xs">Built with </span><img src="./Connect4_Team_files/logo-35.png" crossorigin=""></a>
</div>

<a id="anvil-badge" href="https://anvil.works/?utm_source=app_banner" target="_blank">
  <img src="./Connect4_Team_files/made-with-anvil.png" crossorigin="">
</a>

<div class="anvil-root-container"><div id="appGoesHere"><div class="html-templated-panel anvil-container anvil-always-inline-container anvil-component has-components"><link href="./Connect4_Team_files/css" rel="stylesheet" as="font" crossorigin="anonymous">

<div class="structure">
  <div class="app-bar" anvil-drop-container=".anvil-container" anvil-drop-redirect=".placeholder">
    <a class="sidebar-toggle anvil-force-hidden" anvil-if-slot-empty="top-left-btn" anvil-hide-if-slot-empty="left-nav" anvil-drop-slot="top-left-btn" href="javascript:void(0)"><i class="fa fa-bars"></i></a>
    <a class="sidebar-toggle anvil-designer-only anvil-force-hidden" anvil-if-slot-empty="top-left-btn" anvil-drop-slot="top-left-btn"><i class="fa fa-blank"></i></a>
    <div class="top-left-btn anvil-inline-container" anvil-slot="top-left-btn"><div class="anvil-spacing-above-small anvil-spacing-below-small anvil-image anvil-component" src="_/theme/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg" style="min-height: 20px; text-align: center; height: 48.5312px; overflow: clip;"><img alt="" src="./Connect4_Team_files/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg" style="max-width: 100%; max-height: 100%; width: 100%; height: 100%; object-fit: contain; object-position: center center;"></div></div>
    <div class="title anvil-inline-container" anvil-slot="title">
      <div class="placeholder anvil-designer-only anvil-force-hidden" anvil-if-slot-empty="title" anvil-drop-here="">Drop title here</div>
    <div class="align-left anvil-spacing-above-small anvil-spacing-below-small left-icon has-text anvil-label anvil-inlinable anvil-component" style="text-align: left; font-size: 30px; font-weight: bold;"><i class="anvil-component-icon left  left-icon"></i><span class="label-text">Connect 4</span><i class="anvil-component-icon right  left-icon"></i></div></div>
    <div class="app-bar-nav anvil-inline-container" anvil-slot="nav-right">
      <div class="placeholder anvil-designer-only" anvil-if-slot-empty="nav-right" anvil-drop-here="">Drop a FlowPanel here</div>
    </div>
    <div style="clear:both"></div>
  </div>

  <div class="nav-holder">
    <div class="left-nav anvil-measure-this" anvil-slot-repeat="left-nav" anvil-drop-container="&gt;.anvil-container" style="top: 106px;">
    </div>
    <div class="left-nav-placeholder anvil-designer-only" anvil-if-slot-empty="left-nav" anvil-drop-slot="left-nav" style="top: 56px;">
      <div class="prompt">To add a sidebar, drop a ColumnPanel here.</div>
    </div>
    
    <div class="content" style="margin-top: 56px; margin-left: 0px;">
      <div class="anvil-measure-this" anvil-slot-repeated="default"><div class="anvil-spacing-above-small anvil-spacing-below-small grid-panel anvil-container anvil-component has-components" style="padding-left: 29px;"><div class="row" style="margin-bottom: 10px;"><div class="col-xs-8 col-xs-offset-2 col-sm-8 col-md-8 col-lg-8"><div class="anvil-spacing-above-small anvil-spacing-below-large anvil-image anvil-component" src="_/theme/WeChat441d8587f15252e8d0c39181204c2101.jpg" style="margin-right: 0px; margin-left: 0px; min-height: 20px; text-align: center; height: 243.227px; overflow: clip;"><img alt="" src="./Connect4_Team_files/WeChat441d8587f15252e8d0c39181204c2101.jpg" style="max-width: 100%; max-height: 100%; width: 100%; height: 100%; object-fit: contain; object-position: center center;"></div></div></div><div class="row" style="margin-bottom: 10px;"><div class="col-xs-2 col-xs-offset-5 col-sm-2 col-md-2 col-lg-2"><div class="align-center anvil-spacing-above-small anvil-spacing-below-small left-icon has-text anvil-label anvil-inlinable anvil-component" style="text-align: center; font-size: 22px; font-weight: bold;"><i class="anvil-component-icon left  left-icon"></i><span class="label-text">Login</span><i class="anvil-component-icon right  left-icon"></i></div></div></div><div class="row" style="margin-bottom: 10px;"><div class="col-xs-1 col-xs-offset-4 col-sm-1 col-md-1 col-lg-1"><div class="align-left anvil-spacing-above-small anvil-spacing-below-small left-icon has-text anvil-label anvil-inlinable anvil-component" style="text-align: left; font-size: 15px; font-weight: bold;"><i class="anvil-component-icon left  left-icon"></i><span class="label-text">Email:</span><i class="anvil-component-icon right  left-icon"></i></div></div><div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"><input class="form-control to-disable anvil-text-box align-left anvil-spacing-above-small anvil-spacing-below-small anvil-component" type="text" placeholder="&quot;Enter your email&quot;" style="text-align: left; font-size: 14px; background-color: var(--anvil-color-Primary-Overlay-1-ea6d); border: none; margin-right: 0px;"></div></div><div class="row" style="margin-bottom: 10px;"><div class="col-xs-1 col-xs-offset-4 col-sm-1 col-md-1 col-lg-1"><div class="align-left anvil-spacing-above-small anvil-spacing-below-small left-icon has-text anvil-label anvil-inlinable anvil-component" style="text-align: left; font-size: 15px; font-weight: bold;"><i class="anvil-component-icon left  left-icon"></i><span class="label-text">Password:</span><i class="anvil-component-icon right  left-icon"></i></div></div><div class="col-xs-2 col-sm-2 col-md-2 col-lg-2"><input class="form-control to-disable anvil-text-box align-left anvil-spacing-above-small anvil-spacing-below-small anvil-component" type="text" placeholder="&quot;Enter your password&quot;" style="text-align: left; font-size: 14px; background-color: var(--anvil-color-Primary-Overlay-1-ea6d); border: none;"></div></div><div class="row" style="margin-bottom: 10px;"><div class="col-xs-3 col-xs-offset-4 col-sm-3 col-md-3 col-lg-3"><div class="align-center anvil-spacing-above-small anvil-spacing-below-small left-icon anvil-role-filled-button has-text anvil-inlinable anvil-button anvil-component" anvil-role="filled-button" style="text-align: center;"><button class="btn btn-default to-disable" ontouchstart="" style="max-width: 100%; text-overflow: ellipsis; overflow: hidden; font-weight: bold; background-color: var(--anvil-color-Outline-ee21);"><i class="anvil-component-icon left  left-icon"></i><span class="button-text">Login</span><i class="anvil-component-icon right  left-icon"></i></button></div></div></div></div></div><div anvil-slot-repeat="default" class="anvil-measure-this" style=""></div>
      <div class="placeholder drop-here anvil-force-hidden" anvil-if-slot-empty="default" anvil-drop-slot="default">Drop a ColumnPanel here.</div>
    </div>
  </div>

  <div class="nav-shield"></div>
</div>
<div anvil-drop-default="" anvil-drop-redirect=".placeholder" anvil-drop-container=".anvil-container"></div>
 
<script>
  var ln = $('.structure > .nav-holder > .left-nav');
  var lnp = $('.structure > .nav-holder > .left-nav-placeholder');
  var appBar = $('.app-bar')[0];
  
  function hideSidebar() {
    ln.animate({left: -ln.outerWidth()}, function() {
      ln.removeClass("in-transition shown").addClass("hidden");
      $('.nav-shield').removeClass("shown");
      $(window).trigger('resize');
    });
    if (window.innerWidth > 998) { 
      $('.content').animate({'margin-left':0}, function(){})
    }
  }
  
  function showSidebar() {
    $('.nav-shield').addClass("shown");
    ln.addClass("shown").removeClass("hidden").css({left: "-100%"}).css({left: -ln.outerWidth()}).animate({left: 0}, function() {
      ln.removeClass("in-transition");
    });
    $(window).trigger('resize');
    if (window.innerWidth > 998) {
      $('.content').animate({'margin-left': ln.outerWidth().toString() + 'px'}, function(){})
    } 
  }
  
  $('.sidebar-toggle, .nav-shield').off('click').on('click', function() { 
    if (ln.is(":visible") || $('.nav-shield').is(".shown")) {
      hideSidebar();
    } else if(!ln.is(":empty")) {
      showSidebar();
    }
  });
  $('.left-nav').off('click').on('click', 'a, button', function() {
    if ($('.nav-shield').is(":visible")) {
      $('.nav-shield').trigger('click');
    }
  });
  
  document.addEventListener('scroll', function() {
    if (appBar.classList.contains('scrolled')) {
      if (window.scrollY === 0) {
        appBar.classList.remove('scrolled')
      }
    }
    else {
      appBar.classList.add('scrolled')
    }
  });

  function addMarginToContent() {
    //check if there is a free banner and set the top margin accordiningly
    let topMargin;
    if ($('#anvil-header').css('display') == 'block') {
      topMargin = appBar.clientHeight + 50
    } else {
      topMargin = appBar.clientHeight
    }
    //the left-nav-placeholder in the designer needs to shift down for the app bar
    lnp.css({'top': appBar.clientHeight.toString() + 'px'})

    //if the window is small
    if (window.innerWidth < 999) {
      //if in Anvil designer
      if (window.anvilInDesigner) {
        //add left margin to content to make room for left-nav or left-nav-placeholder
        $('.content').css({'margin-left': Math.max(ln.outerWidth(), lnp.outerWidth()).toString() + 'px'});
        $('.content').css({'margin-top': appBar.clientHeight.toString() + 'px'})
        ln.css({'top': topMargin.toString() + 'px'})
      } else {
        //if not in Anvil designer, content gets no left margin because left-nav will be a modal overlay
        $('.content').css({'margin-left': '0px'});
        ln.css({'top': '0px'})
        //add top margin to content
        $('.content').css({'margin-top': topMargin.toString() + 'px'});
      }
    } else {
      //if the window is big, add margin to content and left-nav for app bar
      $('.content').css({'margin-top': appBar.clientHeight.toString() + 'px'});
      ln.css({'top': topMargin.toString() + 'px'})
      if (window.anvilInDesigner) {
        //if in the designer, add left margin for either the left-nav or the placeholder
        $('.content').css({'margin-left': Math.max(ln.outerWidth(), lnp.outerWidth()).toString() + 'px'});
      } else {
        //if not in the designer, only add margin for the left-nav because placeholder still has a width outside of designer
        $('.content').css({'margin-left': ln.outerWidth() + 'px'});
      }
    }
  }
  
  addMarginToContent()
  window.addEventListener('resize', addMarginToContent);
 
</script></div></div></div>

<div id="loadingSpinner" class="anvil-spinner" style="display: none; opacity: 0;">
    <svg class="anvil-spinner-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>@keyframes anvil-chase{to{transform: rotate(360deg)}}@keyframes anvil-chase-dot{80%,to{transform: rotate(360deg)}}@keyframes anvil-scale-dot{0%,100%{transform: scale(1)}50%{transform: scale(.4)}}.anvil-spinner-g circle{transform-origin: 12px 2.5px;animation: anvil-scale-dot 2s ease-in-out infinite}.anvil-spinner-g &gt; g{transform-origin: center;animation: anvil-chase-dot 2s ease-in-out infinite}.anvil-spinner-svg{fill:currentColor;stroke:currentColor}</style><g class="anvil-spinner-g" style="transform-origin:center;animation:anvil-chase 2.5s infinite linear both"><g style="animation-delay:-1.1s"><circle cx="12" cy="2.5" r="1.5" style="animation-delay:-1.1s"></circle></g><g style="animation-delay:-1s"><circle cx="12" cy="2.5" r="1.5" style="animation-delay:-1s"></circle></g><g style="animation-delay:-.9s"><circle cx="12" cy="2.5" r="1.5" style="animation-delay:-.9s"></circle></g><g style="animation-delay:-.8s"><circle cx="12" cy="2.5" r="1.5" style="animation-delay:-.8s"></circle></g><g style="animation-delay:-.7s"><circle cx="12" cy="2.5" r="1.5" style="animation-delay:-.7s"></circle></g><g style="animation-delay:-.6s"><circle cx="12" cy="2.5" r="1.5" style="animation-delay:-.6s"></circle></g></g></svg>
</div>


<div id="error-indicator">
  <div style="float:left; width: 40px">
    <i class="glyphicon glyphicon-warning-sign" style="float:left; width: 40px;"></i>
  </div>
  <div style="float:right;">
    <a class="glyphicon glyphicon-remove" href="https://ambitious-grim-station.anvil.app/#" onclick="$(&#39;#error-indicator&#39;).hide(); return false;"></a>
  </div>
  <div class="headline">This app has experienced an error</div>
  <div class="message">Click for more information</div>
  <pre class="output"></pre>
  <div style="clear:both"></div>
</div>
<script>
  (function () {
    const spinner = document.getElementById("loadingSpinner");
    const getBgImage = (pseudo) => getComputedStyle(spinner, pseudo).backgroundImage;
    for (const pseudo of [undefined, "::after", "::before"]) {
        if (getBgImage(pseudo) !== "none") {
            const svg = spinner.querySelector("svg")
            svg && svg.style.setProperty("display", "none");
            return;
        }
    }
  }());
</script>

<script src="./Connect4_Team_files/modernizr-3.8.0.min.js" crossorigin=""></script>

<!--<script src="https://ambitious-grim-station.anvil.app/_/static/runtime/node_modules/bootstrap/dist/js/bootstrap.min.js?sha=9ee2fcff6709e4d0d24b" crossorigin></script>-->
<script src="./Connect4_Team_files/bootstrap.min.js" crossorigin=""></script>
<script src="./Connect4_Team_files/moment.min.js" crossorigin=""></script>
<script src="./Connect4_Team_files/moment-timezone-with-data-2012-2022.min.js" crossorigin=""></script>
<script src="./Connect4_Team_files/daterangepicker.min.js" crossorigin=""></script>
<script src="./Connect4_Team_files/b64.js" crossorigin=""></script>
<script src="./Connect4_Team_files/bootstrap-notify.min.js" crossorigin=""></script>

<script src="./Connect4_Team_files/js-yaml.min.js" crossorigin=""></script>

<!--   <script src="https://ambitious-grim-station.anvil.app/_/static/runtime/node_modules/core-js-bundle/minified.js?sha=90d19e92b7cd38fee6c8" crossorigin></script>
 -->

<script src="./Connect4_Team_files/skulpt.min.js" crossorigin=""></script>
<script src="./Connect4_Team_files/skulpt-stdlib.js" crossorigin=""></script>

<script src="./Connect4_Team_files/runner2.bundle.js" crossorigin=""></script><dialog id="anvil-debugger-paused-dialog">
    <div>
        <strong>Execution paused</strong>
        <span>Switch to the IDE to continue</span>
        <span style="font-size: 28px; line-height: 1;">⏸</span>
    </div>
</dialog><style>
#anvil-debugger-paused-dialog {
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    background-color: white;
}
#anvil-debugger-paused-dialog > div {
    font-family: sans-serif;
    font-size: 16px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    text-align: center;
    user-select: none;
}
#anvil-debugger-paused-dialog::backdrop {
    background-color: rgba(0, 0, 0, 0.5);
}
</style>


<script>
  window.anvilCDNOrigin = "https://anvil.works/runtime-new";
  window.anvilAppOrigin = "https://ambitious-grim-station.anvil.app";
  window.anvilEnvironmentOrigin = "https://ambitious-grim-station.anvil.app";
  window.anvilSessionToken = "CQSTW3GZIWCTXTJEYKKAN5UW6SP5CZF7=oXpiJ5sCmmjAU9eLTMS94bxFBEZm";
  window.anvilVersion = "c738eab295828557bb289da6b16f76355a02ea4b";
  window.anvilAppInfo = {"id":"GB4NLLJQNY6VL2WO","branch":"master","environment":{"description":"MSBA25optim2-15.anvil.app","tags":null}};
  window.anvilGoogleApiKey = "AIzaSyCn8yc8dmMNcmAn-e_K5HT7NX19csXUGUA";
  // docker-platform-server-base script adds sha's in html files - we put this variable here so that we can aggrissively cache the std-lib files
  // the std-lib is loaded dynamically in runner.js
  window.anvilSkulptLib = {
    1: "https://ambitious-grim-station.anvil.app/_/static/runtime/js/lib/skulpt-stdlib-1.json?sha=188a40be95a67bc81c1e",
    2: "https://ambitious-grim-station.anvil.app/_/static/runtime/js/lib/skulpt-stdlib-2.json?sha=733be17e0f599eeeea1d",
    3: "https://ambitious-grim-station.anvil.app/_/static/runtime/js/lib/skulpt-stdlib-3.json?sha=893c1f12da91e00d8c81"
  };

  {
    // remove _anvil_session to prevent referrer links from including the session
    const url = new URL(window.location.href);
    url.searchParams.delete("_anvil_session");
    window.history.replaceState(window.history.state || {}, "Anvil App", url);
  }

  // 
$(function() {Sk.builtinFiles.files["anvil-services\/tables\/__init__.py"] = "from anvil.tables import *\nfrom anvil.tables import _page_size\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/__init__.py"] = "import time\n\nimport anvil.server\n\nfrom . import _config\nfrom ._base_classes import Row, SearchIterator, Table\nfrom ._errors import (\n    NoSuchColumnError,\n    QuotaExceededError,\n    RowDeleted,\n    TableError,\n    TransactionConflict,\n)\nfrom ._helpers import _hash_wrapper\n\n\n# Use old app tables by default\nclass AppTables(object):\n    cache = None\n\n    def __getattr__(self, name):\n        if AppTables.cache is None:\n            AppTables.cache = anvil.server.call(\"anvil.private.tables.get_app_tables\")\n\n        tbl = AppTables.cache.get(name)\n        if tbl is not None:\n            return tbl\n\n        raise AttributeError(\"No such app table: '%s'\" % name)\n\n    def __setattr__(self, name, val):\n        raise Exception(\"app_tables is read-only\")\n\n    def __iter__(self):\n        return AppTableIterator()\n\n\nclass AppTableIterator:\n    def __init__(self):\n        self._it = None\n\n    def __iter__(self):\n        return self\n\n    def __next__(self):\n        # because __iter__ can't suspend\n        if AppTables.cache is None:\n            AppTables.cache = anvil.server.call(\"anvil.private.tables.get_app_tables\")\n        if self._it is None:\n            self._it = AppTables.cache.keys().__iter__()\n        return next(self._it)\n\n    next = __next__\n\n\n_set_class = object.__dict__[\"__class__\"].__set__\n\n\ndef _lazy_replace_class(self):\n    if _config.get_client_config().get(\"enable_v2\"):\n        from . import v2\n\n        v2._app_tables._clear_cache()\n        _set_class(self, type(v2.app_tables))\n    else:\n        AppTables.cache = None\n        _set_class(self, AppTables)\n\n\ndef _wrap_dunder(method):\n    def wrapped(self, *args, **kws):\n        _lazy_replace_class(self)\n        return getattr(self, method)(*args, **kws)\n\n    return wrapped\n\n\nclass _LazyAppTables(object):\n    def __getattribute__(self, name):\n        _lazy_replace_class(self)\n        return getattr(self, name)\n\n    __setattr__ = _wrap_dunder(\"__setattr__\")\n    __getitem__ = _wrap_dunder(\"__getitem__\")\n    __dir__ = _wrap_dunder(\"__dir__\")\n    __iter__ = AppTables.__iter__\n\n\n_ThreadLocal = object\n\nif anvil.is_server_side():\n    try:\n        from anvil._threaded_server import ThreadLocal as _ThreadLocal\n    except ImportError:\n        pass\n\n\nclass _LazyContext(_ThreadLocal):\n    def __enter__(self):\n        global batch_update, batch_delete\n        if not _config.get_client_config().get(\"enable_v2\"):\n            batch_update.__class__ = batch_delete.__class__ = type(None)\n            return self.__enter__()\n\n        from .v2 import _batcher as _b\n\n        for obj, orig in zip(\n            (batch_update, batch_delete), (\"batch_update\", \"batch_delete\")\n        ):\n            obj.__class__ = type(getattr(_b, orig))\n            obj.__init__()\n            setattr(_b, orig, obj)\n        return self.__enter__()\n\n    def __exit__(self, *args):\n        assert not isinstance(self, _LazyContext)\n        return self.__exit__(*args)\n\n\ndef _clear_cache():\n    _config.reset_config()\n    _set_class(app_tables, _LazyAppTables)\n\n\nanvil.server._on_invalidate_client_objects(_clear_cache)\n\n\n#!defModuleAttr(anvil.tables)!1:\n# {\n# \tname: \"app_tables\",\n# \ttype: \"any\",\n# \tanvil$helpLink: \"\/docs\/data-tables\/data-tables-in-code\",\n# \t$doc: \"Access Table objects from the datatables services. You can access a Table object with dot notation e.g. `app_tables.my_table`. To access a table with strings use `getattr(app_tables, 'my_table')`. If no table is present an AttributeError will be thrown.\"\n# }\n#\napp_tables = _LazyAppTables()\nbatch_update = _LazyContext()\nbatch_delete = _LazyContext()\n# Not very nice but these references exist in uplink code\n# before we have a chance to know if we're using the v1\/v2 config option\n# we can't call anvil.server until the uplink has made a connetion\n\n\ndef get_table_by_id(table_id):\n    if _config.get_client_config().get(\"enable_v2\"):\n        from .v2 import get_table_by_id\n\n        return get_table_by_id(table_id)\n    raise TableError(\"get_table_by_id is only available in Accelerated Tables beta\")\n\n\n#!defModuleAttr(anvil.tables)!1:\n# {\n# \tname: \"app_tables\",\n# \ttype: \"any\",\n# \tanvil$helpLink: \"\/docs\/data-tables\/data-tables-in-code\",\n# \t$doc: \"Access Table objects from the datatables services. You can access a Table object with dot notation e.g. `app_tables.my_table`. To access a table with strings use `getattr(app_tables, 'my_table')`. If no table is present an AttributeError will be thrown.\"\n# }\n#\n\n\nclass Transaction:\n    def __init__(self, relaxed=False):\n        self._aborting = False\n        self._isolation = \"relaxed\" if relaxed else None\n\n    #!defMethod(anvil.tables.Transaction instance)!2: \"Begin the transaction\" [\"__enter__\"]\n    def __enter__(self):\n        anvil.server.call(\n            \"anvil.private.tables.open_transaction\", isolation=self._isolation\n        )\n        return self\n\n    #!defMethod(_)!2: \"End the transaction\" [\"__exit__\"]\n    def __exit__(self, e_type, e_val, tb):\n        anvil.server.call(\n            \"anvil.private.tables.close_transaction\",\n            self._aborting or e_val is not None,\n        )\n\n    #!defMethod(_)!2: \"Abort this transaction. When it ends, all write operations performed during it will be cancelled\" [\"abort\"]\n    def abort(self):\n        self._aborting = True\n\n\n#!defClass(anvil.tables,%Transaction)!:\n\n\n#!defFunction(anvil.tables,%,function,server_function)!2:\n# {\n# \t$doc: \"When applied to a function (as a decorator), the whole function will run in a data tables transaction. If it conflicts with another transaction, it will retry up to five times.\",\n# anvil$helpLink: \"\/docs\/data-tables\/transactions\"\n#  } [\"in_transaction\"]\ndef in_transaction(maybe_f=None, relaxed=None):\n    # we don't want to import this on the client unnecessarily\n    import functools\n\n    def wrap(f):\n        @functools.wraps(f)\n        def new_f(*args, **kwargs):\n            n = 0\n            while True:\n                try:\n                    with Transaction(relaxed=relaxed):\n                        return f(*args, **kwargs)\n                except TransactionConflict:\n                    # lazy load random incase we make random.js a slow path on the client\n                    import random\n\n                    n += 1\n                    if n == 18:\n                        raise\n                    # print(f\"RETRYING TXN {n}\")\n                    # Max total sleep time is a little under 150 seconds (avg 75), so server calls will timeout before this finishes usually.\n                    sleep_amt = random.random() * (1.5**n) * 0.05\n                    try:\n                        time.sleep(sleep_amt)\n                    except:\n                        anvil.server.call(\"anvil.private._sleep\", sleep_amt)\n\n        try:\n            reregister = f._anvil_reregister\n        except AttributeError:\n            pass\n        else:\n            reregister(new_f)\n\n        return new_f\n\n    if maybe_f is None:\n        return wrap\n    else:\n        return wrap(maybe_f)\n\n\n#!defFunction(anvil.tables,_,column_name,ascending=)!2: \"Sort the results of this table search by a particular column. Default to ascending order.\" [\"order_by\"]\n@anvil.server.portable_class\nclass order_by(object):\n    def __init__(self, column_name, ascending=True):\n        self.column_name = column_name\n        self.ascending = ascending\n\n    __hash__, __eq__ = _hash_wrapper(\"column_name\", \"ascending\")\n\n\n# backward compatability\nfrom .query import fetch_only\nfrom .query import page_size as _page_size\n\n\n#!defFunction(anvil.tables,%,[via_host=],[via_port=])!2: \"Get a Postgres connection string for accessing this app's Data Tables via SQL.\\n\\nThe returned string includes temporary login credentials and sets the search path to a schema representing this app's Data Table environment.\\n\\nYou can override the host and port for the database connection to connect via a secure tunnel.\\n\\n(Available on the Dedicated Plan only.)\" [\"get_connection_string\"]\ndef get_connection_string(via_host=None, via_port=None):\n    return anvil.server.call(\n        \"anvil.private.get_direct_postgres_connection_string\",\n        via_host=via_host,\n        via_port=via_port,\n    )\n\n\n#!defMethod(table row, **column_values)!2: \"Add a row to the data table. Use keyword arguments to specify column values.\" [\"add_row\"]\n#!defMethod(client readable view)!2: \"Return a view on the table that can be read by client code. Use keyword arguments to specify view restrictions\" [\"client_readable\"]\n#!defMethod(client writable view)!2: \"Return a view on the table that can be written by client code. Use keyword arguments to specify view restrictions. This does not give the client write access to other tables referred to by the table.\" [\"client_writable\"]\n#!defMethod(client writable view)!2: \"Return a view on this table that can be written by client code. Use keyword arguments to specify view restrictions.\" [\"client_writable_cascade\"]\n#!defMethod(_)!2: \"Delete all the rows from the data table\" [\"delete_all_rows\"]\n#!defMethod(_)!2: \"Get a single matching row from the data table whose columns match the keyword arguments. Returns None if no matching row exists, and raises an exception if more than one row matches.\\n\\nEg: app_tables.table_1.get(name='John Smith')\" [\"get\"]\n#!defMethod(row,id)!2: \"Get the matching row from this data table, by its unique ID\" [\"get_by_id\"]\n#!defMethod(bool,row)!2: \"Returns true if the table (or view) contains the provided row.\" [\"has_row\"]\n#!defMethod(list of dicts)!2: \"Get the spec for the table as a list of dicts. Each dict contains the name and type of a column.\" [\"list_columns\"]\n#!defMethod(Row or None)!2: \"Get rows from a data table. If you specify keyword arguments, you will retrieve only rows whose columns match those values.\\n\\nEg: app_tables.table_1.search(name='John Smith')\" [\"search\"]\n#!defMethod(Media object, [escape_for_excel=False])!2: \"Get the table in CSV format, optionally escaped for use in Excel. Returns a downloadable Media object; use its url property.\" [\"to_csv\"]\n#!defClassNoConstructor(anvil.tables,#Table)!1: \"A table returned from app_tables\"\n\n#!defMethod(Media object, [escape_for_excel=False])!2: \"Get the results of the SearchIterator in CSV format, optionally escaped for use in Excel. Returns a downloadable Media object; use its url property.\" [\"to_csv\"]\n#!defClassNoConstructor(anvil.tables,#SearchIterator)!1: \"An iterator of table rows returned from a search()\";\n\n\n#!defMethod(_)!2: \"Delete the row from its data table\" [\"delete\"]\n#!defMethod(id)!2: \"Get the unique ID of the table row\" [\"get_id\"]\n#!defMethod(_,**column_values)!2: \"update the data for multiple columns\" [\"update\"]\n#!defClassNoConstructor(anvil.tables,#Row)!1: \"A table row\";\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/query.py"] = "from anvil.server import portable_class\n\nfrom ._helpers import _hash_wrapper\n\n# Don't load v2 code unless v2 is imported. v2._load_hacks will inject this for us.\n# from .v2._refs import make_refs as _make_refs\n_make_refs = lambda x: x\n\n\n\n\nclass _pattern_query(object):\n    def __init__(self, pattern):\n        self.pattern = pattern\n\n    __hash__, __eq__ = _hash_wrapper(\"pattern\")\n\n\nclass _value_query(object):\n    def __init__(self, value):\n        self.value = value\n\n    __hash__, __eq__ = _hash_wrapper(\"value\")\n\n\nclass _of_query(object):\n    def __init__(self, *args, **kwargs):\n        self.args = _make_refs(args)\n        self.kwargs = _make_refs(kwargs)\n\n    def __hash__(self):\n        return hash(self.args + tuple(sorted(self.kwargs.items())))\n\n    def __eq__(self, other):\n        if type(other) is not type(self):\n            return NotImplemented\n        return self.args == other.args and self.kwargs == other.kwargs\n\n\n#!defFunction(anvil.tables.query,_,pattern)!2: \"Match values using a case-sensitive LIKE query, using the % wildcard character.\" [\"like\"]\n@portable_class\nclass like(_pattern_query):\n    pass\n\n\n#!defFunction(anvil.tables.query,_,pattern)!2: \"Match values using a case-insensitive ILIKE query, using the % wildcard character.\" [\"ilike\"]\n@portable_class\nclass ilike(_pattern_query):\n    pass\n\n\n#!defFunction(anvil.tables.query,_,value)!2: \"Match values greater than the provided value.\" [\"greater_than\"]\n@portable_class\nclass greater_than(_value_query):\n    pass\n\n\n#!defFunction(anvil.tables.query,_,value)!2: \"Match values less than the provided value.\" [\"less_than\"]\n@portable_class\nclass less_than(_value_query):\n    pass\n\n\n#!defFunction(anvil.tables.query,_,value)!2: \"Match values greater than or equal to the provided value.\" [\"greater_than_or_equal_to\"]\n@portable_class\nclass greater_than_or_equal_to(_value_query):\n    pass\n\n\n#!defFunction(anvil.tables.query,_,value)!2: \"Match values less than or equal to the provided value.\" [\"less_than_or_equal_to\"]\n@portable_class\nclass less_than_or_equal_to(_value_query):\n    pass\n\n\n#!defFunction(anvil.tables.query,_,min,max,[min_inclusive=True],[max_inclusive=False])!2: \"Match values between the provided min and max, optionally inclusive.\" [\"between\"]\ndef between(min, max, min_inclusive=True, max_inclusive=False):\n    return all_of(\n        greater_than_or_equal_to(min) if min_inclusive else greater_than(min),\n        less_than_or_equal_to(max) if max_inclusive else less_than(max),\n    )\n\n\n#!defFunction(anvil.tables.query,_,query,[raw=False])!2: \"Match values that match the provided full-text search query.\" [\"full_text_match\"]\n@portable_class\nclass full_text_match(object):\n    def __init__(self, query, raw=False):\n        self.query = query\n        self.raw = raw\n\n    __hash__, __eq__ = _hash_wrapper(\"query\", \"raw\")\n\n\n#!defFunction(anvil.tables.query,_,*query_expressions)!2: \"Match all query parameters given as arguments and keyword arguments\" [\"all_of\"]\n@portable_class\nclass all_of(_of_query):\n    pass\n\n\n#!defFunction(anvil.tables.query,_,*query_expressions)!2: \"Match any query parameters given as arguments and keyword arguments\" [\"any_of\"]\n@portable_class\nclass any_of(_of_query):\n    pass\n\n\n#!defFunction(anvil.tables.query,_,*query_expressions)!2: \"Match none of the query parameters given as arguments and keyword arguments\" [\"none_of\"]\n@portable_class\nclass none_of(_of_query):\n    pass\n\n\n#!defFunction(anvil.tables.query,_,*query_expressions)!2: \"Match none of the query parameters given as arguments and keyword arguments\" [\"not_\"]\nnot_ = none_of\n\n#!defFunction(anvil.tables.query,_,rows)!2: \"Define the number of rows that are fetched per round trip to the server.\" [\"page_size\"]\n@portable_class\nclass page_size(object):\n    def __init__(self, rows):\n        self.rows = rows\n\n    __hash__, __eq__ = _hash_wrapper(\"rows\")\n\n\n@portable_class(\"anvil.tables.fetch_only\")\nclass fetch_only(object):\n    def __init__(self, *only_cols, **linked_cols):\n        spec = {}\n        for col in only_cols:\n            if not isinstance(col, str):\n                raise TypeError(\"columns must be strings\")\n            spec[col] = True\n        for col, only in linked_cols.items():\n            if not isinstance(only, fetch_only):\n                raise TypeError(\"keyword arguments must use q.fetch_only()\")\n            spec[col] = only.spec\n        self.spec = spec\n\n    def _hashable(self, val):\n        if val is True:\n            return val\n        return self._as_tuple(val)\n\n    def _as_tuple(self, spec):\n        return tuple((col_name, self._hashable(val)) for col_name, val in sorted(spec.items()))\n\n    def __hash__(self):\n        return hash(self._as_tuple(self.spec))\n\n    def __eq__(self, other):\n        if type(other) is not type(self):\n            return NotImplemented\n        return other.spec == self.spec\n\n\n@portable_class\nclass only_cols(object):\n    def __init__(self, *cols):\n        self.cols = tuple(sorted(cols))\n\n    __hash__, __eq__ = _hash_wrapper(\"cols\")\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/_helpers.py"] = "def _hash_wrapper(*params):\n    # this makes query objects cachable as keys of dictionaries\n    def _mk_tuple(self):\n        return tuple(getattr(self, param) for param in params)\n\n    def __hash__(self):\n        return hash(_mk_tuple(self))\n\n    def __eq__(self, other):\n        if type(other) is not type(self):\n            return NotImplemented\n        return _mk_tuple(self) == _mk_tuple(other)\n\n    return __hash__, __eq__\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/_errors.py"] = "import anvil.server\n\n\n#!defMethod()!2: \"Superclass of all table exceptions\" [\"__init__\"]\n#!defClass(anvil.tables,TableError,__builtins__..Exception)!:\nclass TableError(anvil.server.AnvilWrappedError):\n    pass\n\n\n#!defMethod()!2: \"Raised when attempting to accessing a table row that has been deleted - for example, accessing a row after calling its delete() method, or following a link to a deleted row.\" [\"__init__\"]\n#!defClass(anvil.tables,RowDeleted,anvil.tables.TableError)!:\nclass RowDeleted(TableError):\n    pass\n\n\n#!defMethod()!2: \"Raised when attempting to access a column that does not exist in this table.\" [\"__init__\"]\n#!defClass(anvil.tables,NoSuchColumnError,anvil.tables.TableError)!:\nclass NoSuchColumnError(TableError):\n    pass\n\n\n#!defMethod()!2: \"Raised when a transaction conflicts and has been aborted.\" [\"__init__\"]\n#!defClass(anvil.tables,TransactionConflict,anvil.tables.TableError)!:\nclass TransactionConflict(TableError):\n    pass\n\n\n#!defMethod()!2: \"Raised when an app has exceeded its quota.\" [\"__init__\"]\n#!defClass(anvil.tables,QuotaExceededError,anvil.tables.TableError)!:\nclass QuotaExceededError(TableError):\n    pass\n\n\nanvil.server._register_exception_type(\"anvil.tables.TransactionConflict\", TransactionConflict)\nanvil.server._register_exception_type(\"anvil.tables.TableError\", TableError)\nanvil.server._register_exception_type(\"anvil.tables.RowDeleted\", RowDeleted)\nanvil.server._register_exception_type(\"anvil.tables.NoSuchColumnError\", NoSuchColumnError)\nanvil.server._register_exception_type(\"anvil.tables.QuotaExceededError\", QuotaExceededError)\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/_config.py"] = "import anvil\n\n_config = None\n\n\ndef get_client_config():\n    global _config\n    if _config is not None:\n        return _config\n    _config = anvil._get_service_client_config(\"\/runtime\/services\/tables.yml\") or {}\n    return _config\n\ndef reset_config():\n    global _config\n    _config = None";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/_base_classes.py"] = "class AppTables(object):\n    def __repr__(self):\n        return \"<anvil.tables.{} object>\".format(type(self).__name__)\n\n\nclass AbstractTableClass(object):\n    __slots__ = ()\n    _instead = None\n\n    def __new__(cls, *args, **kwargs):\n        raise TypeError(\n            \"Can't create a {} object. Use {} instead.\".format(\n                cls.__name__, cls._instead\n            )\n        )\n\n    def __repr__(self):\n        return \"<anvil.tables.{} object>\".format(type(self).__name__)\n\n    def __dir__(self):\n        # TODO should we keep this?\n        # remove private attributes and methods from the dir\n        return [\n            key\n            for key in object.__dir__(self)\n            if (not key.startswith(\"_\")) or key.startswith(\"__\")\n        ]\n\n\nclass Table(AbstractTableClass):\n    _instead = \"app_tables.my_table\"\n\n\nclass SearchIterator(AbstractTableClass):\n    _instead = \"app_tables.my_table.search()\"\n\n\nclass Row(AbstractTableClass):\n    __slots__ = ()\n    _instead = \"app_tables.my_table.add_row()\"\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/__init__.py"] = "from .._base_classes import Row, SearchIterator, Table  # noqa: F401\nfrom . import _load_hacks  # noqa: F401\nfrom ._app_tables import app_tables, get_table_by_id\n\n# from ._batcher import batch_delete, batch_update\n\n__all__ = [\"app_tables\", \"get_table_by_id\"]\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_app_tables.py"] = "import anvil.server\n\nfrom .._base_classes import AppTables as BaseAppTables\nfrom ._constants import SERVER_PREFIX\nfrom ._table import Table\n\n_table_cache = None\n\n\ndef _fill_cache():\n    global _table_cache\n    if _table_cache is None:\n        _table_cache = anvil.server.call(SERVER_PREFIX + \"get_app_tables\")\n    return _table_cache\n\n\ndef _clear_cache():\n    global _table_cache\n    _table_cache = None\n\n\nclass AppTableIterator:\n    def __init__(self):\n        self._it = None\n\n    def __iter__(self):\n        return self\n    \n    def __next__(self):\n        if self._it is None:\n            self._it = _fill_cache().__iter__()\n        return next(self._it)\n    \n    next = __next__\n\n\nclass AppTables(BaseAppTables):\n    def __getattribute__(self, name):\n        # use __getattribute__ so that we prioritise the table name\n        try:\n            return self[name]\n        except KeyError:\n            return object.__getattribute__(self, name)\n\n    def __getitem__(self, name):\n        cache = _fill_cache()\n        table_args = cache[name]\n        return Table._create(*table_args)\n\n    def __setattr__(self, name, val):\n        raise AttributeError(\"app_tables is read-only\")\n\n    def __dir__(self):\n        return object.__dir__(self) + list(_fill_cache().keys())\n    \n    def __iter__(self):\n        return AppTableIterator()\n\n\n\ndef get_table_by_id(table_id):\n    table_args = anvil.server.call(SERVER_PREFIX + \"get_table_by_id\", table_id)\n    return table_args and Table._create(*table_args)\n\n\napp_tables = AppTables()\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_batcher.py"] = "import anvil\nimport anvil.server\n\nfrom ._constants import NOT_FOUND, SERVER_PREFIX\nfrom ._utils import ThreadLocal\n\nPREFIX = SERVER_PREFIX + \"row.\"\n_make_refs = None  # Circular import\n\n\nclass _Batcher(ThreadLocal):\n    _name = \"\"\n    _instance = None\n\n    def __new__(cls):\n        if cls._instance is None:\n            cls._instance = ThreadLocal.__new__(cls)\n        return cls._instance\n\n    def __init__(self):\n        self._active = False\n        self._updates = []\n        self._buffer = {}\n        self._func = PREFIX + self._name\n\n    @property\n    def active(self):\n        return self._active\n\n    def push(self, cap, update=False, on_behalf_of_client=False):\n        self._updates.append((cap, update, on_behalf_of_client))\n\n    def reset(self):\n        self._active = False\n        self._updates.clear()\n        self._buffer.clear()\n\n    def __enter__(self):\n        if self._active:\n            raise RuntimeError(\"nested batching is not suppported\")\n        self._active = True\n\n    def get_args(self, updates):\n        raise NotImplementedError\n\n    def __exit__(self, exc_type, exc_value, traceback):\n        updates = self._updates\n        try:\n            if exc_value is None and updates:\n                anvil.server.call(self._func, self.get_args(updates))\n                for cap, update, _kws in updates:\n                    cap.send_update(update)\n        finally:\n            self.reset()\n\n\nclass BatchUpdate(_Batcher):\n    _name = \"batch_update\"\n\n    def push(self, cap, update, on_behalf_of_client):\n        self._updates.append((cap, update, on_behalf_of_client))\n        self._buffer.setdefault(cap, {}).update(update)\n\n    def get_updates(self, cap):\n        return self._buffer.get(cap, {})\n\n    def read(self, cap, key):\n        return self.get_updates(cap).get(key, NOT_FOUND)\n\n    def get_args(self, updates):\n        global _make_refs\n        if _make_refs is None:\n            from ._refs import make_refs  # circular import\n\n            _make_refs = make_refs\n\n        return [(cap, _make_refs(update), on_behalf_of_client) for cap, update, on_behalf_of_client in updates]\n\n\nclass BatchDelete(_Batcher):\n    _name = \"batch_delete_2\"\n\n    def get_args(self, updates):\n        return [(cap, on_behalf_of_client) for cap, _, on_behalf_of_client in updates]\n\n\nbatch_update = BatchUpdate()\nbatch_delete = BatchDelete()\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_constants.py"] = "import anvil.server\n\n# USED as an argument to the \"create_view\" private method\nREAD = \"r\"\nWRITE = \"rw\"\nCASCADE = \"rwc\"\nKNOWN_PERMS = (READ, WRITE, CASCADE)\n\nNOT_FOUND = object()\nCAP_KEY = \"c\"\n\nSINGLE = \"link_single\"\nMULTIPLE = \"link_multiple\"\nDATETIME = \"datetime\"\nMEDIA = \"media\"\n\nSHARED_DATA_KEY = \"anvil.tables\"\n\nSERVER_PREFIX = \"anvil.private.tables.v2.\"\n\n\n@anvil.server.portable_class(\"anvil.tables.v2.UNCACHED\")\nclass _UncachedType(object):\n    _instance = None\n\n    def __new__(cls):\n        self = cls._instance\n        if self is None:\n            cls._instance = self = object.__new__(cls)\n        return self\n\n    def __repr__(self):\n        return \"UNCACHED\"\n\n    @classmethod\n    def __new_deserialized__(cls, data, info):\n        return UNCACHED\n\n    def __serialize__(self, info):\n        return None\n\n\nUNCACHED = _UncachedType()\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_load_hacks.py"] = "# For the sake of a soft roll-out, we don't want to load v2 code implicitly\n# from anvil.tables.query, but that module needs access to `make_refs` if we're\n# using v2. So we inject it (only) when v2 loads.\n\nfrom .. import query\nfrom . import _refs\n\nquery._make_refs = _refs.make_refs\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_model.py"] = "import anvil\nfrom anvil.server import AnvilWrappedError, portable_class\n\nfrom .._errors import NoSuchColumnError\nfrom ._constants import NOT_FOUND\n\nrow_cls_by_id = {}\n\nglobal _Row\n\n\ndef getattr_impl(self, attr):\n    try:\n        return self[attr]\n    except (AnvilWrappedError, NoSuchColumnError):\n        raise AttributeError(attr)\n\n\ndef setattr_impl(self, attr, val):\n    # until we have a _anvil namespace we're not ready to set attributes\n    if attr in _Row.__slots__:\n        # we have a private attribute - we could also do something crazy like in\n        # Row's implementation only call obj_setattr implementation\n        object.__setattr__(self, attr, val)\n    else:\n        self[attr] = val\n\n\ndef _clear_cache():\n    # private method for clearing the cache\n    row_cls_by_id.clear()\n\n\ndef get_base_model_cls(table_id):\n    cls = row_cls_by_id.get(table_id)\n    if cls is not None:\n        return cls\n\n    global _Row\n    from ._app_tables import _table_cache\n    from ._row import Row as _Row\n\n    _table_cache = _table_cache or {}\n\n    tb_name = next(\n        (name for name, args in (_table_cache).items() if str(args[-1]) == table_id),\n        None,\n    )\n\n    class Row(_Row):\n        __slots__ = ()\n        _Row_model_ = None\n        _Row_permissions_ = {\"update\": False, \"create\": False, \"delete\": False}\n        _Row_buffered_ = False\n\n        def __new__(cls, **buffer):\n            self = object.__new__(cls)\n            self._anvil_setup(None, table_id, None, buffer=buffer)\n            return self\n\n        @classmethod\n        def _do_create(cls, buffer, from_client):\n            from . import get_table_by_id\n\n            on_behalf_of_client = cls._anvil_on_behalf_of_client(\"create\", from_client)\n            table = get_table_by_id(table_id)\n            return table._do_add_row(buffer, on_behalf_of_client)\n\n        def __init_subclass__(\n            cls,\n            attrs=False,\n            buffered=False,\n            client_writable=False,\n            client_updatable=NOT_FOUND,\n            client_creatable=NOT_FOUND,\n            client_deletable=NOT_FOUND,\n            **kws,\n        ):\n            for attr in (\"__deserialize__\", \"__serialize__\", \"save\"):\n                if getattr(cls, attr, None) is not getattr(Row, attr, None):\n                    msg = \"It is not possible to customize the method {} for {}.{}\".format(\n                        attr, cls.__module__, cls.__name__\n                    )\n                    raise TypeError(msg)\n\n            cls._Row_prefix_ = \"{}.{}\".format(cls.__module__, cls.__name__)\n            if attrs and not hasattr(cls, \"__getattr__\"):\n                cls.__getattr__ = getattr_impl\n                cls.__setattr__ = setattr_impl\n\n            if buffered:\n                cls._Row_buffered_ = True\n\n            cls._Row_permissions_ = {\n                perm_type: client_writable if value is NOT_FOUND else value\n                for perm_type, value in [\n                    (\"update\", client_updatable),\n                    (\"create\", client_creatable),\n                    (\"delete\", client_deletable),\n                ]\n            }\n\n            # models are portable by default\n            # the first subclass gets registered\n            # subsequent models use the same name\n            # A model can override this in advanced use cases e.g. uplink implementations\n            if Row._Row_model_ is Row:\n                portable_class(cls)\n            else:\n                name = cls.SERIALIZATION_INFO[0]\n                portable_class(name)(cls)\n\n            Row._Row_model_ = cls\n\n    # This allows us to pretend that the model class is the Row class for serialization\n    Row.__name__ = _Row.__name__\n    Row.__module__ = _Row.__module__\n    Row.__qualname__ = _Row.__qualname__\n\n    Row._Row_model_ = Row\n    if tb_name:\n        Row._Row_prefix_ = \"app_tables.{}.Row\".format(tb_name)\n    row_cls_by_id[table_id] = Row\n\n    # we'll be overriding the base Row class in the portable classes registry\n    # But that's fine since Row._anvil_create checks the correct Row subclass to __new__\n    return portable_class(Row)\n\n\ndef get_model_cls(table_id):\n    return get_base_model_cls(table_id)._Row_model_\n\n\ndef serialize_model(table_id, force=False):\n    model = get_model_cls(table_id)\n    if model is None or model is row_cls_by_id.get(table_id) and not force:\n        return None\n    return model\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_refs.py"] = "import anvil.server\nfrom anvil.server import portable_class\n\nfrom ._row import Row, _is_draft\n\n# Helpful classes for table methods that include Rows\/SearchIterators\n# But sending the Row across the wire is unnecessary\n# We shouldn't be deserializing these objects but we include __deserialize__ for completeness\n\n\nclass _Ref(object):\n    def __init__(self, cap):\n        self.cap = cap\n\n    def __hash__(self):\n        return hash(self.cap)\n\n    def __serialize__(self, info):\n        return self.cap\n\n    def __deserialize__(self, cap, info):\n        self.cap = cap\n\n    def __eq__(self, other):\n        if type(self) is not type(other):\n            return NotImplemented\n        return self.cap == other.cap\n\n\n@portable_class(\"anvil.tables.v2._RowRef\")\nclass RowRef(_Ref):\n    pass\n\n\n@portable_class\nclass SearchIteratorRef(_Ref):\n    pass\n\n\ndef to_ref(obj):\n    ob_type = type(obj)\n    if ob_type in (list, tuple):\n        return tuple(to_ref(item) for item in obj)\n    elif isinstance(obj, Row):\n        if _is_draft(obj):\n            raise ValueError(\n                \"It looks like you're trying to write a draft as a linked row. This is not allowed.\"\n                \"Either use row.buffer_changes(True), or save the draft first.\"\n                \" (Found {!r})\".format(obj)\n            )\n        elif obj._anvil.cap is None:\n            raise RuntimeError(\"Row has no capability\")\n        return RowRef(obj._anvil.cap)\n    return obj\n\n\ndef make_refs(args_or_kws):\n    if type(args_or_kws) is dict:\n        return {key: to_ref(val) for key, val in args_or_kws.items()}\n    else:\n        return tuple(to_ref(val) for val in args_or_kws)\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_row.py"] = "import anvil\nimport anvil.server\nfrom anvil.server import Capability\n\nfrom .._base_classes import Row as BaseRow\nfrom .._errors import NoSuchColumnError, RowDeleted, TableError\nfrom . import _batcher\nfrom ._constants import (\n    CAP_KEY,\n    DATETIME,\n    MEDIA,\n    MULTIPLE,\n    NOT_FOUND,\n    SERVER_PREFIX,\n    SHARED_DATA_KEY,\n    SINGLE,\n    UNCACHED,\n)\nfrom ._model import get_model_cls\nfrom ._utils import (\n    InternalDict,\n    ThreadLocal,\n    check_serialized,\n    clean_local_datetime,\n    init_spec_rows,\n    init_view_data,\n    merge_row_data,\n    validate_cap,\n)\n\nPREFIX = SERVER_PREFIX + \"row.\"\n_make_refs = None  # for circular imports\n_auto_create_is_enabled = NOT_FOUND\n\n\nclass _MODE:\n    NORMAL = 0\n    BUFFERED = 1\n    DRAFT = 2\n    # Buffered draft is when we explicitly call\n    # buffer_changes(True) on a draft\n    BUFFERED_DRAFT = 3\n\n\ndef _is_draft(row):\n    return row._anvil.mode is _MODE.DRAFT or row._anvil.mode is _MODE.BUFFERED_DRAFT\n\n\ndef _is_buffered(row):\n    return row._anvil.mode is not _MODE.NORMAL\n\n\ndef _copy(so):\n    if isinstance(so, list):\n        return [_copy(o) for o in so]\n    if isinstance(so, dict):\n        return {k: _copy(v) for k, v in so.items()}\n    return so\n\n\nclass _BufferedContext(object):\n    def __init__(self, row):\n        self._row = row\n\n    def __enter__(self):\n        mode = self._row._anvil.mode\n        if mode is _MODE.NORMAL:\n            self._row._anvil.mode = _MODE.BUFFERED\n        elif mode is _MODE.DRAFT:\n            self._row._anvil.mode = _MODE.BUFFERED_DRAFT\n        return self\n\n    def __exit__(self, exc_type, exc_val, exc_tb):\n        self._row._anvil.buffer.clear()\n        if self._row._anvil.mode is _MODE.BUFFERED_DRAFT:\n            # revert back to a state where if we call save()\n            # then we will return to the default buffered mode\n            self._row._anvil.mode = _MODE.DRAFT\n        else:\n            self._row._anvil.mode = _MODE.NORMAL\n\n\n@anvil.server.portable_class\nclass Row(BaseRow):\n    __slots__ = (\"_anvil\",)\n    _Row_prefix_ = \"anvil.tables.Row\"\n    _Row_buffered_ = False\n    _Row_permissions_ = {\"update\": False, \"create\": False, \"delete\": False}\n\n    @classmethod\n    def _anvil_create(cls, view_key, table_id, row_id, spec=None, cap=None):\n        cls = get_model_cls(table_id)\n        buffer = {} if cls._Row_buffered_ else None\n        row = object.__new__(cls)\n        row._anvil_setup(view_key, table_id, row_id, spec, cap, buffer=buffer)\n        return row\n\n    def _anvil_setup(\n        self, view_key, table_id, row_id, spec=None, cap=None, buffer=None\n    ):\n        object.__setattr__(self, \"_anvil\", InternalDict())\n        self._anvil.view_key = view_key\n        self._anvil.table_id = table_id\n        self._anvil.id = row_id\n        self._anvil.cap = cap\n        self._anvil.cache = {}\n        self._anvil.spec = (\n            spec  # None when we are deserialized without access to table_data\n        )\n        self._anvil.cache_spec = spec[\"cache\"] if spec is not None else []\n        self._anvil.has_uncached = True\n        self._anvil.exists = True\n        self._anvil.dirty_spec = False  # used for serialization\n        if view_key is None:\n            self._anvil.mode = _MODE.DRAFT\n        elif buffer is not None:\n            self._anvil.mode = _MODE.BUFFERED\n        else:\n            self._anvil.mode = _MODE.NORMAL\n        self._anvil.buffer = buffer or {}\n\n        if cap is not None:\n            cap.set_update_handler(self._anvil_cap_update_handler)\n\n        return self\n\n    @classmethod\n    def _anvil_create_from_untrusted(cls, view_key, table_id, row_id, cap, local_data):\n        # check that we can trust the data that was sent!\n        row = local_data.get(cap)\n        if row is None:\n            row = local_data[cap] = cls._anvil_create(\n                view_key, table_id, row_id, None, cap\n            )\n        return row\n\n    @classmethod\n    def _anvil_create_from_trusted(cls, view_key, table_id, row_id, table_data):\n        table_id, row_id = str(table_id), str(row_id)\n        view_data = table_data[view_key]\n        rows = view_data[\"rows\"]\n        row_data = rows[row_id]\n        if isinstance(row_data, Row):\n            # prevent circular and use the created row from view_data\n            return row_data\n        spec = view_data[\"spec\"]\n        row = rows[row_id] = cls._anvil_create(view_key, table_id, row_id, spec)\n        # Replace the compact row_data with ourself\n        # This prevents circular references and has the benefit that\n        # we create the same rows and linked rows when creating Row objects from the same data\n        row._anvil_unpack(table_data, row_data)\n        if view_data.get(\"dirty_spec\"):\n            # a serialized row marked its spec as dirty after an update\n            row._anvil_clear_cache()\n        return row\n\n    @classmethod\n    def _anvil_create_from_local_values(\n        cls, view_key, table_id, row_id, spec, cap, local_items\n    ):\n        # the basic idea here is that we need to clean datetime objects and UNCACHE any linked rows\n        # where the view_key doesn't match what we expect from the col_spec\n        table_id, row_id = str(table_id), str(row_id)\n        row = cls._anvil_create(view_key, table_id, row_id, spec, cap)\n        clean_items = row._anvil_walk_local_items(local_items, missing=None)\n        row._anvil.cache.update(clean_items)\n        row._anvil_check_has_cached()\n        return row\n\n    # DESERIALIZE\n    @classmethod\n    def __new_deserialized__(cls, data, info):\n        table_data, local_data = info.shared_data(SHARED_DATA_KEY)\n        view_key, table_id, row_id, cap = data\n        if not info.remote_is_trusted:\n            validate_cap(cap, table_id, row_id)\n            table_data = None  # just incase\n        if not table_data:\n            # table_data None is not enough because we may be sending rows back and forward\n            # i.e. passing from client to server to client goes untrusted -> trusted -> client\n            return cls._anvil_create_from_untrusted(\n                view_key, table_id, row_id, cap, local_data\n            )\n        return cls._anvil_create_from_trusted(view_key, table_id, row_id, table_data)\n\n    def _anvil_unpack(self, table_data, row_data):\n        assert type(row_data) in (\n            list,\n            dict,\n        ), \"Unable to create Row object, bad row_data\"\n        spec = table_data[self._anvil.view_key][\"spec\"]\n        if self._anvil.spec is None:\n            self._anvil.spec = spec\n        cols = spec[\"cols\"] if spec is not None else []\n        initial_load = not bool(self._anvil.cache)\n        row_data_type = type(row_data)\n        # if the spec is None we must have a dict data type with a single cap key\n        # this potentially happens in (and is enforced by) serialization\n        if row_data_type is list:\n            unpacked_cache, cap = self._anvil_unpack_compact(\n                table_data, spec, cols, row_data, initial_load\n            )\n        elif row_data_type is dict:\n            unpacked_cache, cap = self._anvil_unpack_dict(\n                table_data, cols, row_data, initial_load\n            )\n        else:\n            raise TableError(\"the row data is invalid\")\n\n        assert type(cap) is Capability, \"invalid row_data\"\n        if self._anvil.cap is None:\n            self._anvil.cap = cap\n            cap.set_update_handler(self._anvil_cap_update_handler)\n        self._anvil.cache.update(unpacked_cache)\n        self._anvil_check_has_cached()\n\n    def _anvil_unpack_compact(self, table_data, spec, cols, row_data, initial_load):\n        # spec[\"cache\"] 1s matches the len(row_data) (+cap)\n        iter_row_data = iter(row_data)\n        unpacked_cache = {}\n        for col, is_cached in zip(cols, spec[\"cache\"]):\n            if is_cached:\n                val = self._anvil_unpack_linked(next(iter_row_data), col, table_data)\n            elif initial_load:\n                val = UNCACHED  # there's nothing there yet so fill it\n            else:\n                continue\n            unpacked_cache[col[\"name\"]] = val\n        return unpacked_cache, next(iter_row_data)\n\n    def _anvil_unpack_dict(self, table_data, cols, row_data, initial_load):\n        unpacked_cache = {}\n        for i, col in enumerate(cols):\n            val = row_data.pop(str(i), UNCACHED)\n            if val is UNCACHED and not initial_load:\n                # does this ever happen?\n                continue\n            unpacked_cache[col[\"name\"]] = self._anvil_unpack_linked(\n                val, col, table_data\n            )\n        cap = row_data.pop(CAP_KEY, None)\n        assert len(row_data) == 0, \"Invalid row data\"\n        return unpacked_cache, cap\n\n    def _anvil_unpack_linked(self, val, col, table_data):\n        table_id = col.get(\"table_id\")\n        if table_id is None or val is UNCACHED or val is None:\n            # not a linked row, or UNCACHED linked row (serialize cache dispute), or linked row is None\n            return val\n\n        # This line is failing for baker tilly - wrap in a try except\n        # it has since been reported on the forum and it seemed to be a client-side issue\n        # where the early return was not being triggered\n        try:\n            col_type, view_key = col[\"type\"], col[\"view_key\"]\n        except KeyError:\n            import json\n\n            msg = (\n                'Failed to get \"view_key\" or \"type\" from col={!r}, '\n                \"found table_id={!r}, \"\n                \"val={!r}, \"\n                \"table_id is None={!r}, \"\n                \"server_side={!r}\".format(\n                    col, table_id, val, table_id is None, anvil.is_server_side()\n                )\n            )\n            try:\n                _data = json.dumps(table_data, indent=2, default=lambda o: str(type(o)))\n                msg += \"\\n\\nTable data:\\n{}\".format(_data)\n            except Exception:\n                pass\n\n            raise KeyError(msg)\n\n        if col_type == SINGLE:\n            row_id = val\n            return Row._anvil_create_from_trusted(\n                view_key, table_id, row_id, table_data\n            )\n        elif col_type == MULTIPLE:\n            row_ids = val\n            return [\n                Row._anvil_create_from_trusted(view_key, table_id, row_id, table_data)\n                for row_id in row_ids\n            ]\n\n        raise AssertionError(\"bad col type with table_id\")\n\n    # SERIALIZATION\n    def __serialize__(self, info):\n        self._anvil_check_can_serialize()\n        table_data, local_data = info.shared_data(SHARED_DATA_KEY)\n        if table_data is not None and info.local_is_trusted:\n            self._anvil_merge_and_reduce(table_data, local_data)\n        else:\n            # We want to ensure we're not trying to send a linked draft or row that has buffered changes\n            # TODO - we could be a bit more efficient about this since we don't actually need the data!\n            self._anvil_merge_and_reduce({}, local_data)\n        return [\n            self._anvil.view_key,\n            self._anvil.table_id,\n            self._anvil.id,\n            self._anvil.cap,\n        ]\n\n    def _anvil_check_can_serialize(self, linked=False):\n        error = None\n        pre = \"Linked \" if linked else \"\"\n        if _is_draft(self):\n            error = \"Draft Rows cannot be serialized. Call save() first. (Found {!r})\"\n        elif self._anvil.buffer:\n            error = \"Rows with buffered changes cannot be serialized. Call save() or reset() first, (Found {!r})\"\n        if error:\n            raise anvil.server.SerializationError(pre + error.format(self))\n\n    def _anvil_merge_linked(self, val, col, g_table_data, local_data):\n        type = col[\"type\"]\n        if val is UNCACHED or val is None:\n            # maybe we were serialized and converted linked row(s) to UNCACHED\n            # or actually the linked row is None\n            pass\n        elif type == SINGLE:\n            row = val\n            val = row._anvil_merge_and_reduce(g_table_data, local_data)\n        elif type == MULTIPLE:\n            val = [row._anvil_merge_and_reduce(g_table_data, local_data) for row in val]\n        return val\n\n    def _anvil_make_row_data(self, g_table_data, local_data, cache_spec):\n        self._anvil_check_can_serialize(linked=True)\n        table_spec = self._anvil.spec\n        table_cols = table_spec[\"cols\"] if table_spec is not None else []\n        cache = self._anvil.cache\n        # we can't rely on the order of cache in python 2\n        cached_data = []\n        for i, (col, is_cached) in enumerate(zip(table_cols, cache_spec)):\n            if not is_cached:\n                continue\n            name = col[\"name\"]\n            val = self._anvil_merge_linked(cache[name], col, g_table_data, local_data)\n            cached_data.append((i, val))\n        cached_data.append((CAP_KEY, self._anvil.cap))\n        return cached_data\n\n    def _anvil_merge_and_reduce(self, g_table_data, local_data):\n        if check_serialized(self, local_data):\n            return int(self._anvil.id)\n        g_view_data = init_view_data(self._anvil.view_key, g_table_data)\n        table_spec, row_id, cache_spec = (\n            self._anvil.spec,\n            self._anvil.id,\n            self._anvil.cache_spec,\n        )\n\n        # We assert that there is no way for rows from the same view_key to have different col_specs\n        # This includes the order\n        # the only thing they may differ on is cache_specs\n        g_table_spec, g_table_rows = init_spec_rows(g_view_data, table_spec, cache_spec)\n        g_cache_spec = g_table_spec[\"cache\"] if g_table_spec is not None else None\n\n        if table_spec is not None and g_cache_spec is not None:\n            is_dirty = self._anvil.dirty_spec or len(cache_spec) != len(g_cache_spec)\n        else:\n            is_dirty = self._anvil.dirty_spec\n\n        if is_dirty:\n            g_view_data[\"dirty_spec\"] = True\n            cache_spec = []\n\n        cached_data = self._anvil_make_row_data(g_table_data, local_data, cache_spec)\n        existing = g_table_rows.get(row_id, [])\n\n        if not is_dirty and cache_spec == g_cache_spec and type(existing) is list:\n            row_data = [val for _, val in cached_data]\n        else:\n            row_data = {str(key): val for key, val in cached_data}\n\n        merge_row_data(row_id, row_data, g_table_rows, g_table_spec, cache_spec)\n        return int(row_id)\n\n    # PRIVATE METHODS\n    def _anvil_cap_update_handler(self, updates):\n        if updates is False:\n            # We've been deleted clear_cache so that\n            # server calls are required for data access\n            self._anvil_clear_cache()\n            self._anvil.mode = _MODE.NORMAL\n            self._anvil.buffer.clear()\n            self._anvil.exists = False\n            return\n        elif self._anvil.spec is None:\n            return\n        clean_items = self._anvil_walk_local_items(updates)\n        self._anvil.cache.update(clean_items)\n        for key in clean_items:\n            self._anvil.buffer.pop(key, None)\n        self._anvil_check_has_cached()\n\n    def _anvil_check_has_cached(self):\n        if self._anvil.spec is None:\n            return\n        self._anvil.cache_spec = [\n            int(self._anvil.cache[col[\"name\"]] is not UNCACHED)\n            for col in self._anvil.spec[\"cols\"]\n        ]\n        self._anvil.has_uncached = any(\n            val is UNCACHED for val in self._anvil.cache.values()\n        )\n\n    def _anvil_clear_cache(self):\n        # clearing the cache also clears the spec - this forces a call to the server to update a spec\n        self._anvil.spec = None\n        self._anvil.cache.clear()\n        self._anvil.cache_spec = []\n        self._anvil.has_uncached = True\n\n    def _anvil_fill_cache(self, fetch=None):\n        if fetch is not None:\n            uncached_keys = None if fetch is True else fetch\n        elif self._anvil.spec is None:\n            uncached_keys = None\n        elif self._anvil.has_uncached:\n            uncached_keys = [\n                key for key, val in self._anvil.cache.items() if val is UNCACHED\n            ]\n        else:\n            return  # no uncached values\n\n        table_data = anvil.server.call(PREFIX + \"fetch\", self._anvil.cap, uncached_keys)\n        rows = table_data[self._anvil.view_key][\"rows\"]\n        row_data = rows[self._anvil.id]\n        # Replace the compact row data with this Row instance\n        # so circular references don't clobber the data while we're unpacking.\n        rows[self._anvil.id] = self\n        self._anvil_unpack(table_data, row_data)\n\n    def _anvil_walk_local_items(self, items, missing=NOT_FOUND):\n        # We are about to put local items in the cache\n        # so check linked rows have valid view keys datetimes have tz.offset applied\n        items = items.copy()\n        rv = {}\n        cols = self._anvil.spec[\"cols\"]\n        for col in cols:\n            name, type = col[\"name\"], col[\"type\"]\n            val = items.pop(name, missing)\n            if val is NOT_FOUND:\n                continue\n            else:\n                rv[name] = _copy(val)\n            if val is UNCACHED or val is None:\n                continue\n            elif type == DATETIME:\n                rv[name] = clean_local_datetime(val)\n                continue\n            elif type == MEDIA:\n                rv[name] = UNCACHED  # we need to fetch a lazy media with a valid url\n                continue\n            elif type == SINGLE:\n                val = [val]\n            elif type != MULTIPLE:\n                continue\n            rows = val\n            expected_view_key = col[\"view_key\"]\n            if any(row._anvil.view_key != expected_view_key for row in rows):\n                rv[name] = UNCACHED\n        if len(items):\n            # more items than we should have - our col spec is no good anymore\n            self._anvil.dirty_spec = True\n            rv.update(items)\n        return rv\n\n    def _anvil_check_exists(self):\n        # only call this if we're not doing a server call\n        if not self._anvil.exists:\n            raise RowDeleted(\"This row has been deleted\")\n        elif _is_draft(self):\n            raise ValueError(\"This row is a draft and does not yet exist\")\n\n    # DUNDER METHODS\n    def __setattr__(self, attr, val):\n        raise AttributeError(\n            f\"Rows cannot have local state, trying to set {attr!r} attribute on {self!r}\"\n        )\n\n    def __iter__(self):\n        # call to __iter__ can't suspend\n        # so only do suspension stuff in __next__\n        # note that this will not get called for dict(row)\n        # keys() and __getitem__ wins for a call to dict\n        return RowIterator(self)\n\n    def __contains__(self, key):\n        return key in self.keys()\n\n    def __getitem__(self, key):\n        if not isinstance(key, str):\n            raise TypeError(\n                \"Row columns are always strings, not {}\".format(type(key).__name__)\n            )\n        if _is_buffered(self):\n            rv = self._anvil.buffer.get(key, NOT_FOUND)\n            if rv is not NOT_FOUND:\n                return _copy(rv)\n            if _is_draft(self):\n                return None\n\n        if _batcher.batch_update.active:\n            rv = _batcher.batch_update.read(self._anvil.cap, key)\n            if rv is not NOT_FOUND:\n                return _copy(rv)\n        if self._anvil.spec is None:\n            self._anvil_fill_cache()\n        hit = self._anvil.cache.get(key, NOT_FOUND)\n        if hit is UNCACHED:\n            # we have a spec now so we'll fetch the remaining columns\n            self._anvil_fill_cache()\n        elif hit is NOT_FOUND:\n            global _auto_create_is_enabled\n            if _auto_create_is_enabled is NOT_FOUND:\n                _auto_create_is_enabled = anvil.server.call(PREFIX + \"can_auto_create\")\n            if _auto_create_is_enabled:\n                # try to force fetch this key - incase we have a bad spec - i.e auto-columns\n                self._anvil_fill_cache([key])\n        else:\n            return _copy(hit)\n        try:\n            return _copy(self._anvil.cache[key])\n        except KeyError:\n            raise NoSuchColumnError(\"No such column '\" + key + \"'\")\n\n    def __setitem__(self, key, value):\n        return self.update(**{key: value})\n\n    def __eq__(self, other):\n        if not isinstance(other, Row):\n            return NotImplemented\n        if self is other:\n            return True\n        return (\n            self._anvil.id is not None\n            and other._anvil.id == self._anvil.id\n            and other._anvil.table_id == self._anvil.table_id\n        )\n\n    def __hash__(self):\n        if _is_draft(self):\n            raise ValueError(\"draft rows are unhashable\")\n        self._anvil_check_exists()\n        return hash((self._anvil.table_id, self._anvil.id))\n\n    def __repr__(self):\n        cls = type(self)\n        prefix = cls._Row_prefix_\n        if _is_draft(self):\n            return \"<{} (draft) object>\".format(prefix)\n\n        if self._anvil.spec is None:\n            return \"<{} object>\".format(prefix)\n\n        # custom reprs depending on type\n        def trunc_str(s):\n            return repr(s) if len(s) < 20 else repr(s[:17] + \"...\")\n\n        def dt_repr(d):\n            return \"datetime(\" + str(d) + \")\"\n\n        def d_repr(d):\n            return \"date(\" + str(d) + \")\"\n\n        printable_types = {\n            \"string\": trunc_str,\n            \"bool\": repr,\n            \"date\": d_repr,\n            \"datetime\": dt_repr,\n            \"number\": repr,\n        }\n\n        # Find cols that are both cached and easily printed\n        cache, cols = self._anvil.cache, self._anvil.spec[\"cols\"]\n        cached_printable_cols = [\n            (c[\"name\"], printable_types[c[\"type\"]], cache[c[\"name\"]])\n            for c in cols\n            if c[\"type\"] in printable_types and cache[c[\"name\"]] is not UNCACHED\n        ]\n        # Only keep the first 5\n        cached_printable_cols = cached_printable_cols[:5]\n        # Find all the remaining columns\n        num_remaning = len(cols) - len(cached_printable_cols)\n\n        vals = \", \".join(\n            \"{}={}\".format(name, None if val is None else meth(val))\n            for name, meth, val in cached_printable_cols\n        )\n\n        if not num_remaning:\n            and_more = \"\"\n        elif cached_printable_cols:\n            and_more = \", plus {} more column{}\".format(\n                num_remaning, \"s\" if num_remaning != 1 else \"\"\n            )\n        else:\n            and_more = \"{} column{}\".format(\n                num_remaning, \"s\" if num_remaning != 1 else \"\"\n            )\n\n        return \"<{}: {}{}>\".format(prefix, vals, and_more)\n\n    # PUBLIC API\n    def buffer_changes(self, buffered=None):\n        if buffered:\n            if _is_draft(self):\n                # we are explicitly setting the mode to buffered\n                # this effects the save behaviour\n                # this would be an unusual thing to do - but it does mean you can re-use logic between drafts and rows\n                self._anvil.mode = _MODE.BUFFERED_DRAFT\n            else:\n                self._anvil.mode = _MODE.BUFFERED\n            return _BufferedContext(self)\n        elif buffered is None:\n            # we don't start buffering until we enter the context manager\n            return _BufferedContext(self)\n        elif _is_draft(self):\n            # alternatively we could go to `DRAFT` mode from `BUFFERED_DRAFT` mode\n            raise ValueError(\n                \"Changes in a draft row must always be buffered\"\n                \" - call save() to convert to a realized row or reset to clear the buffer\"\n            )\n        else:\n            self._anvil.mode = _MODE.NORMAL\n            self._anvil.buffer.clear()\n\n    @property\n    def buffered_changes(self):\n        if _is_buffered(self):\n            return _copy(self._anvil.buffer)\n        else:\n            return None\n\n    def save(self):\n        # TODO - add a cascade argument and decide on the correct behaviour\n        # e.g. what happens if cascade is false but you have draft linked rows?\n        save_all(self)\n\n    def reset(self):\n        reset_all(self)\n\n    # deprecated\n    def get_id(self):\n        # For compatibility with LiveObjects\n        self._anvil_check_exists()\n        return \"[{},{}]\".format(self._anvil.table_id, self._anvil.id)\n\n    # TODO reinclude this api\n    # @property\n    # def id(self):\n    #     return self._anvil.id\n\n    # TODO reinclude this api\n    # @property\n    # def table_id(self):\n    #     return self._anvil.table_id\n\n    def get(self, key, default=None):\n        if key in self.keys():\n            return self[key]\n        return default\n\n    def keys(self):\n        if _is_draft(self):\n            return self._anvil.buffer.keys()\n        if self._anvil.spec is None:\n            # if we don't have a _spec we don't have any keys\n            # but we don't need to blindly call _fill_uncached: UNCACHED values are fine\n            self._anvil_fill_cache([])\n        return self._anvil.cache.keys()\n\n    def _anvil_get_view(self):\n        fetch = None\n        if _is_buffered(self):\n            fetch = [k for k in self.keys() if k not in self._anvil.buffer]\n        self._anvil_fill_cache(fetch)\n\n        view = _copy(self._anvil.cache)\n\n        if _batcher.batch_update.active:\n            batched = _batcher.batch_update.get_updates(self._anvil.cap)\n            view.update(_copy(batched))\n\n        if _is_buffered(self):\n            view.update(_copy(self._anvil.buffer))\n\n        return view\n\n    def items(self):\n        return self._anvil_get_view().items()\n\n    def values(self):\n        return self._anvil_get_view().values()\n\n    def update(*args, **new_items):\n        # avoid name conflicts with columns, could use (self, other, \/, **kws)\n        # but positioin only args not available in py2\/Skulpt\n        if not args:\n            raise TypeError(\"method 'update' of 'Row' object needs an argument\")\n        elif len(args) > 2:\n            raise TypeError(\"expected at most 1 argument, got %d\" % (len(args) - 1))\n        elif len(args) == 2:\n            new_items = dict(args[1], **new_items)\n        self = args[0]\n        if not new_items:\n            # backwards compatability hack\n            self._anvil_clear_cache()\n            return\n\n        if _is_buffered(self):\n            self._anvil.buffer.update(new_items)\n        elif not anvil.is_server_side() and type(self)._Row_permissions_[\"update\"]:\n            # If we are on the client and we are a client-updatable model, we should send updates via the\n            # server.\n            anvil.server.call(\n                \"anvil.tables.v2._update_row_on_server\", self, new_items, [type(self)]\n            )\n        else:\n            self._do_update(new_items, not anvil.is_server_side())\n\n    def delete(self):\n        if not anvil.is_server_side() and type(self)._Row_permissions_[\"delete\"]:\n            # If we are a client-deletable model, we should send delete requests via the server\n            anvil.server.call(\"anvil.tables.v2._delete_row_on_server\", self, type(self))\n        else:\n            self._do_delete(not anvil.is_server_side())\n\n    def _do_delete(self, from_client):\n        on_behalf_of_client = self._anvil_on_behalf_of_client(\"delete\", from_client)\n\n        if _batcher.batch_delete.active:\n            return _batcher.batch_delete.push(\n                self._anvil.cap, False, on_behalf_of_client\n            )\n\n        anvil.server.call(PREFIX + \"delete\", self._anvil.cap, on_behalf_of_client)\n        self._anvil.cap.send_update(False)\n\n    def refresh(self, fetch=None):\n        if fetch is not None:\n            from ..query import fetch_only\n\n            if not isinstance(fetch, fetch_only):\n                raise TypeError(\n                    \"the second argument to refresh should be a q.fetch_only() object\"\n                )\n            fetch = fetch.spec\n        self._anvil_clear_cache()\n        self._anvil_fill_cache(fetch)\n        # Note: the underlying db values are fetched and the buffer remains unchanged\n\n    @classmethod\n    def _anvil_on_behalf_of_client(cls, permission, from_client):\n        # We're on the server, this request originated on the client, and the client doesn't have permission to do this\n        return (\n            anvil.is_server_side()\n            and from_client\n            and not cls._Row_permissions_[permission]\n        )\n\n    def _do_update(self, updates, from_client):\n        on_behalf_of_client = self._anvil_on_behalf_of_client(\"update\", from_client)\n\n        if _batcher.batch_update.active:\n            # a batch update might be on_behalf_of_client, if we are called during a save\n            # and the save was from the client\n            # and one of the updates does not have client_updatable permissions set\n            return _batcher.batch_update.push(\n                self._anvil.cap, updates, on_behalf_of_client\n            )\n\n        global _make_refs\n        if _make_refs is None:\n            from ._refs import make_refs  # circular import\n\n            _make_refs = make_refs\n\n        anvil.server.call(\n            PREFIX + \"update\", self._anvil.cap, _make_refs(updates), on_behalf_of_client\n        )\n        self._anvil.cap.send_update(updates)\n\n    @classmethod\n    def _do_create(cls, buffer, from_client):\n        raise NotImplementedError(\"Must be implemented by a subclass\")\n\n\nclass RowIterator:\n    def __init__(self, row):\n        self._row = row\n        self._fill_required = row._anvil.spec is None and not _is_draft(row)\n        if _is_draft(row):\n            self._iter = iter(row._anvil.buffer.items())\n        else:\n            self._iter = iter(row._anvil.cache.items())\n\n    def __iter__(self):\n        return self\n\n    def __next__(self):\n        if self._fill_required:\n            self._row._anvil_fill_cache()\n            self.__init__(self._row)\n\n        key, value = next(self._iter)\n\n        if _batcher.batch_update.active:\n            batched = _batcher.batch_update.read(self._row._anvil.cap, key)\n            if batched is not NOT_FOUND:\n                value = batched\n\n        if not _is_draft(self._row) and key in self._row._anvil.buffer:\n            value = self._row._anvil.buffer[key]\n\n        if value is UNCACHED:\n            # fill the rest of the cache\n            # since we probably want all the items!\n            # we rely here on the _cache keys not changing during iteration\n            # which works since we've filled it with UNCACHED values that match our expected keys\n            self._row._anvil_fill_cache()\n            value = self._row._anvil.cache[key]\n\n        return (key, _copy(value))\n\n    next = __next__\n\n\nif anvil.is_server_side():\n    import anvil.tables\n\n    @anvil.tables.in_transaction(relaxed=True)\n    def _save_on_server(changes, from_client, models=None):\n        from . import get_table_by_id\n\n        drafts = []\n\n        for draft_info in changes[\"draft_info\"]:\n            table_id = draft_info[\"table_id\"]\n            table = get_table_by_id(table_id)\n            from ._model import get_model_cls\n\n            model = get_model_cls(table_id)\n            rv = model._do_create(draft_info[\"buffer\"], from_client)\n            if not isinstance(rv, table.Row):\n                raise Exception(\"Row._do_create() must return a Row\")\n            drafts.append(rv)\n\n        # create empty buffers for each draft\n        # these buffers will be filled with any links\/mulitlinks that contained drafts\n        # we couldn't include these changes with creation - so we write the changes later\n        draft_buffers = [{} for _ in changes[\"draft_info\"]]\n\n        for single in changes[\"single\"]:\n            # single has paths to drafts and we inject the crated drafts into the appropriate paths\n            path = single[\"path\"]\n            row_index = single[\"row\"]\n            row = drafts[row_index]\n            if path[0] == \"rows\":\n                buffer = changes[\"buffers\"][path[1]]\n            elif path[0] == \"drafts\":\n                buffer = draft_buffers[path[1]]\n            key = path[2]\n            buffer[key] = row\n\n        for multi in changes[\"multi\"]:\n            # multi has paths to drafts and we inject the crated drafts into the appropriate paths\n            path = multi[\"path\"]\n            rows = multi[\"rows\"]\n            for i, row in enumerate(rows):\n                if isinstance(row, int):\n                    rows[i] = drafts[row]\n            if path[0] == \"rows\":\n                buffer = changes[\"buffers\"][path[1]]\n            elif path[0] == \"drafts\":\n                buffer = draft_buffers[path[1]]\n            key = path[2]\n            buffer[key] = rows\n\n        with _batcher.batch_update:\n            for row, buffer in zip(changes[\"rows\"], changes[\"buffers\"]):\n                buffer = buffer or {}\n                table = get_table_by_id(row._anvil.table_id)\n                if not isinstance(row, Row):\n                    raise TypeError(\"changes['rows'] must consist of Row objects\")\n                row._do_update(buffer, from_client)\n\n            for row, buffer in zip(drafts, draft_buffers):\n                if not buffer:\n                    continue\n\n                table = get_table_by_id(row._anvil.table_id)\n                row._do_update(buffer, from_client)\n\n        return drafts\n\n    if anvil.server.context.type != \"uplink\":\n\n        @anvil.server.callable(\"anvil.tables.v2._save_on_server\")\n        def _wrap_save_on_server(changes, models=None):\n            return _save_on_server(changes, True, models)\n\n        @anvil.server.callable(\"anvil.tables.v2._update_row_on_server\")\n        def _wrap_update_on_server(row, changes, models=None):\n            if not isinstance(row, Row):\n                raise TypeError(\"Must pass a table row\")\n            row._do_update(changes, True)\n\n        @anvil.server.callable(\"anvil.tables.v2._delete_row_on_server\")\n        def _wrap_delete_on_server(row, models=None):\n            if not isinstance(row, Row):\n                raise TypeError(\"Must pass a table row\")\n            row._do_delete(True)\n\n\ndef _walk_buffered_changes(row, changes, drafts, buffered, seen):\n    # Approach: we fill the changes dict with draft buffers, rows with bufferred changes and their buffers\n    # where drafts exist in any of the buffers we replace the value with None\n    # we keep track of the path to the where the draft was\n    # we do something similar with multilinke, but replace the element in the list with None\n    # when it comes to saving these changes, we fill the links and multi links after we've created the drafts\n\n    # we can't hash a draft, use the id, because to equal rows might have different buffered changes\n    row_key = id(row)\n    if row_key in seen:\n        return changes\n\n    seen[row_key] = {}\n    buffer = {}\n    path_start = \"rows\"\n    index = None\n\n    if _is_draft(row):\n        buffer = _copy(row._anvil.buffer)\n        index = len(drafts)\n        seen[row_key][\"index\"] = index\n        drafts.append(row)\n        changes[\"draft_info\"].append(\n            {\"buffer\": buffer, \"table_id\": row._anvil.table_id}\n        )\n        path_start = \"drafts\"\n\n    elif _is_buffered(row):\n        buffered.append(row)\n        buffer = _copy(row._anvil.buffer)\n        if buffer:\n            index = len(changes[\"rows\"])\n            changes[\"rows\"].append(row)\n            changes[\"buffers\"].append(buffer)\n\n    else:\n        assert not buffer, \"buffer should be empty\"\n\n    # now check for any linked drafts\n    for key, val in buffer.items():\n        if isinstance(val, Row):\n            _walk_buffered_changes(\n                val,\n                changes=changes,\n                seen=seen,\n                buffered=buffered,\n                drafts=drafts,\n            )\n\n            if _is_draft(val):\n                buffer[key] = None\n                val_index = seen[id(val)][\"index\"]\n                path = [path_start, index, key]\n                changes[\"single\"].append({\"path\": path, \"row\": val_index})\n\n        elif isinstance(val, list):\n            has_draft = False\n            for i, v in enumerate(val):\n                if isinstance(v, Row):\n                    _walk_buffered_changes(\n                        v,\n                        changes=changes,\n                        seen=seen,\n                        buffered=buffered,\n                        drafts=drafts,\n                    )\n\n                    if _is_draft(v):\n                        has_draft = True\n                        val[i] = seen[id(v)][\"index\"]\n\n            if has_draft:\n                changes[\"multi\"].append({\"path\": [path_start, index, key], \"rows\": val})\n                buffer[key] = None\n\n    if row._anvil.spec is None:\n        # we don't have anything in our cache that needs changing\n        return\n\n    # we don't need to worry about drafts in the cache\n    for val in row._anvil.cache.values():\n        if isinstance(val, Row):\n            _walk_buffered_changes(\n                val,\n                changes=changes,\n                seen=seen,\n                buffered=buffered,\n                drafts=drafts,\n            )\n        elif isinstance(val, list):\n            for v in val:\n                if isinstance(v, Row):\n                    _walk_buffered_changes(\n                        v,\n                        changes=changes,\n                        seen=seen,\n                        buffered=buffered,\n                        drafts=drafts,\n                    )\n\n\ndef _initialize_drafts(server_drafts, drafts):\n    # we now walk the rows that need changing\n    # we clear the buffer for each row\n    # and we update the buffer mode\n    # when we have drafts, the response should include capabilities that we need to map to the draft\n    assert len(server_drafts) == len(drafts), \"Draft count doesn't match response count\"\n    for server_draft, draft in zip(server_drafts, drafts):\n        draft_internal = draft._anvil\n        assert (\n            draft_internal.table_id == server_draft._anvil.table_id\n        ), \"Table ids don't match\"\n        object.__setattr__(draft, \"_anvil\", _copy(server_draft._anvil))\n        draft._anvil.buffer = draft_internal.buffer\n        draft._anvil.mode = draft_internal.mode\n\n        # mode switches to the default mode - unless we have explicitly set buffer_changes(True)\n        if draft._anvil.mode is _MODE.BUFFERED_DRAFT:\n            # explicitly set to buffered mode\n            draft._anvil.mode = _MODE.BUFFERED\n        elif type(draft)._Row_buffered_:\n            draft._anvil.mode = _MODE.BUFFERED\n        else:\n            draft._anvil.mode = _MODE.NORMAL\n\n\ndef _reset_changes(buffered, drafts):\n    for row in buffered:\n        row._anvil.buffer.clear()\n\n    for row in drafts:\n        row._anvil.buffer.clear()\n\n\ndef save_all(*rows):\n    # TODO - only check this on the client\n    # but wait for auto batching to be implemented\n    # if not anvil.is_server_side() and batch_update.active:\n    if _batcher.batch_update.active:\n        raise RuntimeError(\"Cannot call save() inside a batch_update block\")\n\n    changes = {\n        \"rows\": [],\n        \"buffers\": [],\n        \"draft_info\": [],\n        \"single\": [],\n        \"multi\": [],\n    }\n    drafts = []\n    buffered = []\n    seen = {}\n\n    for row in rows:\n        _walk_buffered_changes(\n            row,\n            changes=changes,\n            drafts=drafts,\n            buffered=buffered,\n            seen=seen,\n        )\n\n    temp_buffers = [{**row._anvil.buffer} for row in buffered]\n    _reset_changes(buffered, [])\n    server_drafts = []\n\n    try:\n        if changes[\"draft_info\"] or changes[\"rows\"]:\n            if anvil.is_server_side():\n                server_drafts = _save_on_server(changes, False)\n            else:\n                from ._model import serialize_model\n\n                table_ids = {d[\"table_id\"] for d in changes[\"draft_info\"]}\n                models = [serialize_model(id, True) for id in table_ids]\n                server_drafts = anvil.server.call(\n                    \"anvil.tables.v2._save_on_server\", changes, models\n                )\n    except:\n        for row, buffer in zip(buffered, temp_buffers):\n            row._anvil.buffer.update(buffer)\n        raise\n\n    _initialize_drafts(server_drafts, drafts)\n    _reset_changes(buffered, drafts)\n\n\ndef reset_all(*rows):\n    changes = {\n        \"rows\": [],\n        \"buffers\": [],\n        \"draft_info\": [],  # {\"buffer\": dict, \"table_id\": str}[]\n        \"single\": [],  # {\"path\": [\"rows\" | \"drafts\", index, key], \"row\": int}\n        # the row row is where to find the draft in the draft list\n        # the path is the path to the hole that should be replaced by the draft row\n        \"multi\": [],  # {\"path\": [\"rows\" | \"drafts\", index, key], \"rows\": [Row | int]}\n        # the rows is a list of realized rows and ints\n        # the ints represent where to find the draft in the draft list\n        # the path is the path to the hole that should be replaced by the rows\n    }\n    drafts = []\n    seen = {}\n    buffered = []\n\n    for row in rows:\n        _walk_buffered_changes(\n            row,\n            changes=changes,\n            drafts=drafts,\n            buffered=buffered,\n            seen=seen,\n        )\n\n    _reset_changes(buffered, drafts)\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_search.py"] = "import anvil.server\nfrom anvil.server import Capability\n\nfrom .._base_classes import SearchIterator as BaseSearchIterator\nfrom ._constants import CAP_KEY, SERVER_PREFIX, SHARED_DATA_KEY\nfrom ._row import Row\nfrom ._utils import (\n    check_serialized,\n    init_spec_rows,\n    init_view_data,\n    merge_row_data,\n    validate_cap,\n)\n\nPREFIX = SERVER_PREFIX + \"search.\"\n\n\nclass PartialSearchIter(object):\n    def __init__(self, s, slice_):\n        self._view_key = s._view_key\n        self._table_id = s._table_id\n        self._cap = s._cap\n        self._idx = slice_.start or 0\n        self._step = slice_.step or 1\n        self._stop = slice_.stop\n        row_ids, cap_next = s._row_ids, s._cap_next\n        if row_ids is None:\n            # this can happen in deserialization from untrusted\/None transmited data\n            row_ids, cap_next = [], s._cap\n        assert cap_next is None or type(cap_next) is Capability\n        self._reset(row_ids, cap_next, s._table_data)\n\n    def _reset(self, row_ids, cap_next, table_data):\n        if self._stop is not None and len(row_ids) > self._stop:\n            row_ids, cap_next = row_ids[: self._stop], None\n        self._row_ids = row_ids\n        self._cap_next = cap_next\n        self._table_data = table_data\n\n    def _iter_next_page(self):\n        if self._cap_next is None:\n            raise StopIteration\n\n        num_row_ids = len(self._row_ids)\n        self._idx -= num_row_ids\n        if self._stop is not None:\n            self._stop -= num_row_ids\n\n        row_ids, cap_next, table_data = anvil.server.call(\n            PREFIX + \"next_page\", self._cap_next\n        )\n\n        self._reset(row_ids, cap_next, table_data)\n        return self.__next__()\n\n    def __iter__(self):\n        return self\n\n    def __next__(self):\n        try:\n            row_id = self._row_ids[self._idx]\n        except IndexError:\n            return self._iter_next_page()\n        self._idx += self._step\n        return Row._anvil_create_from_trusted(\n            self._view_key, self._table_id, row_id, self._table_data\n        )\n\n    next = __next__\n\n\n@anvil.server.portable_class\nclass SearchIterator(BaseSearchIterator):\n    @classmethod\n    def _create(cls, view_key, table_id, row_ids, cap, cap_next, table_data):\n        self = object.__new__(cls)\n        assert cap_next is None or type(cap_next) is Capability\n        self._view_key = view_key\n        self._table_id = table_id\n        self._row_ids = row_ids\n        self._cap = cap\n        self._cap_next = cap_next\n        self._table_data = table_data\n        self._from_serialize = False\n        return self\n\n    @classmethod\n    def __new_deserialized__(cls, data, info):\n        view_key, table_id, row_ids, cap, cap_next = data\n        table_data, _ = info.shared_data(SHARED_DATA_KEY)\n        if not info.remote_is_trusted:\n            validate_cap(cap, table_id)\n            table_data = None\n        if not table_data:\n            row_ids = cap_next = None\n        # when we deserialize ourselves we may have more data than we need\n        self = cls._create(view_key, table_id, row_ids, cap, cap_next, table_data)\n        self._from_serialize = True\n        return self\n\n    def _fill_data(self):\n        self._row_ids, self._cap_next, self._table_data = anvil.server.call(\n            PREFIX + \"next_page\", self._cap\n        )\n\n    def _clear_cache(self):\n        self._row_ids = self._table_data = self._cap_next = None\n\n    # SERIALIZATION\n    def _make_row_data(self, row_data, table_spec, compact=True):\n        if type(row_data) is dict or compact:\n            # this row didn't match our cache_spec so just send it\n            # or we are list and we're compact because our cache_specs already match\n            return row_data\n\n        cache_spec = table_spec[\"cache\"]\n        # we are currently compact and we need to be a dict\n        new_data = {CAP_KEY: row_data[-1]}\n        iter_row_data = iter(row_data)\n\n        new_data = {\n            str(i): next(iter_row_data)\n            for i, is_cached in enumerate(cache_spec)\n            if is_cached\n        }\n        cap = next(iter_row_data)\n        assert type(cap is Capability)\n        new_data[CAP_KEY] = cap\n        return new_data\n\n    def _get_table_view_iter(self):\n        if not self._from_serialize:\n            # Fast Path - we were created from my_table.search() so the table_data is already minimal\n            # i.e. we don't need to clean it based on table_specs\n            return self._table_data.keys()\n\n        # Slow Path - we're reserializing ourselves from a previous serialization\n        # so we may have too much data if we were serialized with merged table_data\n        table_view_keys = set()\n        # walk the table_specs and insert the view_keys and table_ids we need\n        _populate_table_views_ids(self._view_key, self._table_data, table_view_keys)\n        return table_view_keys\n\n    def _merge(self, g_table_data, local_data):\n        if check_serialized(self, local_data):\n            return\n\n        table_view_keys = self._get_table_view_iter()\n\n        for view_key in table_view_keys:\n            g_view_data = init_view_data(view_key, g_table_data)\n            l_view_data = self._table_data[view_key]\n\n            l_table_spec, l_table_rows = (\n                l_view_data[\"spec\"],\n                l_view_data.get(\"rows\", {}),\n            )\n            g_table_spec, g_table_rows = init_spec_rows(g_view_data, l_table_spec)\n\n            g_cache_spec = g_table_spec[\"cache\"]\n            l_cache_spec = l_table_spec[\"cache\"]\n            cache_match = g_table_spec is l_table_spec or g_cache_spec == l_cache_spec\n\n            for row_id, row_data in l_table_rows.items():\n                if isinstance(row_data, Row):\n                    # Ok we've already been created\n                    # this is rare - we've consumed the search iterator and now we're serializing\n                    # or we created this row from shared serialization data and we're now reserializing\n                    row = row_data\n                    row._anvil_merge_and_reduce(g_table_data, local_data)\n                    continue\n\n                g_row_data = g_table_rows.get(row_id, [])\n                g_is_compact = cache_match and type(g_row_data) is list\n                row_data = self._make_row_data(\n                    row_data, l_table_spec, compact=g_is_compact\n                )\n                merge_row_data(\n                    row_id, row_data, g_table_rows, g_table_spec, l_cache_spec\n                )\n\n    def __serialize__(self, info):\n        table_data, local_data = info.shared_data(SHARED_DATA_KEY)\n        row_ids = self._row_ids\n        if table_data is None:\n            row_ids = self._cap_next = None\n        elif info.local_is_trusted and self._table_data is not None:\n            self._merge(table_data, local_data)\n        return [self._view_key, self._table_id, row_ids, self._cap, self._cap_next]\n\n    def _make_partial_iterator(self, slice_=slice(None)):\n        return PartialSearchIter(self, slice_)\n\n    def __iter__(self):\n        return self._make_partial_iterator()\n\n    def __len__(self):\n        if self._cap_next is None and self._row_ids is not None:\n            return len(self._row_ids)\n        return anvil.server.call(PREFIX + \"get_length\", self._cap)\n\n    def __hash__(self):\n        return hash((self._table_id, self._cap))\n\n    def __eq__(self, other):\n        if not isinstance(other, SearchIterator):\n            return NotImplemented\n        return self._cap == other._cap\n\n    def __bool__(self):\n        # because we have a __len__ and we can't suspend\n        return True\n\n    __nonzero__ = __bool__\n\n    def refresh(self):\n        self._clear_cache()\n\n    def to_csv(self, escape_for_excel=False):\n        return anvil.server.call(\n            PREFIX + \"to_csv\", self._cap, escape_for_excel=escape_for_excel\n        )\n\n    def delete_all_rows(self):\n        result = anvil.server.call(PREFIX + \"delete_all\", self._cap)\n        self._clear_cache()\n        return result\n\n    def __getitem__(self, idx):\n        if self._row_ids is None:\n            self._fill_data()\n\n        if isinstance(idx, slice):\n            slice_ = slice(\n                as_slice_idx(idx.start), as_slice_idx(idx.stop), as_slice_idx(idx.step)\n            )\n            return self._make_partial_iterator(slice_)\n        else:\n            slice_ = slice(as_idx(idx), None)\n        try:\n            return next(self._make_partial_iterator(slice_))\n        except StopIteration:\n            raise IndexError(\"search index out of range\")\n\n\ndef as_idx(i, msg=\"search indices must be non-negative integers\", can_be_none=False):\n    if i is None and can_be_none:\n        return None\n    elif type(i) is int:\n        pass\n    elif hasattr(i, \"__index__\"):\n        i = i.__index__()\n    else:\n        raise TypeError(msg)\n    if i < 0:\n        raise ValueError(msg)\n    return i\n\n\ndef as_slice_idx(i):\n    msg = \"search slice indices must non-negative itegers (or None)\"\n    return as_idx(i, msg, True)\n\n\ndef _populate_table_views_ids(view_key, table_data, seen):\n    # We might hold too much data if our table_data was from another serialization\n    # If we're reserializing ourselves then this method prevents sending unnecessary data across the wire\n    if view_key in seen:\n        # prevent circular references\n        return\n\n    try:\n        table_spec = table_data[view_key][\"spec\"]\n    except KeyError:\n        # Then these linked rows were not included in the data - probably uncached from the cache spec\n        # don't try include this view_key when serializing the data\n        return\n\n    seen.add(view_key)\n    cols = table_spec[\"cols\"]\n\n    for col in cols:\n        view_key = col.get(\"view_key\")\n        if view_key is None:\n            continue\n        _populate_table_views_ids(view_key, table_data, seen)\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_table.py"] = "import anvil.server\nfrom anvil.server import Capability\n\nfrom .._base_classes import Table as BaseTable\nfrom ._constants import CASCADE, KNOWN_PERMS, READ, SERVER_PREFIX, WRITE\nfrom ._model import get_base_model_cls\nfrom ._refs import make_refs\nfrom ._row import Row\nfrom ._search import SearchIterator\nfrom ._utils import validate_cap\n\nPREFIX = SERVER_PREFIX + \"table.\"\n\n\n@anvil.server.portable_class\nclass Table(BaseTable):\n    @classmethod\n    def _create(cls, cap, view_key, table_id):\n        assert cap is None or type(cap) is Capability, \"expected a table capability\"\n        self = object.__new__(cls)\n        self._cap = cap\n        self._view_key = view_key\n        table_id = str(table_id)\n        self._id = table_id\n        self.Row = get_base_model_cls(table_id)\n        return self\n\n    @classmethod\n    def __new_deserialized__(cls, data, info):\n        cap, view_key, table_id = data\n        if not info.remote_is_trusted:\n            validate_cap(cap, table_id)\n        return cls._create(cap, view_key, table_id)\n\n    def __serialize__(self, _info):\n        return [self._cap, self._view_key, self._id]\n\n    def __iter__(self):\n        raise TypeError(\n            \"You can't iterate on a table. Call search() on this table to get an iterator of rows instead.\"\n        )\n\n    def __eq__(self, other):\n        if not isinstance(other, Table):\n            return NotImplemented\n        return other._id == self._id\n\n    def __hash__(self):\n        return hash(self._id)\n\n    def __contains__(self, row):\n        return self.has_row(row)\n\n    def _get_view(self, perm, args, kws):\n        assert perm in KNOWN_PERMS, \"bad permission\"\n        new_cap, view_key = anvil.server.call(\n            PREFIX + \"get_view\", self._cap, perm, None, make_refs(args), make_refs(kws)\n        )\n        return Table._create(new_cap, view_key, self._id)\n\n    # PUBLIC API\n    def restrict_columns(self, col_spec):\n        new_cap, view_key = anvil.server.call(\n            \"get_restricted_columns\", self._cap, col_spec\n        )\n        return Table._create(new_cap, view_key, self._id)\n\n    def client_readable(self, *args, **kws):\n        return self._get_view(READ, args, kws)\n\n    def client_writable(self, *args, **kws):\n        return self._get_view(WRITE, args, kws)\n\n    def client_writable_cascade(self, *args, **kws):\n        return self._get_view(CASCADE, args, kws)\n\n    def delete_all_rows(self):\n        return anvil.server.call(PREFIX + \"delete_all_rows\", self._cap)\n\n    def add_rows(self, rows):\n        # rows can be an iterable of dicts\n        row_dicts = []\n        refs = []\n        for row in rows:\n            row = dict(row)\n            refs.append(make_refs(row))\n            row_dicts.append(row)\n        row_id_caps, spec = anvil.server.call(PREFIX + \"add_rows\", self._cap, refs)\n        return [\n            self.Row._anvil_create_from_local_values(\n                self._view_key, self._id, row_id, spec, cap, row_items\n            )\n            for (row_id, cap), row_items in zip(row_id_caps, row_dicts)\n        ]\n\n    def add_row(self, **data):\n        return self._do_add_row(data)\n\n    def _do_add_row(self, data, on_behalf_of_client=False):\n        row_id, cap, spec = anvil.server.call(\n            PREFIX + \"add_row\", self._cap, make_refs(data), on_behalf_of_client\n        )\n        return self.Row._anvil_create_from_local_values(\n            self._view_key, self._id, row_id, spec, cap, data\n        )\n\n    def get(self, *args, **kws):\n        row_id_table_data = anvil.server.call(\n            PREFIX + \"get_row\", self._cap, make_refs(args), make_refs(kws)\n        )\n        return row_id_table_data and self.Row._anvil_create_from_trusted(\n            self._view_key, self._id, *row_id_table_data\n        )\n\n    def get_by_id(self, row_id, fetch=None):\n        row_id_table_data = anvil.server.call(\n            PREFIX + \"get_row_by_id\", self._cap, row_id, fetch=fetch\n        )\n        return row_id_table_data and self.Row._anvil_create_from_trusted(\n            self._view_key, self._id, *row_id_table_data\n        )\n\n    def has_row(self, row):\n        if not isinstance(row, Row):\n            # backwards compatability return False\n            return False\n        elif row._anvil.table_id != self._id:\n            return False\n        return anvil.server.call(PREFIX + \"has_row\", self._cap, row._anvil.id)\n\n    def list_columns(self):\n        return anvil.server.call(PREFIX + \"list_columns\", self._cap)\n\n    def search(self, *args, **kws):\n        kws = make_refs(kws)\n        row_ids, cap, cap_next, table_data = anvil.server.call(\n            PREFIX + \"search\", self._cap, args, kws\n        )\n        return SearchIterator._create(\n            self._view_key, self._id, row_ids, cap, cap_next, table_data\n        )\n\n    def to_csv(self, escape_for_excel=False):\n        return anvil.server.call(\n            PREFIX + \"to_csv\", self._cap, escape_for_excel=escape_for_excel\n        )\n\n    # TODO reinclude this API\n    # @property\n    # def id(self):\n    #     return self._id\n";Sk.builtinFiles.files["anvil-services\/anvil\/tables\/v2\/_utils.py"] = "import anvil\nimport anvil.tz\nfrom anvil.server import Capability, unwrap_capability\n\nfrom ._constants import CAP_KEY, NOT_FOUND, UNCACHED\n\n\nclass InternalDict:\n    pass\n\n\nThreadLocal = object\n\nif anvil.is_server_side():\n    try:\n        from anvil._threaded_server import ThreadLocal\n    except ImportError:\n        pass\n\n\ndef validate_cap(cap, table_id, row_id=NOT_FOUND):\n    # this function ensures that the cap is the right shape and references the right table\/row\n    # full validation happens in clojure\n    _, _, view_dict, narrowed, _ = unwrap_capability(\n        cap, [\"_\", \"t\", Capability.ANY, Capability.ANY, Capability.ANY]\n    )\n    assert str(view_dict[\"id\"]) == table_id\n    if row_id is not NOT_FOUND:\n        assert row_id == str(narrowed[\"r\"])\n\n\ndef clean_local_datetime(d):\n    if d.tzinfo is not None:\n        offset = d.utcoffset().total_seconds()\n    else:\n        offset = anvil.tz.tzlocal().utcoffset(d).total_seconds()\n    return d.replace(tzinfo=anvil.tz.tzoffset(seconds=offset))\n\n\n# Serialization helpers\ndef check_serialized(self, local_data):\n    self_id = id(self)\n    serialized = local_data.get(self_id, False)\n    local_data[self_id] = True\n    return serialized\n\n\ndef init_view_data(view_key, g_table_data):\n    return g_table_data.setdefault(view_key, {})\n\n\ndef init_spec_rows(g_view_data, table_spec, cache_spec=None):\n    g_table_spec = g_view_data.get(\"spec\")\n    if g_table_spec is not None:\n        pass\n    elif table_spec is None or cache_spec is None:\n        g_table_spec = g_view_data[\"spec\"] = table_spec\n    else:\n        g_table_spec = g_view_data[\"spec\"] = {\n            \"cols\": table_spec[\"cols\"],\n            \"cache\": cache_spec,\n        }\n    g_table_rows = g_view_data.setdefault(\"rows\", {})\n    return g_table_spec, g_table_rows\n\n\ndef merge_row_data(row_id, row_data, g_table_rows, g_table_spec, row_cache_spec):\n    # we've already cleaned the row_data\n    #  - it will only be a compact list if the caches match\n    #  - and g_row_data is either None or also a compact list\n    # otherwise row_data will be a dict\n    g_row_data = g_table_rows.get(row_id)\n\n    # FAST - common case - nothing in row_data\n    if g_row_data is None:\n        g_table_rows[row_id] = row_data\n        return\n\n    g_row_type = type(g_row_data)\n    row_type = type(row_data)\n\n    # handle all UNCACHED - i.e. the partially cached writer wins\n    if g_row_type is list and len(g_row_data) == 1:\n        # the row serialized before us has an all 0 cache_spec and is compact\n        # we are either a dict or a list of the same length\n        g_table_rows[row_id] = row_data\n        return\n    if not any(row_cache_spec):\n        # the row to merge has an all 0 cache_spec\n        return\n\n    # SLOW PATH - uncommon cases\n    # Another reference to this row (not the exact same row) was already serialized before us\n    if row_type is list:\n        # g_row_data must also be a compact list if row_data is a list\n        # they must have the same length at this stage since we know the cache specs match\n        if g_row_type is list:\n            # fail safe sanity check\n            merge_compact(row_data, g_row_data)\n\n    elif g_row_type is dict:\n        # then the previously serialized reference to this row\n        # didn't match the g_cache_spec\n        # so just take the itersect of the dictionaries\n        g_table_rows[row_id] = merge_dicts(row_data, g_row_data)\n        return\n    else:\n        # finally the g_row_type is a compact list and we are a dict - make it a dict\n        g_cache_spec = g_table_spec[\"cache\"]\n        merge_dict_with_compact(row_data, g_row_data, row_cache_spec, g_cache_spec)\n        g_table_rows[row_id] = row_data\n\n\ndef merge_compact(row_data, g_row_data):\n    # any conflicts just replace with UNCACHED sentinel\n    # use len - 1 so we skip the Capability\n    for i in range(len(row_data) - 1):\n        gbl, loc = g_row_data[i], row_data[i]\n        if gbl != loc:\n            g_row_data[i] = UNCACHED\n\n\ndef merge_dicts(row_data, g_row_data):\n    # walk the smallest\n    merged = {}\n    a, b = (\n        (row_data, g_row_data)\n        if len(row_data) < len(g_row_data)\n        else (g_row_data, row_data)\n    )\n    cap = a.pop(CAP_KEY)\n    for key, a_val in a.items():\n        b_val = b.get(key, NOT_FOUND)\n        if a_val == b_val:\n            merged[key] = a_val\n    merged[CAP_KEY] = a[CAP_KEY] = cap\n    return a\n\n\ndef merge_dict_with_compact(row_data, g_row_data, row_cache_spec, g_cache_spec):\n    iter_g_row_data = iter(g_row_data)\n    for i, (is_cached, g_is_cached) in enumerate(zip(row_cache_spec, g_cache_spec)):\n        i = str(i)\n        if not g_is_cached:\n            # we could use the incoming caller wins here\n            if is_cached:\n                row_data.pop(i, None)\n            continue\n\n        g_val = next(iter_g_row_data)\n        if not is_cached:\n            continue\n\n        if i in row_data and row_data[i] != g_val:\n            row_data.pop(i)\n\n    return row_data\n";Sk.builtinFiles.files["anvil-services\/anvil\/users\/__init__.py"] = "import anvil.server\nfrom anvil import *\nfrom .exceptions import UserExists, AuthenticationFailed, EmailNotConfirmed, AccountIsNotEnabled, PasswordNotAcceptable, MFARequired, MFAException, PasswordResetRequested, TooManyPasswordFailures\nfrom .config import get_client_config\n\ndef _to_user_row(user):\n    if type(user) is list:\n        from anvil.tables.v2._row import Row\n        user = Row._anvil_create_from_trusted(*user)\n    return user\n\ndef _to_row_ref(user):\n    from anvil.tables._config import get_client_config\n    if get_client_config().get(\"enable_v2\"):\n        from anvil.tables.v2._refs import to_ref\n        user = to_ref(user)\n    return user\n\n#!suggestAttr(anvil.users,login_with_form)!0:\n\n#!defFunction(anvil.users,_,[invalidate_client_objects=False])!2: \"Forget the current logged-in user.\\n\\nIf invalidate_client_objects is true, all live objects (table rows, Capabilities, unfetched Media, etc) will be invalidated\" [\"logout\"]\ndef logout(invalidate_client_objects=False):\n    anvil.server.call(\"anvil.private.users.logout\", invalidate_client_objects=invalidate_client_objects)\n\n\nanvil.server._register_exception_type(\"anvil.users.UserExists\", UserExists)\nanvil.server._register_exception_type(\"anvil.users.AuthenticationFailed\", AuthenticationFailed)\nanvil.server._register_exception_type(\"anvil.users.EmailNotConfirmed\", EmailNotConfirmed)\nanvil.server._register_exception_type(\"anvil.users.AccountIsNotEnabled\", AccountIsNotEnabled)\nanvil.server._register_exception_type(\"anvil.users.TooManyPasswordFailures\", TooManyPasswordFailures)\nanvil.server._register_exception_type(\"anvil.users.PasswordNotAcceptable\", PasswordNotAcceptable)\nanvil.server._register_exception_type(\"anvil.users.MFARequired\", MFARequired)\nanvil.server._register_exception_type(\"anvil.users.MFAException\", MFAException)\nanvil.server._register_exception_type(\"anvil.users.PasswordResetRequested\", PasswordResetRequested)\n\n#!defFunction(anvil.users,_,email,password,[remember=False])!2: \"Log in with the specified email address and password. Raises anvil.users.AuthenticationFailed exception if the login failed.\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"login_with_email\"]\ndef login_with_email(email, password, remember=False, mfa=None):\n    u = anvil.server.call(\"anvil.private.users.login_with_email\", email, password, remember=remember, mfa=mfa)\n    return _to_user_row(u)\n\n#!defFunction(anvil.users,_,email,password,[remember=False])!2: \"Sign up for a new account with the specified email address and password. Raises anvil.users.UserExists if an account is already registered with this email address.\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"signup_with_email\"]\ndef signup_with_email(email, password, remember=False):\n    u = anvil.server.call(\"anvil.private.users.signup_with_email\", email, password, remember=remember)\n    return _to_user_row(u)\n\n#!defFunction(anvil.users,_,email_address)!2: \"Send a password-reset email to the specified user\" [\"send_password_reset_email\"]\ndef send_password_reset_email(email):\n    return anvil.server.call(\"anvil.private.users.send_password_reset_email\", email)\n\n#!defFunction(anvil.users,_,email_address)!2: \"Send a login link email to the specified user\" [\"send_token_login_email\"]\ndef send_token_login_email(email):\n    anvil.server.call(\"anvil.private.users.send_token_login_email\", email)\n\n#!defFunction(anvil.users,_,old_password,new_password)!2: \"Reset the password for the current user\" [\"reset_password\"]\ndef reset_password(old_password, new_password):\n    anvil.server.call(\"anvil.private.users.reset_password\", old_password, new_password)\n\n\nif is_server_side():\n    def get_user(allow_remembered=True):\n        user = anvil.server.call(\"anvil.private.users.get_current_user\", allow_remembered=allow_remembered)\n        return _to_user_row(user)\n\n    #!defFunction(anvil.users,_,user_row,[remember=False])!2: \"Set the specified user object (a row from a Data Table) as the current logged-in user. It must be a row from the users table. By default, login status is not remembered between sessions.\" [\"force_login\"]\n    def force_login(user, remember=False):\n        u = anvil.server.call(\"anvil.private.users.force_login\", _to_row_ref(user), remember=remember)\n        return _to_user_row(u)\n\n    def _fail(fname):\n        def f(*args, **kwargs):\n            raise Exception(\"You can't use \" + fname + \"() on the server (do it in form code instead)\")\n        return f\n\n    for n in [\"login_with_google\", \"signup_with_google\", \"login_with_facebook\", \"signup_with_facebook\", \"login_with_microsoft\", \"signup_with_microsoft\", \"login_with_saml\", \"signup_with_saml\", \"login_with_raven\", \"signup_with_raven\", \"login_with_form\", \"signup_with_form\"]:\n        globals()[n] = _fail(n)\n\nelse:\n    from . import mfa\n\n    #!defFunction(anvil.users,_,[allow_remembered=True])!2: \"Get the row from the users table that corresponds to the currently logged-in user. If allow_remembered is true (the default), the user may have logged in in a previous session. Returns None if no user is logged in.\" [\"get_user\"]\n    def get_user(allow_remembered=True):\n        try:\n            user = anvil.server.call(\"anvil.private.users.get_current_user\", allow_remembered=allow_remembered)\n        except MFARequired:\n            # This should only happen if the user has arrived with a login token and needs to configure MFA\n            mfa.configure_mfa_with_form()\n            return None\n        except PasswordResetRequested:\n            change_password_with_form(False)\n            user = anvil.server.call(\"anvil.private.users.get_current_user\", allow_remembered=allow_remembered)\n        \n        return _to_user_row(user)\n\n\n    def force_login(user, remember=False):\n        raise Exception(\"You can only use force_login() in server modules\")\n\n    #!defFunction(anvil.users,!,[additional_scopes],[remember=False])!2: \"Log in with a Google account. Prompts the user to authenticate with Google, then logs in with their Google email address (if that user exists). Returns None if the login was cancelled or we have no record of this user.\\n\\nadditional_scopes: If supplied, these are passed on to anvil.google.auth.login().\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"login_with_google\"]\n    def login_with_google(additional_scopes=None, remember=False):\n        if not get_client_config().get(\"use_google\", False):\n            raise Exception(\"Google login is not enabled\")\n\n        import anvil.google.auth\n        if anvil.google.auth.login(additional_scopes):\n            u = anvil.server.call(\"anvil.private.users.login_with_google\", remember=remember)\n            return _to_user_row(u)\n\n    #!defFunction(anvil.users,!,[additional_scopes],[remember=False])!2: \"Sign up for a new account with the email address associated with the user's Google account. Prompts the user to authenticate with Google, then registers a new user with that email address. Raises anvil.users.UserExists if this email address is already registered; returns new user or None if cancelled.\\n\\nadditional_scopes: If supplied, these are passed on to anvil.google.auth.login().\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"signup_with_google\"]\n    def signup_with_google(additional_scopes=None, remember=False):\n        if not get_client_config().get(\"use_google\", False):\n            raise Exception(\"Google signup is not enabled\")\n\n        if not get_client_config().get(\"allow_signup\"):\n            raise Exception(\"New user signup is not enabled\")\n\n        import anvil.google.auth\n        if anvil.google.auth.login(additional_scopes):\n            u = anvil.server.call(\"anvil.private.users.signup_with_google\", remember=remember)\n            return _to_user_row(u)\n\n    #!defFunction(anvil.users,!,[additional_scopes],[remember=False])!2: \"Log in with a Facebook account. Prompts the user to authenticate with Facebook, then logs in with their Facebook email address (if that user exists). Returns None if the login was cancelled or we have no record of this user.\\n\\nadditional_scopes: If supplied, these are passed on to anvil.facebook.auth.login().\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"login_with_facebook\"]\n    def login_with_facebook(additional_scopes=None, remember=False):\n        if not get_client_config().get(\"use_facebook\"):\n            raise Exception(\"Facebook login is not enabled\")\n\n        import anvil.facebook.auth\n        if anvil.facebook.auth.login(additional_scopes):\n            u = anvil.server.call(\"anvil.private.users.login_with_facebook\", remember=remember)\n            return _to_user_row(u)\n\n    #!defFunction(anvil.users,!,[additional_scopes],[remember=False])!2: \"Sign up for a new account with the email address associated with the user's Facebook account. Prompts the user to authenticate with Facebook, then registers a new user with that email address. Raises anvil.users.UserExists if this email address is already registered; returns new user or None if cancelled.\\n\\nadditional_scopes: If supplied, these are passed on to anvil.facebook.auth.login().\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"signup_with_facebook\"]\n    def signup_with_facebook(additional_scopes=None, remember=False):\n        if not get_client_config().get(\"use_facebook\"):\n            raise Exception(\"Facebook signup is not enabled\")\n\n        if not get_client_config().get(\"allow_signup\"):\n            raise Exception(\"New user signup is not enabled\")\n\n        import anvil.facebook.auth\n        if anvil.facbeook.auth.login(additional_scopes):\n            u = anvil.server.call(\"anvil.private.users.signup_with_facebook\", remember=remember)\n            return _to_user_row(u)\n\n    #!defFunction(anvil.users,!,[additional_scopes],[remember=False])!2: \"Log in with a Microsoft account. Prompts the user to authenticate with Microsoft, then logs in with their Microsoft email address (if that user exists). Returns None if the login was cancelled or we have no record of this user.\\n\\nadditional_scopes: If supplied, these are passed on to anvil.microsoft.auth.login().\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"login_with_microsoft\"]\n    def login_with_microsoft(additional_scopes=None, remember=False):\n        if not get_client_config().get(\"use_microsoft\"):\n            raise Exception(\"Microsoft login is not enabled\")\n\n        import anvil.microsoft.auth\n        if anvil.microsoft.auth.login(additional_scopes):\n            u = anvil.server.call(\"anvil.private.users.login_with_microsoft\", remember=remember)\n            return _to_user_row(u)\n\n    #!defFunction(anvil.users,!,[additional_scopes],[remember=False])!2: \"Sign up for a new account with the email address associated with the user's Microsoft account. Prompts the user to authenticate with Microsoft, then registers a new user with that email address. Raises anvil.users.UserExists if this email address is already registered; returns new user or None if cancelled.\\n\\nadditional_scopes: If supplied, these are passed on to anvil.microsoft.auth.login().\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"signup_with_microsoft\"]\n    def signup_with_microsoft(additional_scopes=None, remember=False):\n        if not get_client_config().get(\"use_microsoft\"):\n            raise Exception(\"Microsoft signup is not enabled\")\n\n        if not get_client_config().get(\"allow_signup\"):\n            raise Exception(\"New user signup is not enabled\")\n\n        import anvil.microsoft.auth\n        if anvil.microsoft.auth.login(additional_scopes):\n            u = anvil.server.call(\"anvil.private.users.signup_with_microsoft\", remember=remember)\n            return _to_user_row(u)\n\n    #!defFunction(anvil.users,!,[remember=False])!2: \"Log in via a SAML Identity Provider. Prompts the user to authenticate with SAML, then logs in with their email address (if that user exists). Returns None if the login was cancelled or we have no record of this user.\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"login_with_saml\"]\n    def login_with_saml(remember=False):\n        if not get_client_config().get(\"use_saml\"):\n            raise Exception(\"SAML login is not enabled\")\n\n        import anvil.saml.auth\n        if anvil.saml.auth.login():\n            u = anvil.server.call(\"anvil.private.users.login_with_saml\", remember=remember)\n            return _to_user_row(u)\n\n    #!defFunction(anvil.users,!,[remember=False])!2: \"Sign up for a new account with the email address associated with the user's SAML account. Prompts the user to authenticate via SAML, then registers a new user with that email address. Raises anvil.users.UserExists if this email address is already registered; returns new user or None if cancelled.\\n\\nBy default, login status is not remembered between sessions; set remember=True to remember login status.\" [\"signup_with_saml\"]\n    def signup_with_saml(additional_scopes=None, remember=False):\n        if not get_client_config().get(\"use_saml\"):\n            raise Exception(\"SAML signup is not enabled\")\n\n        if not get_client_config().get(\"allow_signup\"):\n            raise Exception(\"New user signup is not enabled\")\n\n        import anvil.saml.auth\n        if anvil.saml.auth.login(additional_scopes):\n            u = anvil.server.call(\"anvil.private.users.signup_with_saml\", remember=remember)\n            return _to_user_row(u)\n\n    # Disable documentation for raven functions for now.\n    #defFunction(anvil.users,!,[remember=False])!2: \"Log in with a Raven account. Prompts the user to authenticate with Raven, then logs in with their Raven account (if that user exists). Returns None if the login was cancelled or we have no record of this user. By default, login status is not remembered between sessions.\" [\"login_with_raven\"]\n    def login_with_raven(remember=False):\n        if not get_client_config().get(\"use_raven\", False):\n            raise Exception(\"Raven login is not enabled\")\n\n        import raven.auth\n        if raven.auth.login():\n            u = anvil.server.call(\"anvil.private.users.login_with_raven\", remember=remember)\n            return _to_user_row(u)\n\n    #defFunction(anvil.users,!,[remember=False])!2: \"Sign up for a new account with the email address associated with the user's Raven account. Prompts the user to authenticate with Raven, then registers a new user with that email address. Raises anvil.users.UserExists if this email address is already registered; returns new user or None if cancelled. By default, login status is not remembered between sessions.\" [\"signup_with_raven\"]\n    def signup_with_raven(remember=False):\n        if not get_client_config().get(\"use_raven\", False):\n            raise Exception(\"Raven signup is not enabled\")\n\n        if not get_client_config().get(\"allow_signup\"):\n            raise Exception(\"New user signup is not enabled\")\n\n        import raven.auth\n        if raven.auth.login():\n            u = anvil.server.call(\"anvil.private.users.signup_with_raven\", remember=remember)\n            return _to_user_row(u)\n\n\n    _label_style = {}\n\n    def _email_token_login_with_form(initial_email=\"\"):\n\n\n        TextBox = pluggable_ui['anvil.TextBox']\n        panel = LinearPanel()\n\n        email_box = TextBox(placeholder=\"Email address\", text=initial_email)\n        panel.add_component(Label(text=\"Enter your registered email address, and we will send you a \\\"magic link\\\" by email that will log you in.\"))\n        panel.add_component(email_box)\n\n        def show(**e):\n            email_box.focus()\n            email_box.select()\n\n        email_box.set_event_handler(\"show\", show)\n        email_box.set_event_handler(\"pressed_enter\", lambda **e: panel.raise_event(\"x-close-alert\", value=True))\n\n        if alert(panel, title=\"Login by email\", buttons=[(\"Send email\", True, 'success'),(\"Cancel\", False, \"default\")], dismissible=True):\n            return email_box.text\n\n\n\n\n    #!defFunction(anvil.users,!,[remember_by_default=True],[allow_cancel=False])!2: \"Display a sign-up form allowing a user to create a new account. Returns the new user object, or None if cancelled.\\n\\nremember_by_default: if True, the 'remember me' checkbox will be enabled by default.\\n\\nallow_cancel: if True, the signup form has a Cancel button that the user can use to dismiss the form.\" [\"signup_with_form\"]\n    def signup_with_form(_link_back_to_login_on_already_exists=False,remember_by_default=True, allow_cancel=False, initial_email=\"\", initial_password=\"\"):\n        if not get_client_config().get(\"allow_signup\"):\n            raise Exception(\"New user signup is not enabled\")\n\n        TextBoxWithLabel = pluggable_ui['anvil.TextBoxWithLabel']\n        Button = pluggable_ui['anvil.Button']\n        CheckBox = pluggable_ui['anvil.CheckBox']\n\n        lp = LinearPanel()\n        email_box = None\n        passwd_box = None\n        remember_me_checkbox = None\n\n        def email_pressed_enter(**kws):\n            if passwd_box and len(passwd_box) > 0:\n                passwd_box[0].focus()\n\n        def passwd_1_pressed_enter(**kws):\n            if passwd_box and len(passwd_box) > 1:\n                passwd_box[1].focus()\n\n        def passwd_2_pressed_enter(**kws):\n            lp.raise_event('x-close-alert', value='sign-up')\n\n        some_method_available = False\n\n        if get_client_config().get(\"use_email\", False):\n            some_method_available = True\n            email_box = TextBoxWithLabel(placeholder=\"address@example.com\", text=initial_email, label=\"Email:\")\n            email_box.set_event_handler(\"pressed_enter\", email_pressed_enter)\n            lp.add_component(email_box)\n\n        if get_client_config().get(\"use_email\", False):\n            some_method_available = True\n            passwd_box = [TextBoxWithLabel(hide_text=True, label=p[0], placeholder=p[1]) for p in [(\"Password:\", \"password\"), (\"Retype password:\", \"repeat password\")]]\n            passwd_box[0].set_event_handler(\"pressed_enter\", passwd_1_pressed_enter)\n            passwd_box[0].text = initial_password\n            lp.add_component(passwd_box[0])\n            passwd_box[1].set_event_handler(\"pressed_enter\", passwd_2_pressed_enter)\n            lp.add_component(passwd_box[1])\n\n        if get_client_config().get(\"use_google\", False):\n            from .google_button import GoogleSignInButton\n            some_method_available = True\n            def google_login(**evt):\n                import anvil.google.auth\n                try:\n                    if anvil.google.auth.login():\n                        lp.raise_event('x-close-alert', value='google')\n                except Exception as e:\n                    pass # On error, just return to the signup dialog.\n            \n            fp = FlowPanel(align=\"center\", spacing_above=\"large\", spacing_below=\"none\")\n            lnk = Link(spacing_above=\"none\", spacing_below=\"none\")\n            fp.add_component(lnk)\n            lnk.add_component(GoogleSignInButton(\"Sign up with Google\"))\n            lnk.set_event_handler(\"click\", google_login)\n            lp.add_component(fp)\n\n        if get_client_config().get(\"use_facebook\"):\n            some_method_available = True\n            def facebook_login(**evt):\n                import anvil.facebook.auth\n                try:\n                    if anvil.facebook.auth.login():\n                        lp.raise_event('x-close-alert', value='facebook')\n                except Exception as e:\n                    pass # On error, just return to the signup dialog.\n\n            b = Button(text=\"Sign up with Facebook\", icon=\"fa:facebook\", icon_align=\"left\")\n            lp.add_component(b)\n            b.set_event_handler(\"click\", facebook_login)\n\n        if get_client_config().get(\"use_microsoft\"):\n            some_method_available = True\n            def microsoft_login(**evt):\n                import anvil.microsoft.auth\n                try:\n                    if anvil.microsoft.auth.login():\n                        lp.raise_event('x-close-alert', value='microsoft')\n                except Exception as e:\n                    pass # On error, just return to the signup dialog.\n            \n            b = Button(text=\"Sign up with Microsoft\", icon=\"fa:windows\", icon_align=\"left\")\n            lp.add_component(b)\n            b.set_event_handler(\"click\", microsoft_login)\n\n        if get_client_config().get(\"use_saml\"):\n            some_method_available = True\n            def saml_login(**evt):\n                import anvil.saml.auth\n                try:\n                    if anvil.saml.auth.login():\n                        lp.raise_event('x-close-alert', value='saml')\n                except Exception as e:\n                    pass # On error, just return to the signup dialog.\n            \n            b = Button(text=\"Sign up via SAML\", icon=\"fa:lock\", icon_align=\"left\")\n            lp.add_component(b)\n            b.set_event_handler(\"click\", saml_login)\n\n        if get_client_config().get(\"use_raven\", False):\n            some_method_available = True\n            import raven.auth\n            def raven_login(**evt):\n                try:\n                    if raven.auth.login():\n                        lp.raise_event('x-close-alert', value='raven')\n                except Exception as e:\n                    pass # On error, just return to the signup dialog.\n            \n            b = Button(text=\"Sign up with Raven\", icon=\"fa:lock\", icon_align=\"left\")\n            lp.add_component(b)\n            b.set_event_handler(\"click\", raven_login)\n\n        if not some_method_available:\n            raise Exception(\"This app has no supported sign-in methods. Please check settings in the Users Service configuration.\")\n\n        error_lbl = Label(foreground=\"red\", bold=True, spacing_below=\"none\")\n        lp.add_component(error_lbl)\n\n        log_in_instead_link = Link(text=\"Log in instead\", visible=False,\n                                   icon=\"fa:chevron-right\", icon_align=\"right\", spacing_above=\"none\")\n        def log_in_instead(**evt):\n            lp.raise_event('x-close-alert', value=None)\n        log_in_instead_link.set_event_handler(\"click\", log_in_instead)\n        if _link_back_to_login_on_already_exists:\n            lp.add_component(log_in_instead_link)\n\n\n        if get_client_config().get(\"allow_remember_me\", False) and not get_client_config().get(\"confirm_email\", False):\n            remember_me_checkbox = CheckBox(text=\"Remember me\", checked=remember_by_default)\n            lp.add_component(remember_me_checkbox)\n\n        if email_box and passwd_box:\n            lp.set_event_handler(\"show\", lambda **e: (email_box.focus() if not initial_email else (passwd_box[0].focus() if not passwd_box[0].text else passwd_box[1].focus())))\n\n        attempts = 0\n        while True:\n            if passwd_box and attempts > 0:\n                for pb in passwd_box:\n                    pb.text = \"\"\n\n            attempts += 1\n\n            maybe_cancel_button = [(\"Cancel\", None)] if allow_cancel else []\n\n            if get_client_config().get(\"use_email\", False):\n                ar = alert(lp, title=\"Sign Up\", buttons=[(\"Sign Up\", 'sign-up', \"primary\")] + maybe_cancel_button, dismissible=allow_cancel)\n            else:\n                ar = alert(lp, title=\"Sign Up\", buttons=maybe_cancel_button, dismissible=allow_cancel)\n\n            if not ar:\n                return None\n\n            # TODO require certain fields and include them in the sign-up call\n \n            remember = (remember_me_checkbox and remember_me_checkbox.checked)\n\n            try:\n                if ar == 'google':\n                    user = anvil.server.call(\"anvil.private.users.signup_with_google\", remember=remember)\n                elif ar == 'facebook':\n                    user = anvil.server.call(\"anvil.private.users.signup_with_facebook\", remember=remember)\n                elif ar == 'microsoft':\n                    user = anvil.server.call(\"anvil.private.users.signup_with_microsoft\", remember=remember)\n                elif ar == 'saml':\n                    user = anvil.server.call(\"anvil.private.users.signup_with_saml\", remember=remember)\n                elif ar == 'raven':\n                    user = anvil.server.call(\"anvil.private.users.signup_with_raven\", remember=remember)\n                elif ar == 'sign-up' and passwd_box:\n                    if len(email_box.text) < 5 or \"@\" not in email_box.text or \".\" not in email_box.text:\n                        error_lbl.text = \"Enter an email address\"\n                        continue\n                    if passwd_box[1].text != passwd_box[0].text:\n                        error_lbl.text = \"Passwords do not match\"\n                        continue\n\n                    try:\n                        user = anvil.server.call(\"anvil.private.users.signup_with_email\", email_box.text, passwd_box[0].text, remember=remember)\n                    except MFARequired:\n                        mfa_method, _ = mfa._configure_mfa(email_box.text, None, False, [(\"Cancel\", None)], \"Sign up\")\n                        if mfa_method:\n                            user = anvil.server.call(\"anvil.private.users.signup_with_email\", email_box.text, passwd_box[0].text, mfa_method=mfa_method, remember=remember)\n                        else:\n                            continue\n\n                    if get_client_config().get(\"confirm_email\", False):\n                        alert(\"We've sent a confirmation email to \" + email_box.text + \". Open your inbox and click the link to complete your signup.\", title=\"Confirm your Email\", buttons=[(\"OK\", None, \"primary\")])\n                    \n                    return _to_user_row(user)\n\n                else:\n                    raise Exception(\"Invalid configuration for Users service\")\n\n            except UserExists as e:\n                error_lbl.text = str(e.args[0])\n                log_in_instead_link.visible = True\n                continue\n\n            except PasswordNotAcceptable as e:\n                error_lbl.text = str(e.args[0])\n                log_in_instead_link.visible = False\n                continue\n\n            return _to_user_row(user)\n\n    #!defFunction(anvil.users,!,[show_signup_option=True],[remember_by_default=True],[allow_remembered=True],[allow_cancel=False])!2: \"Display a login form and allow user to log in. Returns user object if logged in, or None if cancelled.\\n\\nshow_signup_option: if True, the form will also show the option to sign up for a new account.\\n\\nremember_by_default: if True, the 'remember me' checkbox will be enabled by default.\\n\\nallow_remembered: if False, users with remembered login status will still be required to log in.\\n\\nallow_cancel: if True, the login form has a Cancel button that the user can use to dismiss the form.\" [\"login_with_form\"]\n    def login_with_form(show_signup_option=True,remember_by_default=True, allow_remembered=True, allow_cancel=False):\n        \n        if allow_remembered:\n           u = get_user()\n           if u:\n               return u\n\n        TextBox = pluggable_ui['anvil.TextBox']\n        TextBoxWithLabel = pluggable_ui['anvil.TextBoxWithLabel']\n        Button = pluggable_ui['anvil.Button']\n        CheckBox = pluggable_ui['anvil.CheckBox']\n\n        lp = LinearPanel()\n        email_box = None\n        passwd_box = None\n        remember_me_checkbox = None\n\n        def focus_email(**kws):\n            if email_box:\n                email_box.focus()\n\n        def focus_password(**kws):\n            if passwd_box:\n                passwd_box.focus()\n\n        def close_alert(**kws):\n            lp.raise_event('x-close-alert', value='login')\n\n        some_method_available = False\n        if get_client_config().get(\"use_email\", False):\n            some_method_available = True\n\n            last_email = anvil.server.call(\"anvil.private.users.get_last_login_email\")\n\n            email_box = TextBoxWithLabel(label=\"Email:\", placeholder=\"email@address.com\", text=last_email)\n            passwd_box = TextBoxWithLabel(label=\"Password:\", placeholder=\"password\", hide_text=True, spacing_below=\"none\")\n\n            email_box.set_event_handler(\"pressed_enter\", focus_password)\n            passwd_box.set_event_handler(\"pressed_enter\", close_alert)\n\n            if last_email is None:\n                lp.set_event_handler(\"show\", focus_email)\n            else:\n                lp.set_event_handler(\"show\", focus_password)\n\n            lp.add_component(email_box)\n            lp.add_component(passwd_box)\n            reset_link = Link(text=\"Forgot your password?\", font_size=12, spacing_above=\"none\", align=\"right\")\n            reset_link.set_event_handler('click', lambda **e: lp.raise_event('x-close-alert', value='reset_password'))\n            lp.add_component(reset_link)\n\n        if get_client_config().get(\"use_google\", False):\n            from .google_button import GoogleSignInButton\n            some_method_available = True\n            def google_login(**evt):\n                import anvil.google.auth\n                try:\n                    if anvil.google.auth.login():\n                        lp.raise_event('x-close-alert', value='google')\n                except Exception as e:\n                    pass # On error, just return to the login dialog.\n            \n            fp = FlowPanel(align=\"center\", spacing_above=\"large\", spacing_below=\"none\")\n            lnk = Link(spacing_above=\"none\", spacing_below=\"none\")\n            fp.add_component(lnk)\n            lnk.add_component(GoogleSignInButton())\n            lnk.set_event_handler(\"click\", google_login)\n            lp.add_component(fp)\n\n        if get_client_config().get(\"use_facebook\"):\n            some_method_available = True\n            def facebook_login(**evt):\n                import anvil.facebook.auth\n                try:\n                    if anvil.facebook.auth.login():\n                        lp.raise_event('x-close-alert', value='facebook')\n                except Exception as e:\n                    pass # On error, just return to the login dialog.\n            \n            b = Button(text=\"Log in with Facebook\", icon=\"fa:facebook\", icon_align=\"left\")\n            b.set_event_handler('click', facebook_login)\n            lp.add_component(b)\n\n        if get_client_config().get(\"use_microsoft\"):\n            some_method_available = True\n            def microsoft_login(**evt):\n                import anvil.microsoft.auth\n                try:\n                    if anvil.microsoft.auth.login():\n                        lp.raise_event('x-close-alert', value='microsoft')\n                except Exception as e:\n                    pass # On error, just return to the login dialog.\n            \n            b = Button(text=\"Log in with Microsoft\", icon=\"fa:windows\", icon_align=\"left\")\n            b.set_event_handler('click', microsoft_login)\n            lp.add_component(b)\n\n        if get_client_config().get(\"use_saml\"):\n            some_method_available = True\n            def saml_login(**evt):\n                import anvil.saml.auth\n                try:\n                    if anvil.saml.auth.login():\n                        lp.raise_event('x-close-alert', value='saml')\n                except Exception as e:\n                    pass # On error, just return to the login dialog.\n            \n            b = Button(text=\"Log in via SAML\", icon=\"fa:lock\", icon_align=\"left\")\n            b.set_event_handler('click', saml_login)\n            lp.add_component(b)\n\n        if get_client_config().get(\"use_raven\", False):\n            some_method_available = True\n            def raven_login(**evt):\n                import raven.auth\n                try:\n                    if raven.auth.login():\n                        lp.raise_event('x-close-alert', value='raven')\n                except Exception as e:\n                    pass # On error, just return to the login dialog.\n            \n            b = Button(text=\"Log in with Raven\", icon=\"fa:lock\", icon_align=\"left\")\n            b.set_event_handler('click', raven_login)\n            lp.add_component(b)\n\n        if get_client_config().get(\"use_token\", False):\n            some_method_available = True\n            b = Link(text=\"Send a login link by email\", icon=\"fa:envelope\", icon_align=\"left\", align=\"center\")\n            b.set_event_handler('click', lambda **e: lp.raise_event('x-close-alert', value='email_token'))\n            lp.add_component(b)\n\n        if not some_method_available:\n            raise Exception(\"This app has no supported sign-in methods. Please check settings in the Users Service configuration.\")\n\n        error_lbl = Label(foreground=\"red\", bold=True)\n        lp.add_component(error_lbl)\n\n        if get_client_config().get(\"allow_signup\") and show_signup_option:\n            def open_signup(**evt):\n                lp.raise_event('x-close-alert', value='sign-up')\n            signup_link = Link(text=\"Sign up for a new account\", icon=\"fa:user-plus\")\n            signup_link.set_event_handler('click', open_signup)\n            lp.add_component(signup_link)\n\n        if get_client_config().get(\"allow_remember_me\", False):\n            remember_me_checkbox = CheckBox(text=\"Remember me\", checked=remember_by_default)\n            lp.add_component(remember_me_checkbox)\n\n        while True:\n            if passwd_box:\n                passwd_box.text = \"\"\n\n            maybe_cancel_button = [(\"Cancel\", None)] if allow_cancel else []\n\n            if get_client_config().get(\"use_email\", False):\n                ar = alert(lp, title=\"Log In\", buttons=[(\"Log In\", 'login', 'success')] + maybe_cancel_button, dismissible=allow_cancel)\n            else:\n                ar = alert(lp, title=\"Log In\", buttons=maybe_cancel_button, dismissible=allow_cancel)\n\n            remember = (remember_me_checkbox and remember_me_checkbox.checked)\n            try:\n                if ar == 'google':\n                    user = anvil.server.call(\"anvil.private.users.login_with_google\", remember=remember)\n                    if user or allow_cancel:\n                        return _to_user_row(user)\n                elif ar == 'facebook':\n                    user = anvil.server.call(\"anvil.private.users.login_with_facebook\", remember=remember)\n                    if user or allow_cancel:\n                        return _to_user_row(user)\n                elif ar == 'microsoft':\n                    user = anvil.server.call(\"anvil.private.users.login_with_microsoft\", remember=remember)\n                    if user or allow_cancel:\n                        return _to_user_row(user)\n                elif ar == 'saml':\n                    user = anvil.server.call(\"anvil.private.users.login_with_saml\", remember=remember)\n                    if user or allow_cancel:\n                        return _to_user_row(user)\n                elif ar == 'raven':\n                    user = anvil.server.call(\"anvil.private.users.login_with_raven\", remember=remember)\n                    if user or allow_cancel:\n                        return _to_user_row(user)\n                elif ar == 'email_token':\n                    target_email = _email_token_login_with_form(email_box.text if email_box else \"\")\n                    if target_email:\n                        send_token_login_email(target_email)\n                        alert(\"An email with a login link has been sent to you. You can now close this window.\", buttons=[], dismissible=False)                        \n                elif ar == 'reset_password':\n                    reset_email_box = TextBox(placeholder=\"email@address.com\", text=email_box.text)\n                    pnl = LinearPanel()\n                    pnl.add_component(reset_email_box)\n                    if alert(pnl, title=\"Reset password by email\", buttons=[(\"OK\", True, \"primary\"), (\"Cancel\", False, \"default\")]):\n                        send_password_reset_email(reset_email_box.text)\n                        error_lbl.text = \"Requested password reset for \" + reset_email_box.text + \". Check your email.\"\n                    else:\n                        error_lbl.text = \"\"\n                    # Continue around loop\n                elif ar == 'login':\n\n                    try:\n                        return login_with_email(email_box.text, passwd_box.text, remember=remember)\n                    except MFARequired:\n                        \n                        r = mfa.mfa_login_with_form(email_box.text, passwd_box.text)\n                        \n                        if r == 'reset_mfa':\n                            mfa.send_mfa_reset_email(email_box.text)\n                            error_lbl.text = \"Requested 2-factor authentication reset for \" + email_box.text + \". Check your email.\"\n                        elif r == None:\n                            if allow_cancel:\n                                return None\n                            # Else continue around the loop\n                        else:\n                            # We got an MFA dict. Log in with it.\n                            return login_with_email(email_box.text, passwd_box.text, mfa=r, remember=remember)\n\n                elif ar == 'sign-up':\n                    if signup_with_form(_link_back_to_login_on_already_exists=True, allow_cancel=True, initial_email=email_box.text if email_box else \"\", initial_password=passwd_box.text if passwd_box else \"\"):\n                        user = get_user(allow_remembered=False)\n                        if user:\n                            return user\n                    # else continue around the loop\n                else:\n                    return None\n            except AuthenticationFailed as e:\n                error_lbl.text = e.args[0]\n\n    #!defFunction(anvil.users,_,[require_old_password=True])!2: \"Display a form allowing the current user to reset their password. \" [\"change_password_with_form\"]\n    def change_password_with_form(require_old_password=True):\n\n        TextBox = pluggable_ui['anvil.TextBox']\n\n\n        err = None\n        while True:\n            panel = LinearPanel()\n\n            old_pwd = TextBox(hide_text=True, placeholder=\"Old password\")\n            new_pwd = [TextBox(hide_text=True, placeholder=\"New password\"), TextBox(hide_text=True, placeholder=\"Confirm new password\")]\n\n            if require_old_password:\n                panel.add_component(old_pwd)\n                old_pwd.set_event_handler(\"show\", lambda **e: old_pwd.focus())\n                old_pwd.set_event_handler(\"pressed_enter\", lambda **e: new_pwd[0].focus())\n            else:\n                new_pwd[0].set_event_handler(\"show\", lambda **e: new_pwd[0].focus())\n\n            new_pwd[0].set_event_handler(\"pressed_enter\", lambda **e: new_pwd[1].focus())\n            new_pwd[1].set_event_handler(\"pressed_enter\", lambda **e: panel.raise_event(\"x-close-alert\", value=True))\n\n            panel.add_component(new_pwd[0])\n            panel.add_component(new_pwd[1])\n\n            if err:\n                panel.add_component(Label(text=err, foreground=\"red\"))\n\n            r = alert(panel, title=\"Change password\" if require_old_password else \"Reset password\", buttons=[(\"Change\" if require_old_password else \"Reset\", True, \"success\"), (\"Cancel\", False, \"default\")], dismissible=True)\n\n            if r:\n                if new_pwd[0].text == new_pwd[1].text:\n                    try:\n                        # Reset password for the currently logged-in user\n                        reset_password(old_pwd.text, new_pwd[0].text)\n                        return\n                    except AuthenticationFailed as e:\n                        err = str(e.args[0])\n                    except PasswordNotAcceptable as e:\n                        err = str(e.args[0])\n                else:\n                    err = \"Passwords do not match\"\n            else:\n                anvil.server.call(\"anvil.private.users.cancel_password_reset\")\n                return\n\n\n    #!defFunction(anvil.users,_)!2: \"Display a form allowing the current user to configure their account. The form contains links for password reset and two-factor authentication configuration.\" [\"configure_account_with_form\"]\n    def configure_account_with_form():\n\n        if not get_user():\n            raise Exception(\"Cannot configure user account: Not logged in.\")\n\n        while True:\n            panel = LinearPanel()\n\n            reset_password_link = Link(text=\"Change password\")\n            configure_mfa_link = Link(text=\"Configure two-factor authentication\")\n\n            reset_password_link.set_event_handler(\"click\", lambda **e: panel.raise_event(\"x-close-alert\", value=\"reset_password\"))\n            configure_mfa_link.set_event_handler(\"click\", lambda **e: panel.raise_event(\"x-close-alert\", value=\"configure_mfa\"))\n\n            panel.add_component(reset_password_link)\n            panel.add_component(configure_mfa_link)\n\n            choice = alert(panel, title=\"Configure Account\", buttons=[(\"Done\", None, \"success\")], dismissible=True)\n\n            if choice == \"reset_password\":\n                change_password_with_form()\n            elif choice == \"configure_mfa\":\n                mfa.configure_mfa_with_form(True)\n            else:\n                break\n";Sk.builtinFiles.files["anvil-services\/anvil\/users\/exceptions.py"] = "import anvil.server\n\n#!defClass(anvil.users,UserExists)!:\nclass UserExists(anvil.server.AnvilWrappedError):\n    pass\n\n\n#!defClass(anvil.users,AuthenticationFailed)!:\nclass AuthenticationFailed(anvil.server.AnvilWrappedError):\n    pass\n\n\n#!defClass(anvil.users,EmailNotConfirmed)!:\nclass EmailNotConfirmed(AuthenticationFailed):\n    pass\n\n\n#!defClass(anvil.users,AccountIsNotEnabled)!:\nclass AccountIsNotEnabled(AuthenticationFailed):\n    pass\n\n\n#!defClass(anvil.users,TooManyPasswordFailures)!:\nclass TooManyPasswordFailures(AuthenticationFailed):\n    pass\n\n\n#!defClass(anvil.users,PasswordNotAcceptable)!:\nclass PasswordNotAcceptable(anvil.server.AnvilWrappedError):\n    pass\n\n#!defClass(anvil.users,MFARequired)!:\nclass MFARequired(AuthenticationFailed):\n    pass\n\n#!defClass(anvil.users,MFAException)!:\nclass MFAException(AuthenticationFailed):\n    pass\n\n#!defClass(anvil.users,PasswordResetRequested)!:\nclass PasswordResetRequested(anvil.server.AnvilWrappedError):\n    pass\n\n";Sk.builtinFiles.files["anvil-services\/anvil\/users\/google_button.py"] = "import anvil\nimport anvil.js\nimport anvil.server\n\n\norigin = anvil.server.get_app_origin() or \"\"\n\n\nclass GoogleSignInButton(anvil.HtmlTemplate):\n    _loaded = False\n    _path = (\n        origin\n        + \"\/_\/static\/runtime\/img\/google-signin-buttons\/btn.js?sha=277762afd28c6a94830\"\n    )\n\n    @classmethod\n    def load_component(cls):\n        if cls._loaded:\n            return\n        cls._loaded = True\n        document = anvil.js.window.document\n        s = document.createElement(\"script\")\n        s.src = cls._path\n        document.head.append(s)\n\n    def __init__(self, text=\"Sign in with Google\"):\n        self.load_component()\n        anvil.HtmlTemplate.__init__(self, html=\"<google-signin-button>\" + text)\n";Sk.builtinFiles.files["anvil-services\/anvil\/users\/mfa\/__init__.py"] = "import anvil.server\nfrom anvil import *\nfrom ..exceptions import AuthenticationFailed, MFAException\nfrom ..config import get_client_config\nfrom anvil.js import window\n\n\ndef _replace(s, pattern, replacement):\n    return window.String.prototype.replace.call(s, window.RegExp(pattern, \"g\"), replacement)\n\n\nclass PhoneNumberValidator(object):\n    def __init__(self, **properties):\n        self.box = pluggable_ui['anvil.TextBox'](type=\"tel\", **properties)\n        self.valid_number = None\n        self.box.add_event_handler(\"focus\", self.on_focus)\n        self.box.add_event_handler(\"lost_focus\", self.on_blur)\n        self.box.add_event_handler(\"pressed_enter\", self.on_blur)\n\n    def on_focus(self, **e):\n        if hasattr(self.box, \"placeholder\"):\n            self.box.placeholder = \"(123) 456 7890\" if window.navigator.language == \"en-US\" else \"+1 000 0...\"\n\n    def on_blur(self, **e):\n        self.validate()\n\n    def validate(self):\n        leadingPlus = self.box.text.startswith(\"+\")\n        text = self.box.text = _replace(self.box.text, \"[^0-9]\", \"\")\n        if leadingPlus:\n            if len(text) > 3: # What's a valid minimum length?\n                self.box.text = \"+\" + text\n                self.valid_number = text\n            else:\n                self.valid_number = None\n        else:\n            if len(text) == 10:\n                self.valid_number = \"+1\" + text\n                self.box.text = \"(\" + text[0:3] + \") \" + text[3:6] + \" \" + text[6:]\n            else:\n                self.valid_number = None\n        \n\n\n#!defFunction(anvil.users,_,email_address)!2: \"Send a two-factor authentication reset email to the specified user.\" [\"send_mfa_reset_email\"]\ndef send_mfa_reset_email(email):\n    anvil.server.call(\"anvil.private.users.send_mfa_reset_email\", email)\nif is_server_side():\n    pass\nelse:\n    from . import webauthn\n\n    #!defFunction(anvil.users.mfa,_,email_address)!2: \"Generate a WebAuthn challenge that can be used to register a new hardware token for two-factor authentication.\" [\"create_fido_mfa_method\"]\n    def create_fido_mfa_method(email):\n        opts = anvil.server.call(\"anvil.private.users.begin_fido_attestation\", email)\n        result = webauthn.create(opts)\n        if result:\n            return anvil.server.call(\"anvil.private.users.validate_fido_attestation\", result)\n\n    #!defFunction(anvil.users.mfa,_,email_address,password)!2: \"Generate a WebAuthn challenge that the given user can use to log in with a previously registered hardware token.\" [\"get_fido_mfa_login\"]\n    def get_fido_mfa_login(email, password):\n        opts = anvil.server.call(\"anvil.private.users.begin_fido_assertion\", email, password)\n        result = webauthn.get(opts)\n        if result:\n            return {\"type\": 'fido', \"result\": result}\n\n    #!defFunction(anvil.users.mfa,_,code)!2: \"Get an MFA login object representing a TOTP login code. This can be passed to the login_with_email function as the mfa argument.\" [\"get_totp_mfa_login\"]\n    def get_totp_mfa_login(code):\n        return {\"type\": \"totp\", \"code\": code}\n\n    #!defFunction(anvil.users.mfa,_,code)!2: \"Get an MFA login object representing a Twilio Verify token. This can be passed to the login_with_email function as the mfa argument.\" [\"get_twilio_mfa_login\"]\n    def get_twilio_mfa_login(code):\n        return {\"type\": \"twilio-verify\", \"code\": code}\n\n    #!defFunction(anvil.users.mfa,_,email_address)!2: \"Generate a TOTP secret that can be added as two-factor authentication for the current user.\" [\"generate_totp_secret\"]\n    def generate_totp_secret(email):\n        return anvil.server.call(\"anvil.private.users.totp.generate_secret\", email)\n\n    #!defFunction(anvil.users.mfa,_,mfa_method,code)!2: \"Validate the given TOTP code against the given MFA method from a User row.\" [\"validate_totp_code\"]\n    def validate_totp_code(mfa_method, code):\n        return anvil.server.call(\"anvil.private.users.totp.validate_code\", mfa_method, code)\n\n    #!defFunction(anvil.users.mfa,_,phone)!2: \"Generate a Twilio MFA method from the provided phone number.\" [\"generate_twilio_mfa_method\"]\n    def generate_twilio_mfa_method(phone):\n        return anvil.server.call(\"anvil.private.users.twilio.generate_mfa_method\", phone)\n\n    #!defFunction(anvil.users.mfa,_, mfa_method, channel)!2: \"Send a Twilio Verify token using the given MFA method from a User row.\" [\"send_twilio_token\"]\n    def send_twilio_token(mfa_method, channel):\n        return anvil.server.call(\"anvil.private.users.twilio.send_verification_token\", mfa_method, channel)\n\n    #!defFunction(anvil.users.mfa,_, mfa_method, token)!2: \"Validate the given Twilio Verify token against the given MFA method from a User row.\" [\"check_twilio_token\"]\n    def check_twilio_token(mfa_method, token):\n        return anvil.server.call(\"anvil.private.users.twilio.check_verification_token\", mfa_method, token)\n\n    #!defFunction(anvil.users.mfa,_,password,mfa_method,[clear_existing=False])!2: \"Add an MFA method to the current user by passing the user's password and the mfa method, optionally clearing all existing methods.\" [\"add_mfa_method\"]\n    def add_mfa_method(password, method, clear_existing=False):\n        return anvil.server.call(\"anvil.private.users.add_mfa_method\", password, method, clear_existing)\n\n    #!defFunction(anvil.users.mfa,_,email_address,password)!2: \"Get the available MFA types for the given user by passing their email and password.\" [\"get_available_mfa_types\"]\n    def get_available_mfa_types(email, password):\n        return anvil.server.call(\"anvil.private.users.get_available_mfa_types\", email, password)\n\n    #!defFunction(anvil.users.mfa,_)!2: \"Get all the enabled MFA types for this app.\" [\"get_enabled_mfa_types\"]\n    def get_enabled_mfa_types():\n        return anvil.server.call(\"anvil.private.users.get_enabled_mfa_types\")\n\n    def _configure_mfa(email, mfa_error, require_password, allow_cancel, confirm_button_text):\n        TextBox = pluggable_ui['anvil.TextBox']\n        \n        mfa_types = get_enabled_mfa_types()\n        selected_mfa_type = None\n        mfa_methods = {}\n        password_error = None\n        password_box = TextBox(placeholder=\"Current password\", align=\"center\", hide_text=True)\n\n        while True:\n            mfa_panel = LinearPanel()\n\n            if require_password and not password_box.text:\n                password_box.remove_from_parent()\n                mfa_panel.add_component(password_box)\n                if password_error:\n                    mfa_panel.add_component(Label(foreground=\"red\", align=\"center\", spacing_below=\"none\", text=password_error))\n\n            if not selected_mfa_type:\n\n                mfa_panel.add_component(Label(text=\"This app requires 2-factor authentication to log in.\"))\n\n\n                if \"fido\" in mfa_types:\n                    def signup_with_fido(**e):\n                        result = create_fido_mfa_method(email)\n                        if result:\n                            mfa_methods['fido'] = result\n                            mfa_panel.raise_event(\"x-close-alert\", value='fido')\n\n                    if webauthn.is_webauthn_available():\n                        fido_link = Link(text=\"Use hardware token\",icon=\"fa:lock\")\n                        fido_link.set_event_handler(\"click\", signup_with_fido)\n                        mfa_panel.add_component(fido_link)\n                    else:\n                        mfa_panel.add_component(Label(text=\"Hardware token unavailable\", icon=\"fa:lock\", tooltip=\"Is this page running in an iframe or an unsupported browser?\"))\n\n                if \"totp\" in mfa_types:\n                    totp_link = Link(text=\"Use Authenticator app\", icon=\"fa:qrcode\")\n                    totp_link.set_event_handler(\"click\", lambda **e: mfa_panel.raise_event(\"x-close-alert\", value='select-totp'))\n                    mfa_panel.add_component(totp_link)\n\n                if \"twilio-verify\" in mfa_types:\n                    twilio_link = Link(text=\"Use phone number\", icon=\"fa:phone\")\n                    twilio_link.set_event_handler(\"click\", lambda **e: mfa_panel.raise_event(\"x-close-alert\", value='select-twilio'))\n                    mfa_panel.add_component(twilio_link)\n\n            else:\n                back_link = Link(text=\"Choose another method\", icon=\"fa:arrow-left\")\n                back_link.set_event_handler(\"click\", lambda **e: mfa_panel.raise_event(\"x-close-alert\", value='back'))\n                mfa_panel.add_component(back_link)\n\n                if selected_mfa_type == \"totp\":\n                    totp_config = generate_totp_secret(email)\n                    totp_secret = totp_config['secret']\n                    qr_code = totp_config['qr_code']\n                    mfa_methods['totp'] = totp_config['mfa_method']\n\n                    mfa_panel.add_component(Label(text=\"Scan this QR-code with your Authenticator app and then enter the current code below to continue.\"))\n                    mfa_panel.add_component(Image(source=qr_code, display_mode=\"fill_width\"))\n\n                    totp_box = TextBox(placeholder=\"Enter 6-digit code\", align=\"center\", font=\"monospace\")\n                    totp_box.set_event_handler(\"show\", lambda **e: totp_box.focus())\n                    totp_box.set_event_handler(\"pressed_enter\", lambda **e: mfa_panel.raise_event(\"x-close-alert\"))\n                    mfa_panel.add_component(totp_box)\n\n                elif selected_mfa_type == \"twilio-verify\":\n                    if not mfa_methods.get('twilio-verify'):\n                        phone_box = PhoneNumberValidator(placeholder=\"Enter your phone number\", align=\"center\")\n                        phone_box.box.add_event_handler(\"pressed_enter\", lambda **e: mfa_panel.raise_event(\"x-close-alert\"))\n                        #phone_box.box.add_event_handler(\"lost_focus\", lambda **e: print(phone_box.valid_number))\n                        #mfa_panel.add_component(Label(text=\"Enter your phone number\", align=\"center\"))\n                        mfa_panel.add_component(phone_box.box)\n                    else:\n                        twilio_box = TextBox(placeholder=\"Enter 6-digit code\", align=\"center\", font=\"monospace\")\n                        twilio_box.set_event_handler(\"pressed_enter\", lambda **e: mfa_panel.raise_event(\"x-close-alert\"))\n                        twilio_box.set_event_handler(\"show\", lambda **e: twilio_box.focus())\n                        mfa_panel.add_component(twilio_box)                            \n\n                        sms_link = Link(text=\"Resend Text Message\", icon=\"fa:commenting-o\")\n                        phone_link = Link(text=\"Call Me instead\", icon=\"fa:phone\")\n                        sms_link.set_event_handler(\"click\", lambda **e: mfa_panel.raise_event(\"x-close-alert\", value='resend-sms'))\n                        phone_link.set_event_handler(\"click\", lambda **e: mfa_panel.raise_event(\"x-close-alert\", value='call'))\n                        mfa_panel.add_component(sms_link)\n                        mfa_panel.add_component(phone_link)\n\n            if mfa_error:\n                mfa_panel.add_component(Label(foreground=\"red\", bold=True, spacing_below=\"none\", text=mfa_error))\n\n            maybe_cancel_button = [(\"Cancel\", 'cancel')] if allow_cancel else []\n            m = alert(mfa_panel, title=\"2-Factor Authentication\", buttons=[(confirm_button_text, True, 'success')] + maybe_cancel_button, dismissible=bool(allow_cancel))\n            if m == 'cancel':\n                return None, \"\"\n            elif require_password and not password_box.text: # TODO: Also validate password\n                password_error = \"Please enter your password\"\n            elif m == 'back':\n                selected_mfa_type = None\n                mfa_error = None\n            elif m == 'select-totp':\n                mfa_error = None\n                mfa_methods['totp'] = None\n                selected_mfa_type = 'totp'\n            elif m == 'select-twilio':\n                mfa_error = None\n                mfa_methods['twilio-verify'] = None\n                selected_mfa_type = 'twilio-verify'\n            elif m == 'fido':\n                # fido is a single step process - we're done\n                return mfa_methods['fido'], password_box.text\n\n            elif selected_mfa_type == 'totp':\n                if validate_totp_code(mfa_methods['totp'], totp_box.text):\n                    return mfa_methods['totp'], password_box.text\n                else:\n                    mfa_error = \"Incorrect code entered. Please try again.\"\n            elif selected_mfa_type == 'twilio-verify':\n                mfa_error = None\n                if m == 'resend-sms':\n                    channel = \"sms\"\n                    mfa_methods['twilio-verify'] = None\n                    mfa_error = \"Text message resent\"\n                elif m == 'call':\n                    channel = \"call\"\n                    mfa_methods['twilio-verify'] = None\n                    mfa_error = \"Calling you now\"\n                else:\n                    channel = \"sms\"\n\n                if not mfa_methods.get('twilio-verify'):\n                    if phone_box.valid_number:\n                        mfa_methods['twilio-verify'] = generate_twilio_mfa_method(phone_box.valid_number)\n                        try:\n                            send_twilio_token(mfa_methods['twilio-verify'], channel)\n                        except MFAException as e:\n                            mfa_error = e.message\n                    else:\n                        mfa_error = \"Please enter a valid phone number.\"\n                else:\n                    if check_twilio_token(mfa_methods['twilio-verify'], twilio_box.text):\n                        return mfa_methods['twilio-verify'], password_box.text\n                    else:\n                        mfa_error = \"Incorrect code entered. Please try again.\"\n            else:\n                mfa_error = None\n\n\n    #!defFunction(anvil.users.mfa,!,email_address, password)!2: \"Display a form to collect two-factor authentication credentials from the user currently logging in by passing the function their email and password.\" [\"mfa_login_with_form\"]\n    def mfa_login_with_form(email, password):\n        TextBox = pluggable_ui['anvil.TextBox']\n\n        mfa_panel = LinearPanel()\n\n        mfa_types = get_available_mfa_types(email, password)\n\n        maybe_login_button = []\n\n        error_label = Label(foreground=\"red\", bold=True, spacing_below=\"none\",visible=False)\n        mfa_panel.add_component(error_label)\n        def error(text):\n            error_label.text = text\n            error_label.visible = True\n\n        def clear_error():\n            error_label.visible = False\n            error_label.text = \"\"\n        \n        if 'totp' in mfa_types:\n            totp_box = TextBox(placeholder=\"Enter 6-digit code\", align=\"center\", font=\"monospace\")\n            totp_box.set_event_handler(\"pressed_enter\", lambda **e: mfa_panel.raise_event('x-close-alert', value=get_totp_mfa_login(totp_box.text)))\n            totp_box.set_event_handler(\"show\", lambda **e: totp_box.focus())\n            mfa_panel.add_component(Label(text=\"Please enter the 2-factor authentication code from your Authenticator app\"))\n            mfa_panel.add_component(totp_box)\n            maybe_login_button = [(\"Log In\", 'totp', 'success')]\n\n        if 'fido' in mfa_types:\n            def use_fido(**e):\n                val = get_fido_mfa_login(email, password)\n                if val:\n                    mfa_panel.raise_event(\"x-close-alert\", value=val)\n\n            \n            if webauthn.is_webauthn_available():\n                fido_link = Link(text=\"Use hardware token\", icon=\"fa:lock\")\n                fido_link.set_event_handler(\"click\", use_fido)\n                mfa_panel.add_component(fido_link)\n            else:\n                mfa_panel.add_component(Label(text=\"Hardware token unavailable\", icon=\"fa:lock\", tooltip=\"Is this page running in an iframe or an unsupported browser?\"))\n\n        if 'twilio-verify' in mfa_types:\n            \n            def use_phone(**e):\n                error(\"Calling you now\")\n                try:\n                    send_twilio_token(None, \"call\")\n                except MFAException as e:\n                    error(e.message)\n            def use_sms(display_sent=True, **e):\n                if display_sent:\n                    error(\"Text message resent\")\n                try:\n                    send_twilio_token(None, \"sms\")\n                except MFAException as e:\n                    error(e.message)\n\n            use_sms(False)\n\n            twilio_box = TextBox(placeholder=\"Enter 6-digit code\", align=\"center\", font=\"monospace\")\n            twilio_box.set_event_handler(\"pressed_enter\", lambda **e: mfa_panel.raise_event('x-close-alert', value=get_twilio_mfa_login(twilio_box.text)))\n            twilio_box.set_event_handler(\"show\", lambda **e: twilio_box.focus())\n            mfa_panel.add_component(Label(text=\"Please enter the 6-digit code we sent to the phone number we have on file\"))\n            mfa_panel.add_component(twilio_box)\n\n            sms_link = Link(text=\"Resend Text Message\", icon=\"fa:commenting-o\")\n            phone_link = Link(text=\"Call Me instead\", icon=\"fa:phone\")\n            sms_link.set_event_handler(\"click\", use_sms)\n            phone_link.set_event_handler(\"click\", use_phone)\n            mfa_panel.add_component(sms_link)\n            mfa_panel.add_component(phone_link)\n\n            maybe_login_button = [(\"Log In\", 'twilio', 'success')]\n\n\n\n        if not mfa_types:\n            mfa_panel.add_component(Label(text=\"No authentication methods available.\"))\n\n        if not mfa_types or get_client_config().get(\"allow_mfa_email_reset\", False):\n            mfa_reset_link = Link(text=\"Reset 2-factor authentication by email\")\n            mfa_reset_link.set_event_handler('click', lambda **e: mfa_panel.raise_event('x-close-alert', value='reset_mfa'))\n            mfa_panel.add_component(mfa_reset_link)\n\n        r = alert(mfa_panel, title=\"2-Factor Authentication\", buttons=maybe_login_button + [(\"Cancel\", None, 'default')], dismissible=False)\n\n        if r == 'totp':\n            return get_totp_mfa_login(totp_box.text)\n        elif r == 'twilio':\n            return get_twilio_mfa_login(twilio_box.text)\n        else:\n            return r\n\n\n    #!defFunction(anvil.users.mfa,!,[allow_cancel=False])!2: \"Display a form for the user to configure 2-factor authentication.\\n\\nallow_cancel: if True, the signup form has a Cancel button that the user can use to dismiss the form.\" [\"configure_mfa_with_form\"]\n    def configure_mfa_with_form(allow_cancel=False):\n\n        error = None\n        while True:\n            mfa_method, password = _configure_mfa(None, error, True, allow_cancel, \"Save\")\n\n            if mfa_method:\n                try:\n                    add_mfa_method(password, mfa_method)\n                    alert(\"Your two-factor authentication configuration has been reset.\")\n                    return True\n                except AuthenticationFailed as e:\n                    error = e.args[0]\n                except Exception as e:\n                    error = str(e)\n            else:\n                return None\n";Sk.builtinFiles.files["anvil-services\/anvil\/users\/mfa\/webauthn.js"] = "\nvar $builtinmodule = window.memoise('anvil.users.mfa.webauthn', function() {\n    var mod = {};\n\n    let getCredentials = function() {\n        if (navigator.credentials) {\n            return navigator.credentials;\n        } else {\n            if (window.anvilParams && window.anvilParams.inIDE) {\n                throw new Sk.builtin.Exception(\"Cannot use hardware token authentication in the Anvil Editor - visit the app URL directly to test two-factor authentication.\");\n            } else {\n                throw new Sk.builtin.Exception(\"Cannot use hardware token authentication here - is the app running in a cross-origin iframe?\");\n            }\n        }\n    };\n\n    mod[\"is_webauthn_available\"] = new Sk.builtin.func(function() {\n        return !!navigator.credentials;\n    });\n\n    mod[\"create\"] = new Sk.builtin.func(function(pyOptions) {\n        var options = Sk.ffi.toJs(pyOptions);\n\n        options.publicKey.challenge = base64DecToArr(options.publicKey.challenge);\n        options.publicKey.user.id = base64DecToArr(options.publicKey.user.id);\n\n        return PyDefUtils.suspensionFromPromise(getCredentials().create(options).then(function(r) {\n            return Sk.ffi.toPy({\n                attestationObject: base64EncArr(new Uint8Array(r.response.attestationObject)),\n                clientDataJSON: base64EncArr(new Uint8Array(r.response.clientDataJSON)),\n            });\n        }).catch(function(e) {\n            \/\/ TODO debug for Bridget\n            console.log(\"webauthn failed\/cancelled:\", e);\n            return Sk.ffi.toPy(null);\n        }));\n    });\n\n    mod[\"get\"] = new Sk.builtin.func(function(pyOptions) {\n        var options = Sk.ffi.toJs(pyOptions);\n\n        options.publicKey.challenge = base64DecToArr(options.publicKey.challenge);\n        for (var i in options.publicKey.allowCredentials) {\n            options.publicKey.allowCredentials[i].id = base64DecToArr(options.publicKey.allowCredentials[i].id);\n        }\n\n        return PyDefUtils.suspensionFromPromise(getCredentials().get(options).then(function(r) {\n            return Sk.ffi.toPy({\n                authenticatorData: base64EncArr(new Uint8Array(r.response.authenticatorData)),\n                clientDataJSON: base64EncArr(new Uint8Array(r.response.clientDataJSON)),\n                signature: base64EncArr(new Uint8Array(r.response.signature)),\n            });\n        }).catch(function(e) {\n            return Sk.ffi.toPy(null);\n        }));\n    });\n\n\n    return mod;\n});";Sk.builtinFiles.files["anvil-services\/anvil\/users\/config.py"] = "import anvil\n\n_config = None\n\ndef get_client_config():\n    global _config\n    if _config is None:\n        _config = anvil._get_service_client_config(\"\/runtime\/services\/anvil\/users.yml\")\n    return _config\n";const loadApp = window.loadApp({"app":{"allow_embedding":false,"dependency_code":{},"package_name":"Connect4_Team","config":{"client":{}},"modules":[],"name":"Connect4_Team","dependency_ids":{},"startup_form":"Form1","dependency_order":[],"theme":{"html":{"standard-page.html":"<link href=\"https:\/\/fonts.googleapis.com\/css?family=Roboto:300,400,500\" rel=\"stylesheet\" rel=\"preload\" as=\"font\" crossorigin=\"anonymous\">\r\n\r\n<div class=\"structure\">\r\n  <div class=\"app-bar\" anvil-drop-container=\".anvil-container\" anvil-drop-redirect=\".placeholder\">\r\n    <a class=\"sidebar-toggle\" anvil-if-slot-empty=\"top-left-btn\" anvil-hide-if-slot-empty=\"left-nav\" anvil-drop-slot=\"top-left-btn\" href=\"javascript:void(0)\"><i class=\"fa fa-bars\"><\/i><\/a>\r\n    <a class=\"sidebar-toggle anvil-designer-only\" anvil-if-slot-empty=\"top-left-btn\" anvil-if-slot-empty=\"left-nav\" anvil-drop-slot=\"top-left-btn\"><i class=\"fa fa-blank\"><\/i><\/a>\r\n    <div class=\"top-left-btn\" anvil-slot=\"top-left-btn\"><\/div>\r\n    <div class=\"title\" anvil-slot=\"title\">\r\n      <div class=\"placeholder anvil-designer-only\" anvil-if-slot-empty=\"title\" anvil-drop-here>Drop title here<\/div>\r\n    <\/div>\r\n    <div class=\"app-bar-nav\" anvil-slot=\"nav-right\">\r\n      <div class=\"placeholder anvil-designer-only\" anvil-if-slot-empty=\"nav-right\" anvil-drop-here>Drop a FlowPanel here<\/div>\r\n    <\/div>\r\n    <div style=\"clear:both\"><\/div>\r\n  <\/div>\r\n\r\n  <div class=\"nav-holder\">\r\n    <div class=\"left-nav anvil-measure-this\" anvil-slot-repeat=\"left-nav\" anvil-drop-container=\">.anvil-container\">\r\n    <\/div>\r\n    <div class=\"left-nav-placeholder anvil-designer-only\" anvil-if-slot-empty=\"left-nav\" anvil-drop-slot=\"left-nav\">\r\n      <div class=\"prompt\">To add a sidebar, drop a ColumnPanel here.<\/div>\r\n    <\/div>\r\n    \r\n    <div class=\"content\">\r\n      <div anvil-slot-repeat=\"default\" class=\"anvil-measure-this\"><\/div>\r\n      <div class=\"placeholder drop-here\" anvil-if-slot-empty=\"default\" anvil-drop-slot=\"default\">Drop a ColumnPanel here.<\/div>\r\n    <\/div>\r\n  <\/div>\r\n\r\n  <div class=\"nav-shield\"><\/div>\r\n<\/div>\r\n<div anvil-drop-default anvil-drop-redirect=\".placeholder\" anvil-drop-container=\".anvil-container\"><\/div>\r\n \r\n<script>\r\n  var ln = $('.structure > .nav-holder > .left-nav');\r\n  var lnp = $('.structure > .nav-holder > .left-nav-placeholder');\r\n  var appBar = $('.app-bar')[0];\r\n  \r\n  function hideSidebar() {\r\n    ln.animate({left: -ln.outerWidth()}, function() {\r\n      ln.removeClass(\"in-transition shown\").addClass(\"hidden\");\r\n      $('.nav-shield').removeClass(\"shown\");\r\n      $(window).trigger('resize');\r\n    });\r\n    if (window.innerWidth > 998) { \r\n      $('.content').animate({'margin-left':0}, function(){})\r\n    }\r\n  }\r\n  \r\n  function showSidebar() {\r\n    $('.nav-shield').addClass(\"shown\");\r\n    ln.addClass(\"shown\").removeClass(\"hidden\").css({left: \"-100%\"}).css({left: -ln.outerWidth()}).animate({left: 0}, function() {\r\n      ln.removeClass(\"in-transition\");\r\n    });\r\n    $(window).trigger('resize');\r\n    if (window.innerWidth > 998) {\r\n      $('.content').animate({'margin-left': ln.outerWidth().toString() + 'px'}, function(){})\r\n    } \r\n  }\r\n  \r\n  $('.sidebar-toggle, .nav-shield').off('click').on('click', function() { \r\n    if (ln.is(\":visible\") || $('.nav-shield').is(\".shown\")) {\r\n      hideSidebar();\r\n    } else if(!ln.is(\":empty\")) {\r\n      showSidebar();\r\n    }\r\n  });\r\n  $('.left-nav').off('click').on('click', 'a, button', function() {\r\n    if ($('.nav-shield').is(\":visible\")) {\r\n      $('.nav-shield').trigger('click');\r\n    }\r\n  });\r\n  \r\n  document.addEventListener('scroll', function() {\r\n    if (appBar.classList.contains('scrolled')) {\r\n      if (window.scrollY === 0) {\r\n        appBar.classList.remove('scrolled')\r\n      }\r\n    }\r\n    else {\r\n      appBar.classList.add('scrolled')\r\n    }\r\n  });\r\n\r\n  function addMarginToContent() {\r\n    \/\/check if there is a free banner and set the top margin accordiningly\r\n    let topMargin;\r\n    if ($('#anvil-header').css('display') == 'block') {\r\n      topMargin = appBar.clientHeight + 50\r\n    } else {\r\n      topMargin = appBar.clientHeight\r\n    }\r\n    \/\/the left-nav-placeholder in the designer needs to shift down for the app bar\r\n    lnp.css({'top': appBar.clientHeight.toString() + 'px'})\r\n\r\n    \/\/if the window is small\r\n    if (window.innerWidth < 999) {\r\n      \/\/if in Anvil designer\r\n      if (window.anvilInDesigner) {\r\n        \/\/add left margin to content to make room for left-nav or left-nav-placeholder\r\n        $('.content').css({'margin-left': Math.max(ln.outerWidth(), lnp.outerWidth()).toString() + 'px'});\r\n        $('.content').css({'margin-top': appBar.clientHeight.toString() + 'px'})\r\n        ln.css({'top': topMargin.toString() + 'px'})\r\n      } else {\r\n        \/\/if not in Anvil designer, content gets no left margin because left-nav will be a modal overlay\r\n        $('.content').css({'margin-left': '0px'});\r\n        ln.css({'top': '0px'})\r\n        \/\/add top margin to content\r\n        $('.content').css({'margin-top': topMargin.toString() + 'px'});\r\n      }\r\n    } else {\r\n      \/\/if the window is big, add margin to content and left-nav for app bar\r\n      $('.content').css({'margin-top': appBar.clientHeight.toString() + 'px'});\r\n      ln.css({'top': topMargin.toString() + 'px'})\r\n      if (window.anvilInDesigner) {\r\n        \/\/if in the designer, add left margin for either the left-nav or the placeholder\r\n        $('.content').css({'margin-left': Math.max(ln.outerWidth(), lnp.outerWidth()).toString() + 'px'});\r\n      } else {\r\n        \/\/if not in the designer, only add margin for the left-nav because placeholder still has a width outside of designer\r\n        $('.content').css({'margin-left': ln.outerWidth() + 'px'});\r\n      }\r\n    }\r\n  }\r\n  \r\n  addMarginToContent()\r\n  window.addEventListener('resize', addMarginToContent);\r\n \r\n<\/script>"},"color_scheme":{"Secondary Container":"#FFDBCF","Tertiary Container":"#F2E2A7","On Background":"#201A18","Disabled Container":"rgba(32, 26, 24, 0.12)","On Tertiary":"#FFFFFF","Outline":"#85736D","On Primary Container":"#380D00","Dark Overlay 2":"rgba(44, 22, 13, 0.12)","On Secondary":"#FFFFFF","On Secondary Container":"#2C160D","Primary Container":"#FFDBCF","Secondary":"#77574C","On Surface Variant":"#53433E","Surface Variant":"#F5DED6","Light Overlay 1":"rgba(255, 255, 255, 0.08)","Tertiary":"#695E2F","Light Overlay 2":"rgba(255, 255, 255, 0.12)","Primary Overlay 2":"rgba(154, 69, 35, 0.08)","Primary":"#9A4523","On Tertiary Container":"#221B00","Primary Overlay 3":"rgba(154, 69, 35, 0.11)","Primary Overlay 1":"rgba(154, 69, 35, 0.05)","On Surface":"#201A18","On Disabled":"rgba(32, 26, 24, 0.38)","Error":"#BA1A1A","Background":"#FFFBFF","Dark Overlay 1":"rgba(44, 22, 13, 0.08)","Surface":"#FFFBFF","On Primary":"#FFFFFF"},"vars":{"Secondary Container":"--anvil-color-Secondary-Container-f19c","Tertiary Container":"--anvil-color-Tertiary-Container-6be1","On Background":"--anvil-color-On-Background-3cff","Disabled Container":"--anvil-color-Disabled-Container-27f2","On Tertiary":"--anvil-color-On-Tertiary-5096","Outline":"--anvil-color-Outline-ee21","On Primary Container":"--anvil-color-On-Primary-Container-9a87","Dark Overlay 2":"--anvil-color-Dark-Overlay-2-36f7","On Secondary":"--anvil-color-On-Secondary-3a6e","On Secondary Container":"--anvil-color-On-Secondary-Container-2717","Primary Container":"--anvil-color-Primary-Container-3216","Secondary":"--anvil-color-Secondary-c7a9","On Surface Variant":"--anvil-color-On-Surface-Variant-7f9a","Surface Variant":"--anvil-color-Surface-Variant-c5a6","Light Overlay 1":"--anvil-color-Light-Overlay-1-bf28","Tertiary":"--anvil-color-Tertiary-0e91","Light Overlay 2":"--anvil-color-Light-Overlay-2-c245","Primary Overlay 2":"--anvil-color-Primary-Overlay-2-c8f1","Primary":"--anvil-color-Primary-6ee8","On Tertiary Container":"--anvil-color-On-Tertiary-Container-f7b2","Primary Overlay 3":"--anvil-color-Primary-Overlay-3-3ddf","Primary Overlay 1":"--anvil-color-Primary-Overlay-1-ea6d","On Surface":"--anvil-color-On-Surface-ee20","On Disabled":"--anvil-color-On-Disabled-f939","Error":"--anvil-color-Error-6b19","Background":"--anvil-color-Background-fb89","Dark Overlay 1":"--anvil-color-Dark-Overlay-1-6be4","Surface":"--anvil-color-Surface-70aa","On Primary":"--anvil-color-On-Primary-d4ad"}},"runtime_options":{"version":2,"client_version":"3"},"forms":[{"components":[{"components":[{"data_bindings":[],"layout_properties":{"col_xs":2,"row":"CGKZET","width_xs":8},"name":"image_1","properties":{"display_mode":"shrink_to_fit","height":243.2265625,"margin":[null,0,null,0],"source":"_\/theme\/WeChat441d8587f15252e8d0c39181204c2101.jpg","spacing_below":"large"},"type":"Image"},{"layout_properties":{"col_xs":5,"row":"JEZGKB","width_xs":2},"name":"label_1","properties":{"align":"center","background":"","bold":true,"font_size":22,"spacing_above":"small","spacing_below":"small","text":"Login"},"type":"Label"},{"layout_properties":{"col_xs":4,"row":"NXSEWE","width_xs":1},"name":"label_2","properties":{"bold":true,"font_size":15,"text":"Email:"},"type":"Label"},{"data_bindings":[{"code":"self.item['']","property":"text","writeback":false}],"event_bindings":{"pressed_enter":"email_box_pressed_enter"},"layout_properties":{"col_xs":5,"row":"NXSEWE","width_xs":2},"name":"email_box","properties":{"bold":false,"align":"left","placeholder":"\"Enter your email\"","spacing_above":"small","background":"theme:Primary Overlay 1","underline":false,"hide_text":false,"foreground":"","visible":true,"border":"none","italic":false,"enabled":true,"font_size":14,"text":"","margin":[null,0,null,null]},"type":"TextBox"},{"layout_properties":{"col_xs":4,"row":"MJQCAP","width_xs":1},"name":"label_3","properties":{"bold":true,"font_size":15,"text":"Password:"},"type":"Label"},{"data_bindings":[{"code":"self.item['']","property":"text","writeback":false}],"layout_properties":{"col_xs":5,"row":"MJQCAP","width_xs":2},"name":"password_box","properties":{"align":"left","placeholder":"\"Enter your password\"","background":"theme:Primary Overlay 1","hide_text":false,"foreground":"","visible":true,"border":"none","italic":false,"font_size":14,"text":""},"type":"TextBox"},{"event_bindings":{"click":"outlined_button_1_click"},"layout_properties":{"col_xs":4,"row":"EAQFIE","width_xs":3},"name":"outlined_button_1","properties":{"background":"theme:Outline","bold":true,"border":"","role":"filled-button","text":"Login"},"type":"Button"}],"layout_properties":{"slot":"default"},"name":"grid_panel_1","properties":{"spacing":{"padding":[null,null,null,29]}},"type":"GridPanel"},{"layout_properties":{"slot":"title"},"name":"label_4","properties":{"align":"left","bold":true,"font_size":30,"text":"Connect 4"},"type":"Label"},{"layout_properties":{"slot":"top-left-btn"},"name":"image_2","properties":{"height":"48.53125","source":"_\/theme\/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg"},"type":"Image"}],"container":{"data_bindings":[],"properties":{"foreground":"","html":"@theme:standard-page.html","visible":true},"type":"HtmlTemplate"},"is_package":true,"code":"from ._anvil_designer import Form1Template\nfrom anvil import *\nimport anvil.server\nimport anvil.users  # Ensure this is imported for user authentication\n\nclass Form1(Form1Template):\n    def __init__(self, **properties):\n        # Set Form properties and Data Bindings.\n        self.init_components(**properties)\n\n    def outlined_button_1_click(self, **event_args):\n      email = self.email_box.text\n      password = self.password_box.text\n      print(f\"Login attempt: email={email}, password={password}\")\n\n      try:\n        user = anvil.users.login_with_email(email, password)\n        print(f\"Login successful: {user}\")\n        open_form('Form2')  # Redirect to Form 2\n      except anvil.users.AuthenticationFailed:\n        print(\"Authentication failed\")\n        alert(\"Invalid login credentials. Please try again. Hint: Use Dan's credential\", title=\"Login Failed\")\n      except Exception as e:\n        print(f\"Unexpected error: {e}\")\n        alert(f\"An unexpected error occurred: {e}\", title=\"Error\")\n\n    def file_loader_1_change(self, file, **event_args):\n      \"\"\"This method is called when a new file is loaded into the FileLoader\"\"\"\n      if file:\n          # Dynamically display the uploaded image\n          self.image_1.source = file\n          \n          # Optional: Print the uploaded file name to the console\n          print(f\"Uploaded file name: {file.name}\")","class_name":"Form1","id":"F724WNMMPYZQNDN5PGKYC6Y2E5RZTVWQ"},{"components":[{"components":[{"layout_properties":{"grid_position":"UVLNQG,IQLBTL"},"name":"Title","properties":{"bold":true,"font_size":40,"text":"Connect 4 AI Bot: Full-Stack Development and Deployment"},"type":"Label"},{"layout_properties":{"grid_position":"VUSHFF,AYVBRK"},"name":"rich_text_14","properties":{"content":"**Group Members**: Kush Patel (ksp946), Shirley Liu(xl22445), Samuel Chen((swc872), Ronak Goyal (rg49395)","spacing_above":"large"},"type":"RichText"},{"components":[{"layout_properties":{"col_xs":0,"row":"VZRNFO","width_xs":11},"name":"rich_text_7_copy","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html","spacing_above":"none","spacing_below":"none"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"STXPIB","width_xs":4},"name":"Introduction","properties":{"bold":true,"font_size":30,"spacing_above":"small","text":"Introduction"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"FUQNEW","width_xs":11},"name":"label_1","properties":{"align":"left","font_size":14,"spacing_below":"none","text":"This project aimed to develop a full-stack application centered around building a Connect 4 AI bot. The core components of the project included:\n"},"type":"Label"},{"components":[{"name":"label_4","properties":{"spacing_above":"none","text":"The project required multiple iterations of data generation, model training, and front-end development to optimize performance and user experience."},"type":"Label"},{"components":[],"layout_properties":{},"name":"rich_text_7","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html","spacing_above":"none","spacing_below":"none"},"type":"RichText"}],"layout_properties":{"col_xs":0,"row":"FUQNEW","width_xs":11},"name":"rich_text_1","properties":{"content":"- Generating a large dataset of board positions and corresponding optimal moves using Monte Carlo Tree Search (MCTS).\n- Training a Convolutional Neural Network (CNN) and a Transformer model to play Connect 4.\n- Deploying the trained model using Docker and hosting it on AWS.\n- Developing a user-friendly interactive web application using Anvil for users to play against the bot.","spacing_above":"none","spacing_below":"none"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"LFZLBH","width_xs":12},"name":"Data_Generation","properties":{"bold":true,"font_size":30,"text":"Data Generation for Connect 4"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"MJRBSR","width_xs":11},"name":"label_2","properties":{"spacing_below":"none","text":"The dataset for training was created using Monte Carlo Tree Search (MCTS). This process involved having MCTS play against itself and recording board positions along with the best moves. Since MCTS is tunable, multiple iterations were conducted to balance skill level and dataset diversity.\n"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"ONDKIQ","width_xs":10},"name":"label_5","properties":{"bold":true,"font_size":20,"text":"Data Collection Strategy"},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"ONDKIQ","width_xs":11},"name":"rich_text_2","properties":{"content":"- Self-play with MCTS: MCTS played games against itself to generate optimal move recommendations.\n- Game State Recording: Only valid game states with optimal moves were stored.\n- Diversity Enhancement: Some games began with random moves before MCTS took over.\n- Dataset Growth: The dataset increased substantially over multiple iterations, ensuring robust training data for the model.","spacing_above":"none","spacing_below":"none"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"BZBDSK","width_xs":11},"name":"label_5_copy_2","properties":{"bold":true,"font_size":20,"spacing_below":"small","text":"Challenges and Iterations"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"VPETAW","width_xs":11},"name":"rich_text_2_copy","properties":{"content":"- Long runtime: Data generation required running overnight four times to accumulate sufficient board states. \n- Handling Duplicates: Since MCTS has randomness, the same board could appear with different move recommendations. A filtering strategy was used to select the most frequently recommended move.\n- Board Flipping Experiment: Attempts to train the model using flipped board representations for data augmentation did not yield improvements.\n- Final Dataset Size: The current dataset contains over 300,000 board states, ensuring a diverse and well-rounded training set.","spacing_above":"none","spacing_below":"none"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"NVURRI","width_xs":10},"name":"label_5_copy_2_copy","properties":{"bold":true,"font_size":20,"text":"Data Generation Code Snippet"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"SZQTWB","width_xs":7},"name":"image_2","properties":{"height":312.13671875,"horizontal_align":"left","source":"_\/theme\/Connect4\/Screenshot 2025-02-13 at 4.05.13\u202fPM.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"HXRVOU","width_xs":11},"name":"rich_text_7_copy_3","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html","spacing_above":"none","spacing_below":"none"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"FZRPPA","width_xs":7},"name":"Data_Combine","properties":{"bold":true,"font_size":30,"spacing_above":"small","text":"Combining Data Files"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"OJUBTW","width_xs":11},"name":"rich_text_3","properties":{"content":"Since data was generated in multiple iterations, separate datasets had to be combined and preprocessed. Below is the Code Snippet for Combining Datasets. ","spacing_below":"none"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"FGHYOY","width_xs":9},"name":"image_3","properties":{"height":214.46484375,"horizontal_align":"left","source":"_\/theme\/Connect4\/Screenshot 2025-02-13 at 4.14.32\u202fPM.png"},"type":"Image"},{"components":[],"layout_properties":{"col_xs":0,"row":"SMKOGO","width_xs":11},"name":"rich_text_7_copy_2","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html","spacing_above":"none","spacing_below":"none"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"HNWZER","width_xs":11},"name":"label_6","properties":{"bold":true,"font_size":30,"spacing_above":"small","text":"CNN Model for Connect 4"},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"GAFNYC","width_xs":11},"name":"rich_text_4","properties":{"content":"A Convolutional Neural Network (CNN) was trained to predict the best move given a board state."},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"UBWMCN","width_xs":11},"name":"label_7","properties":{"bold":true,"font_size":20,"spacing_above":"small","spacing_below":"small","text":"Optimized CNN Architecture"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"XEDHLW","width_xs":11},"name":"label_8","properties":{"spacing_below":"none","text":"The final CNN model was refined using deeper layers, batch normalization, and L2 regularization to improve generalization and performance."},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"ONRAHV","width_xs":11},"name":"label_7_copy","properties":{"bold":true,"font_size":20,"spacing_above":"small","spacing_below":"small","text":"CNN Model Breakdown"},"type":"Label"},{"data_bindings":[],"layout_properties":{"col_xs":0,"row":"LCNEVF","width_xs":11},"name":"rich_text_5","properties":{"content":"**1. Input Layer**: \n\n- The model accepts a (6,7,2) input shape, representing the game board state as two separate feature maps.\n\n**2. Convolutional Layers**:\n- The first Conv2D layer applies 64 filters of size (3,3) with ReLU activation and L2 regularization to capture spatial dependencies.\n- A BatchNormalization layer follows to standardize activations and improve convergence stability.\n- A second Conv2D layer with 128 filters further refines spatial feature extraction.\n- A MaxPooling2D layer (2x2) reduces spatial dimensions, improving computational efficiency and extracting dominant patterns.\n- A Dropout layer (0.3) prevents overfitting by randomly deactivating neurons during training.\n\n**3. Deeper Feature Extraction**:\n- A third Conv2D layer with 256 filters extends the feature hierarchy and improves representation power.\n- Another BatchNormalization ensures stable gradients during backpropagation.\n- The Flatten layer converts the feature maps into a 1D vector for classification.\n\n**4. Fully Connected Layers**:\n- A dense layer with 512 neurons, ReLU activation, and L2 regularization extracts high-level features.\n- A Dropout layer (0.4) prevents overfitting in deeper layers.\n- A second dense layer with 256 neurons enhances abstraction.\n- The final output layer uses a softmax activation to classify the optimal move among 7 columns.\n\n\n","spacing_below":"none"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"RMNOLY","width_xs":11},"name":"label_7_copy_copy","properties":{"bold":true,"font_size":20,"spacing_above":"small","spacing_below":"small","text":"Screenshot of CNN Model Code"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"OITHDC","width_xs":10},"name":"image_4","properties":{"display_mode":"shrink_to_fit","height":388.51953125,"horizontal_align":"left","source":"_\/theme\/Screenshot 2025-02-14 at 12.39.23\u202fAM.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"PLVTHC","width_xs":11},"name":"label_7_copy_copy_copy","properties":{"bold":true,"font_size":20,"spacing_above":"medium","spacing_below":"small","text":"Model Training and Optimization"},"type":"Label"},{"components":[{"components":[{"components":[],"name":"rich_text_8","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html"},"type":"RichText"}],"layout_properties":{},"name":"rich_text_6","properties":{"content":"Multiple iterations of CNN training were conducted:\n- **Deeper Architecture**: Additional convolutional layers were introduced to improve feature extraction.\n- **Regularization Techniques**: Used L2 regularization and dropout to prevent overfitting.\n- **Batch Normalization**: Improved stability and convergence.\n- **Early Stopping & Learning Rate Reduction**: Ensured efficient training without overfitting.\n\nThe model underwent multiple iterations of refinement and evaluation to achieve optimal performance. This process involved a structured approach encompassing model complexity adjustments, data quality enhancements, and logistical optimizations.\n\nInitially, we experimented with increasing model complexity by adjusting the number of hidden layers and assessing the impact on validation and test set performance. We systematically increased and decreased the number of layers to identify an optimal architecture that maximized predictive accuracy while avoiding overfitting.\n\nSubsequently, we focused on improving the quality of the training dataset. This involved preprocessing techniques such as board flipping and input normalization to enhance data consistency and representation, ensuring that the model learned robust patterns.\n\nTo address logistical challenges, we adjusted batch sizes to facilitate smoother gradient updates, thereby improving the model's convergence stability. Additionally, we performed hyperparameter tuning, specifically varying the learning rate within the range of 0.0005 to 0.01, to optimize training dynamics.\n\nFurthermore, we experimented with different optimization algorithms to enhance model performance. We compared the effectiveness of several optimizers, including Stochastic Gradient Descent (SGD) with momentum, Adam, AdaBoost, and standard SGD, ultimately selecting the approach that yielded the best results.\n\nThrough this iterative process, we systematically identified and resolved key challenges, leading to a refined and well-optimized model.\n"},"type":"RichText"}],"layout_properties":{"col_xs":0,"row":"DDYHXT","width_xs":11},"name":"rich_text_12","properties":{},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"CPIZUK","width_xs":11},"name":"label_9","properties":{"bold":true,"font_size":30,"spacing_above":"small","spacing_below":"small","text":"CNN Model Performance and Results"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"YDOBOM","width_xs":11},"name":"label_10","properties":{"bold":true,"font_size":20,"text":"Final CNN Model Performance"},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"SBDREO","width_xs":11},"name":"rich_text_10","properties":{"content":"- **Final Training Accuracy**: 74.2%\n- **Final Validation Accuracy**: 65.17%\n- **Error Analysis**: The model performed well in most cases, but struggled with edge-case scenarios, such as near-draw positions.\n\nFinal accuracy was evaluated based on move prediction and playing against MCTS. \n","font_size":14},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"SBDREO","width_xs":11},"name":"label_12","properties":{"bold":true,"font_size":20,"spacing_above":"medium","text":"CNN Performance Against Human Opponents"},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"DARWLA","width_xs":11},"name":"rich_text_11","properties":{"content":"After multiple iterations of model tuning and training, the CNN model was tested against a human player in an interactive Anvil web application. With a validation accuracy of 65.17%, the CNN model demonstrates strong performance in practical gameplay against human opponents, consistently winning against the human opponent in various test scenarios. It tends to set traps and forces the human opponent into unavoidable situations, positioning itself for a win.\n\nDuring testing, we found it challenging to defeat the AI. In most cases, the entire board needs to be filled before securing a win, highlighting the model\u2019s ability to prolong the game and create difficult situations for the opponent.\n\n","visible":true},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"DBQLNI","width_xs":7},"name":"image_5","properties":{"display_mode":"shrink_to_fit","height":339.25,"horizontal_align":"left","source":"_\/theme\/Connect4\/Screenshot 2025-02-14 at 2.00.55\u202fAM.png","spacing_above":"none"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"DHHXDR","width_xs":11},"name":"rich_text_8_copy","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"MYFTXN","width_xs":11},"name":"label_11","properties":{"bold":true,"font_size":30,"spacing_below":"small","text":"Transformer Model for Connect 4"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"LOPFAP","width_xs":11},"name":"label_13","properties":{"text":"The primary goal of using a Transformer-based architecture is to leverage self-attention mechanisms to capture complex dependencies between board states and optimal moves."},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"RMQFZX","width_xs":11},"name":"label_14","properties":{"bold":true,"font":"20","font_size":20,"text":"Transformer Architecture Explanation"},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"TBCFLH","width_xs":11},"name":"rich_text_9","properties":{"content":"**1. Input layer**\n- Accept a 6x7 board in 2 channels\n\n**2. Patch embedding**\n- Each board is processed through the patch embedding function to flatten the board into a one dimensional input as the patch\n\n**3. Class token generation**\n- Creates an class token (training weights) for the patch and concatenates the token embedding with the patch embedding\n\n**4. Transformer model construction**\n- For this model, we chose to use 4 layers (4 encoding blocks stacked)\n\n - For each layer, we feed our concatenated patch embeddings into the following layers:\n   - Layer normalization layer: normalizes values against d dimensions on the mean of the values of the patch\n\n   - Self attention layer: the self attention layer computes three different matrices: query, key, value. Using query x key as an output matrix, the model soft-maxes the matrix to scale all the values between 0 and 1. This effectively produces a space across the matrix that increases in intensity on values that matter by moving the values closer to 1. This process is done over n layers. Finally, the query-key matrix is multiplied by the value matrix to generate an output matrix\n   - We then add the output of the self-attention layer to the original patch embedding\n   - The concatenated patch embedding is fed through 2 more dense layers and 10% dropout layers. This is simply a standard neural network that takes in the self attention representation of the original patch embeddings and learns off of it to suggest the correct move, which is based on the self attention of the ideal board move provided by the MCTS algorithm\n   - The final output is a softmax of 7 different classes (moves), the highest probability of which is the selection for the best move\n\n**5. Model complexity overview**\n- In total our final model utilized 8 attention layers, running off of 4 attention heads. In total, we had 137k trainable parameters.\n\n\n\n\n\n\n\n"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"EISDWQ","width_xs":11},"name":"label_16","properties":{"bold":true,"font_size":20,"text":"Screenshot of Transformer Model Code"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"TDTHYL","width_xs":10},"name":"image_6","properties":{"height":690.36328125,"horizontal_align":"left","source":"_\/theme\/Connect4\/Transformer code.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"ARPSCT","width_xs":10},"name":"label_17","properties":{"bold":true,"font_size":20,"text":"Supplemental Code for Functions Referenced"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"CQSRGT","width_xs":10},"name":"image_7","properties":{"height":633.62890625,"horizontal_align":"left","source":"_\/theme\/Connect4\/Transformer code2.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"MSPDJO","width_xs":11},"name":"rich_text_13","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"MSPDJO","width_xs":11},"name":"label_15","properties":{"bold":true,"font_size":30,"text":"Transformer Performance and Results\n"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"SHCKDT","width_xs":11},"name":"label_18","properties":{"text":"After multiple rounds of training the transformer model performed considerably worse than the CNN. This makes sense since the highest testing accuracy we got was around 54%, much lower than the 65% accuracy from the strong CNN model.\n\nWhile we experimented with increasing the width and depth of the model, there was no significant improvement in the accuracy of the model.\n"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"UZDIDW","width_xs":10},"name":"image_8","properties":{"height":149.2890625,"horizontal_align":"left","source":"_\/theme\/Connect4\/image (3).png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"NYANOC","width_xs":7},"name":"label_19","properties":{"bold":true,"font_size":20,"text":"Final Transformer Model Performance"},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"HTGZNB","width_xs":11},"name":"rich_text_15","properties":{"content":"- **Final Training Accuracy**: 59.9%\n- **Final Validation Accuracy**: 54.3%\n- **Error Analysis**: The model struggled to perform against moderate level play"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"RNFIHD","width_xs":11},"name":"label_20","properties":{"bold":true,"font_size":20,"text":"Transformer Performance Against Human Opponents"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"KBHTBU","width_xs":11},"name":"label_21","properties":{"text":"The transformer model, with a validation accuracy of 54.3%, struggles in gameplay against human opponents. During testing, the Transformer model struggles significantly when the player takes the first move in the center column. Even when the player has three pieces in a row, the model often fails to recognize the imminent threat and does not respond well. The following examples illustrate these weaknesses.\n\n"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"QYOVAW","width_xs":5},"name":"image_9","properties":{"display_mode":"original_size","height":"239.11328125","horizontal_align":"left","source":"_\/theme\/Connect4\/Board1.png"},"type":"Image"},{"layout_properties":{"col_xs":6,"row":"QYOVAW","width_xs":5},"name":"image_10","properties":{"display_mode":"original_size","height":239.11328125,"horizontal_align":"left","source":"_\/theme\/Connect4\/Board2.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"HBDKTU","width_xs":11},"name":"rich_text_16","properties":{"content":"An interesting observation is that the 54.3% accuracy model performs almost as poorly as the Transformer model trained for only one epoch\u2014initially used to test the Docker upload\u2014which had a validation accuracy of just 28%, particularly in its early-game moves. This suggests that while the model\u2019s accuracy has nearly doubled, its actual gameplay performance remains weak. Notably, the player\u2019s experience does not improve significantly. \n\nSimilarly, when the Transformer model has an opportunity to win by placing a piece in a winning position, it often fails to make the correct move, as seen in the left image. However, in some cases, like in the right image, the Transformer makes reasonable moves, showing moments of okay performance despite its overall inconsistency."},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"MADGXU","width_xs":5},"name":"image_11","properties":{"display_mode":"original_size","height":"239.11328125","horizontal_align":"left","source":"_\/theme\/Connect4\/Board3.png"},"type":"Image"},{"layout_properties":{"col_xs":6,"row":"MADGXU","width_xs":5},"name":"image_12","properties":{"display_mode":"original_size","height":"239.11328125","horizontal_align":"left","source":"_\/theme\/Connect4\/Board4.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"IWNYYB","width_xs":11},"name":"rich_text_29","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"LQNLRA","width_xs":11},"name":"label_22","properties":{"bold":true,"font_size":30,"text":"Performance Comparison "},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"THQIBH","width_xs":11},"name":"label_23","properties":{"text":"A strong opening strategy by both the CNN and Transformer models: whenever the AI makes the first move, it consistently places the checker in the center column. This move provides maximum board control, allowing for flexible future plays in multiple directions. "},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"HSYZBB","width_xs":5},"name":"image_13","properties":{"display_mode":"original_size","height":"239.11328125","horizontal_align":"left","source":"_\/theme\/Connect4\/Board5.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"JFDNZY","width_xs":11},"name":"label_24","properties":{"text":"\u200b\u200bIn initial moves, the CNN model quickly recognizes an impending threat and strategically blocks the player\u2019s move. In contrast, the Transformer model on the right fails to detect the immediate danger, prioritizing broader positional relationships rather than defensive play. "},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"WLGTFK","width_xs":5},"name":"image_14","properties":{"display_mode":"original_size","height":"239.11328125","horizontal_align":"left","source":"_\/theme\/Connect4\/Board6.png","spacing_below":"none"},"type":"Image"},{"layout_properties":{"col_xs":6,"row":"WLGTFK","width_xs":5},"name":"image_15","properties":{"display_mode":"original_size","height":"239.11328125","horizontal_align":"left","source":"_\/theme\/Connect4\/Board7.png","spacing_below":"none"},"type":"Image"},{"layout_properties":{"col_xs":1,"row":"DGAIAE","width_xs":3},"name":"label_25","properties":{"font_size":12,"spacing_above":"none","text":"Good Move by CNN"},"type":"Label"},{"layout_properties":{"col_xs":7,"row":"DGAIAE","width_xs":3},"name":"label_26","properties":{"font_size":12,"spacing_above":"none","text":"Bad Move by Transformer"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"GGDISM","width_xs":11},"name":"label_27","properties":{"text":"The CNN model (left) demonstrates strong tactical play by forcing the player into an inevitable loss, strategically placing pieces to control the board and limit the opponent\u2019s options. In contrast, the Transformer model (right) fails to anticipate the player\u2019s next move, neglecting a crucial defensive block."},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"BYTETQ","width_xs":5},"name":"image_16","properties":{"display_mode":"original_size","height":"239.11328125","horizontal_align":"left","source":"_\/theme\/Connect4\/Board8.png"},"type":"Image"},{"layout_properties":{"col_xs":6,"row":"BYTETQ","width_xs":5},"name":"image_17","properties":{"display_mode":"original_size","height":"239.11328125","horizontal_align":"left","source":"_\/theme\/Connect4\/Board9.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"ZJCSZJ","width_xs":11},"name":"rich_text_28","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"BOTMPF","width_xs":12},"name":"label_28","properties":{"bold":true,"font_size":30,"text":"Attempted Improvements for Transformer"},"type":"Label"},{"components":[{"components":[{"layout_properties":{},"name":"label_29","properties":{"bold":true,"font_size":20,"text":"Possible Reasons for Poor Performance"},"type":"Label"},{"layout_properties":{},"name":"rich_text_19","properties":{"content":"We noticed that although we hit above 50% accuracy, the bot fundamentally performed poor moves. One possible reason for this could be improperly tuned layer normalization layers. We used the default settings for the function, but the default settings might have caused exploding gradients, resulting in repeated moves for similar board states. Another potential issue could have risen from ineffective softmax activation function in the encoder, which would have led to uniform class token encoding, resulting in no real information being gained from the transformer model. Lastly, if the MCTS algorithm itself was not trained on a deep enough level, the input moves could have yielded poor training information that would have been reinforced by our relatively deep self attention mechanism.\n\nIn the future, we aim to address these issues through exploring hyperparameter tuning. While this approach would be computationally expensive, it would allow for better exploration of an ideal transformer model."},"type":"RichText"},{"components":[],"layout_properties":{},"name":"rich_text_20","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html"},"type":"RichText"}],"name":"rich_text_18","properties":{},"type":"RichText"}],"layout_properties":{"col_xs":0,"row":"FSFCRJ","width_xs":11},"name":"rich_text_17","properties":{"content":"Our team considered various improvement methods. Attempts to improve the model directly, whether it was increasing the number of attention layers or increasing the number of heads, not only did not improve the accuracy\/play of the model but also made the model extremely inefficient to train. Increasing the data improved accuracy nominally but hit diminishing returns after we exceeded 500k+ boards of data.\n\nGiven the architecture of a transformer model, changing the fundamental structure of the encoder would have been ineffective. We also tried increasing the depth of the decoder neural network. Since the output data was 2-dimensional in nature, there was not much of a noticeable difference in the final test accuracy of the transformer model."},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"ZTZDZM","width_xs":12},"name":"label_30","properties":{"bold":true,"font_size":30,"text":"Frontend Development"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"AEXUHZ","width_xs":11},"name":"label_31","properties":{"text":"The web application was built using Anvil, allowing users to interact with the Connect 4 AI bot through a user-friendly interface."},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"VGIYHN","width_xs":12},"name":"label_32","properties":{"bold":true,"font_size":20,"text":"Login Page and User Authentication"},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"WRLQDE","width_xs":11},"name":"rich_text_21","properties":{"content":"The login system follows the requirements outlined in the project instructions. Users must log in with predefined credentials:\n\n- Email: dan\n- Password: Optimization1234\n\nThe following screenshot showcases the login page of the web application:"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"UOKIKJ","width_xs":7},"name":"image_18","properties":{"display_mode":"original_size","height":324.66015625,"horizontal_align":"center","source":"_\/theme\/Connect4\/Screenshot 2025-02-14 at 7.22.22\u202fPM.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"KGYFNU","width_xs":7},"name":"label_34","properties":{"bold":true,"font_size":20,"text":"Game Rules & AI Opponents"},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"NUAWZV","width_xs":11},"name":"rich_text_22","properties":{"content":"The rules of Connect Four are explained in detail on <a href=\"https:\/\/en.wikipedia.org\/wiki\/Connect_Four\" target=\"_blank\">Connect Four Wikipedia<\/a>. On our website, players can compete against either the CNN or Transformer model. The game always begins with the player making the first move, but after a reset, the starting side is chosen randomly by the algorithm.","format":"restricted_html"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"CNIISS","width_xs":12},"name":"label_35","properties":{"bold":true,"font_size":20,"text":"Steps to Deploy Frontend"},"type":"Label"},{"components":[{"layout_properties":{},"name":"rich_text_24","properties":{"content":"<hr style=\"border: 2px solid black\">","format":"restricted_html"},"type":"RichText"}],"layout_properties":{"col_xs":0,"row":"FDMZYT","width_xs":11},"name":"rich_text_23","properties":{"content":"To provide an interactive and user-friendly experience, we developed the frontend using Anvil, a web application platform that simplifies UI design and backend integration.\n\n- **UI Design**: Built using Anvil\u2019s drag-and-drop components for an intuitive game interface.\n- **Backend Integration**: Connected the front end to AI models hosted on AWS via API calls.\n- **User Authentication**: Implemented login functionality to restrict access to registered users.\n- **Game Board Rendering**: Designed a dynamic Connect 4 board that updates in real-time as players make moves.\n- **AI Move Handling**: Integrated Anvil Uplink to securely communicate with the backend servers.\n"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"HLQHOU","width_xs":11},"name":"label_36","properties":{"bold":true,"font_size":30,"text":"Backend Deployment with AWS and Docker"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"HPQSGX","width_xs":4},"name":"label_37","properties":{"bold":true,"font_size":20,"text":"AWS Setup"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"ODWJVQ","width_xs":11},"name":"label_38","properties":{"text":"To host the AI models and enable interactions with the web frontend, we deployed our backend on AWS Lightsail. We set up an AWS Lightsail instance with a pre-configured Python environment and configured security groups to enable communication between Anvil and AWS.\n"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"KLGCMX","width_xs":4},"name":"label_39","properties":{"bold":true,"font_size":20,"text":"File Transfer"},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"QQSUJW","width_xs":11},"name":"rich_text_25","properties":{"content":"We used FileZilla to transfer all necessary files to the cloud instance, ensuring a smooth deployment process. The transferred files include: \n- connect4_server.py \u2013 Handles game logic and API requests.\n- connect4_cnn.keras & connect4_transformer.keras \u2013 Pre-trained AI models.\n- Dockerfile \u2013 Defines container configuration for deployment.\n- requirements.txt \u2013 Lists required Python dependencies.\n"},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"HFUOYU","width_xs":11},"name":"label_40","properties":{"bold":true,"font_size":20,"text":"AI Server Backend "},"type":"Label"},{"components":[],"layout_properties":{"col_xs":0,"row":"SJOCJA","width_xs":11},"name":"rich_text_26","properties":{"content":"The AI server backend in connect4_server.py handles model inference and manages communication between the frontend and AI models. It loads a CNN model and a Transformer model, processes board states, and predicts the best move in a Connect Four game. \n\nAt startup, the server loads the trained CNN and Transformer models from .keras files. Custom loading is required for the Transformer model because it uses specialized layers like PatchEmbedding and ClassTokenIndex, which modify input embeddings. Since TensorFlow doesn\u2019t recognize these layers by default, they must be registered using custom_objects to ensure proper initialization."},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"MIJBRX","width_xs":10},"name":"image_19","properties":{"height":512.8984375,"horizontal_align":"left","source":"_\/theme\/Connect4\/Screenshot 2025-02-14 at 6.43.53\u202fPM.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"UOTCXY","width_xs":11},"name":"rich_text_27","properties":{"content":"Once the models are loaded, the backend provides two key functions for move prediction. get_best_move_cnn() and get_best_move_transformer(). Along with move prediction, the backend supports board visualization through draw_board(), which generates a color-coded image of the game board using Matplotlib. This enhances the gameplay experience by providing players with a clear, real-time graphical representation of their moves.\n\nTo ensure continuous operation, the server runs using anvil.server.wait_forever(), keeping it responsive to incoming requests from the frontend."},"type":"RichText"},{"layout_properties":{"col_xs":0,"row":"VXXFAQ","width_xs":4},"name":"label_41","properties":{"bold":true,"font_size":20,"text":"Dockerization Process"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"VAXEDB","width_xs":11},"name":"label_42","properties":{"text":"We containerized our AI model and server using Docker. Below is the Dockerfile, which defines the steps to package our application into a container."},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"DVDKHU","width_xs":5},"name":"image_20","properties":{"height":187.66015625,"horizontal_align":"left","source":"_\/theme\/Connect4\/Screenshot 2025-02-14 at 6.48.51\u202fPM.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"CAKXJJ","width_xs":11},"name":"label_43","properties":{"text":"Once the Dockerfile is set up, we built and ran the container using the following commands. This starts the Connect 4 AI server, allowing the frontend (Anvil) to interact with the model. \n"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"MDEOOG","width_xs":5},"name":"image_21","properties":{"display_mode":"shrink_to_fit","height":43.22265625,"horizontal_align":"left","source":"_\/theme\/Connect4\/Screenshot 2025-02-14 at 6.50.42\u202fPM.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"AEDKSP","width_xs":11},"name":"label_44","properties":{"text":"The image below shows our AWS Lightsail instance with the deployed Docker container running the Connect 4 AI server.\n"},"type":"Label"},{"layout_properties":{"col_xs":0,"row":"IEKHRD","width_xs":11},"name":"image_22","properties":{"height":278.1015625,"horizontal_align":"left","source":"_\/theme\/Connect4\/Screenshot 2025-02-13 at 1.10.34\u202fAM.png"},"type":"Image"},{"layout_properties":{"col_xs":0,"row":"ZNTAFQ","width_xs":11},"name":"label_45","properties":{"text":"After containerizing the application, the Connect 4 game can now be accessed from any machine via the frontend interface."},"type":"Label"}],"layout_properties":{"grid_position":"QBZHVW,STSSKX"},"name":"grid_panel_2","properties":{"spacing_above":"large"},"type":"GridPanel"}],"layout_properties":{"slot":"default"},"name":"content_panel","properties":{"col_widths":"{}"},"type":"ColumnPanel"},{"components":[{"event_bindings":{"click":"logout_button_click"},"layout_properties":{},"name":"logout_button","properties":{"align":"right","border":"none","font_size":15,"icon":"fa:cog","role":"transparent-background","text":"Logout","visible":true},"type":"Button"}],"layout_properties":{"slot":"nav-right"},"name":"navbar_links","properties":{},"type":"FlowPanel"},{"layout_properties":{"slot":"title"},"name":"label_3","properties":{"bold":true,"font_size":30,"text":"Connect 4"},"type":"Label"},{"layout_properties":{"slot":"top-left-btn"},"name":"image_1","properties":{"height":48.53125,"source":"_\/theme\/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg"},"type":"Image"},{"components":[{"layout_properties":{"col_xs":1,"row":"WGVMAF","width_xs":10},"name":"spacer_1","properties":{"height":132.234375},"type":"Spacer"},{"data_bindings":[],"event_bindings":{"click":"CNN_button_click"},"layout_properties":{"col_xs":2,"row":"ZHAVBD","width_xs":8},"name":"CNN_button","properties":{"align":"center","bold":true,"enabled":true,"role":"filled-button","spacing_above":"large","text":"Play Against CNN","visible":true},"type":"Button"},{"data_bindings":[],"event_bindings":{"click":"Trans_button_click"},"layout_properties":{"col_xs":2,"row":"ZEAALB","width_xs":8},"name":"Trans_button","properties":{"align":"center","background":"theme:Primary Overlay 3","foreground":"theme:Primary","role":"tonal-button","text":"Play Against Transformer","underline":false},"type":"Button"}],"layout_properties":{"slot":"left-nav"},"name":"grid_panel_3","properties":{},"type":"GridPanel"}],"container":{"properties":{"border":"none","html":"@theme:standard-page.html"},"type":"HtmlTemplate"},"is_package":true,"code":"from ._anvil_designer import Form2Template\nfrom anvil import *\nimport anvil.server\n# print(\"Before importing FormCNN\")\n# from .FormCNN import FormCNN\n# print(\"After importing FormCNN\")\n# from .FormTransformer import FormTransformer\n\nclass Form2(Form2Template):\n    def __init__(self, **properties):\n        self.init_components(**properties)\n\n    def CNN_button_click(self, **event_args):\n        \"\"\"Navigate to CNN gameplay form\"\"\"\n        print(\"CNN button clicked\")\n        open_form('FormCNN')  # Open the FormCNN form\n\n    def Trans_button_click(self, **event_args):\n        \"\"\"Navigate to Transformer gameplay form\"\"\"\n        print(\"Transformer button clicked\")\n        open_form('FormTransformer')  # Open the FormTransformer form\n\n    def logout_button_click(self, **event_args):\n        \"\"\"This method is called when the button is clicked\"\"\"\n        response = anvil.alert(\"Do you want to logout?\", \n                        title=\"Confirmation\",\n                        buttons=[\"Yes\", \"No\"])\n        \n        if response == \"Yes\":\n            open_form('Form1')\n            print(\"User chose Yes!\")\n        elif response == \"No\":\n            print(\"User chose No!\")\n","class_name":"Form2","id":"1737418333052278731462255.57874"},{"components":[{"components":[{"layout_properties":{"grid_position":"WNFYYO,MXDWRM"},"name":"label_1","properties":{"bold":true,"font_size":30,"text":"Connect 4 - CNN"},"type":"Label"},{"data_bindings":[],"event_bindings":{"change":"drop_menu_change"},"layout_properties":{"grid_position":"PQYPUJ,SZRYYI"},"name":"drop_menu","properties":{"include_placeholder":true,"items":["\"Play Against CNN\"","\"Play Against Transformer\""],"placeholder":"Choose AI Model"},"type":"DropDown"},{"components":[{"components":[],"layout_properties":{"col_xs":0,"row":"FWBEOU","width_xs":2},"name":"outlined_card_4","properties":{"border":"none","role":null},"type":"ColumnPanel"},{"layout_properties":{"col_xs":5,"row":"FWBEOU","width_xs":3},"name":"message_label","properties":{},"type":"Label"},{"components":[{"components":[{"components":[{"data_bindings":[],"event_bindings":{"clicked":"column_button_0_click"},"layout_properties":{"col_xs":1,"row":"QGWUMG","width_xs":1},"name":"column_button_0","properties":{"align":"right","selected":false,"spacing":{"padding":[null,null,0,15]},"spacing_above":"small","text":"1","visible":true},"type":"RadioButton"},{"event_bindings":{"clicked":"column_button_1_click"},"layout_properties":{"col_xs":2,"row":"QGWUMG","width_xs":1},"name":"column_button_1","properties":{"align":"right","spacing":{"padding":[null,null,null,44]},"text":"2"},"type":"RadioButton"},{"data_bindings":[],"event_bindings":{"clicked":"column_button_2_click"},"layout_properties":{"col_xs":3,"row":"QGWUMG","width_xs":1},"name":"column_button_2","properties":{"align":"right","bold":false,"spacing":{"padding":[null,null,null,48]},"text":"3"},"type":"RadioButton"},{"data_bindings":[],"event_bindings":{"clicked":"column_button_3_click"},"layout_properties":{"col_xs":4,"row":"QGWUMG","width_xs":1},"name":"column_button_3","properties":{"align":"right","spacing":{"padding":[null,28,null,63]},"text":"4"},"type":"RadioButton"},{"event_bindings":{"clicked":"column_button_4_click"},"layout_properties":{"col_xs":5,"row":"QGWUMG","width_xs":1},"name":"column_button_4","properties":{"align":"right","spacing":{"padding":[null,null,null,66]},"text":"5"},"type":"RadioButton"},{"data_bindings":[],"event_bindings":{"clicked":"column_button_5_click"},"layout_properties":{"col_xs":7,"row":"QGWUMG","width_xs":1},"name":"column_button_5","properties":{"align":"left","spacing":{"padding":[null,0,null,2]},"text":"6"},"type":"RadioButton"},{"event_bindings":{"clicked":"column_button_6_click"},"layout_properties":{"col_xs":8,"row":"QGWUMG","width_xs":1},"name":"column_button_6","properties":{"align":"left","role":null,"spacing":{"padding":[null,61,null,10]},"text":"7"},"type":"RadioButton"}],"layout_properties":{"full_width_row":false,"grid_position":"BJUQFV,BAMPBA"},"name":"grid_panel_3","properties":{"spacing":{"padding":[null,0,null,24]},"visible":true},"type":"GridPanel"}],"data_bindings":[],"layout_properties":{"grid_position":"HURMZI,QJQJYR"},"name":"outlined_card_3","properties":{"role":null,"wrap_on":"never"},"type":"ColumnPanel"},{"data_bindings":[],"layout_properties":{"grid_position":"LFASMN,QXUQRC"},"name":"connect4_image","properties":{"display_mode":"original_size","height":96.58203125,"horizontal_align":"center","role":"board-style","visible":true},"type":"Image"},{"layout_properties":{"grid_position":"LFASMN,DBBTIN QWCXMT,QBPYFS"},"name":"spacer_1","properties":{"height":329.2578125},"type":"Spacer"},{"components":[{"layout_properties":{"grid_position":"FGFHKE,QSKVPX"},"name":"turn_indicator_text","properties":{"align":"center","bold":true,"font_size":14,"spacing_above":"small","spacing_below":"medium","visible":true},"type":"Label"},{"event_bindings":{"reset":"turn_indicator_circle_reset"},"layout_properties":{"grid_position":"NFTVTE,VLRPYX"},"name":"turn_indicator_circle","properties":{"background":"theme:Secondary Container","height":56.796875,"role":null,"spacing_above":"medium","spacing_below":"large","visible":true},"type":"Canvas"}],"layout_properties":{"grid_position":"LFASMN,DBBTIN MPMZEB,XXEISV"},"name":"outlined_card_2","properties":{"background":"theme:Secondary Container","role":"tonal-card","wrap_on":"never"},"type":"ColumnPanel"},{"event_bindings":{"click":"reset_button_click"},"layout_properties":{"grid_position":"LFASMN,DBBTIN SNVDCY,APAPQF"},"name":"reset_button","properties":{"role":"tonal-button","bold":true,"align":"full","spacing_above":"medium","background":"theme:Secondary Container","icon":"fa:repeat","foreground":"","spacing":{"padding":[null,25,null,26]},"text":"Reset"},"type":"Button"}],"layout_properties":{"col_xs":0,"row":"WUFTMV","width_xs":12},"name":"outlined_card_1","properties":{"border":"none","col_spacing":"huge","col_widths":"{\"QXUQRC\":50,\"DBBTIN\":10}","role":"outlined-card","spacing_above":"small","wrap_on":"never"},"type":"ColumnPanel"},{"event_bindings":{"click":"back_button_click"},"layout_properties":{"col_xs":0,"row":"EIYCCD","width_xs":3},"name":"back_button","properties":{"align":"left","icon":"fa:arrow-circle-left","role":"tonal-button","text":"Back"},"type":"Button"},{"components":[],"layout_properties":{"col_xs":0,"row":"KHYEGS","width_xs":12},"name":"grid_panel_2","properties":{},"type":"GridPanel"}],"event_bindings":{},"layout_properties":{"grid_position":"BUHUPT,ELMXUE"},"name":"grid_panel_1","properties":{"role":null,"visible":true},"type":"GridPanel"}],"layout_properties":{"slot":"default"},"name":"content_panel","properties":{"col_widths":"{}"},"type":"ColumnPanel"},{"components":[{"event_bindings":{"click":"logout_button_click"},"layout_properties":{},"name":"logout_button","properties":{"align":"left","border":"none","font_size":15,"icon":"fa:cog","role":null,"text":"Logout"},"type":"Button"}],"layout_properties":{"slot":"nav-right"},"name":"navbar_links","properties":{},"type":"FlowPanel"},{"layout_properties":{"slot":"top-left-btn"},"name":"image_1","properties":{"height":"48.53125","source":"_\/theme\/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg"},"type":"Image"},{"layout_properties":{"slot":"title"},"name":"label_2","properties":{"bold":true,"font_size":30,"text":"Connect 4"},"type":"Label"}],"container":{"properties":{"html":"@theme:standard-page.html"},"type":"HtmlTemplate"},"is_package":true,"code":"from ._anvil_designer import FormCNNTemplate\nimport anvil.server\nfrom anvil import *\nimport random\n\nimport anvil.js.window\n\nclass FormCNN(FormCNNTemplate):\n    def __init__(self, **properties):\n        self.init_components(**properties)\n        self.drop_menu.items = [\"Play Against CNN\", \"Play Against Transformer\"]\n        self.drop_menu.selected_value = \"Play Against CNN\"  # Default value\n\n        # Initialize the game board (6x7)\n        self.board = [[0 for _ in range(7)] for _ in range(6)]  # 0: Empty, 1: Player, -1: AI\n        self.game_over = False  # Track if the game is over\n      \n        # Set the first player to always be the player\n        self.current_player = \"player\"\n        self.update_board()\n        self.set_event_handler('show', self.form_show)\n\n    def form_show(self, **event_args):\n        \"\"\"Called after the form is shown to ensure canvas is ready.\"\"\"\n        self.update_turn_indicator()  # Now safe to draw the circle\n\n    def drop_menu_change(self, **event_args):\n        \"\"\"\n        Handles dropdown menu changes.\n        \"\"\"\n        selected_option = self.drop_menu.selected_value\n        if selected_option == \"Play Against CNN\":\n            open_form('FormCNN')\n            print(\"Switching to Play Against CNN\")\n            self.set_event_handler('show', self.form_show)\n        elif selected_option == \"Play Against Transformer\":\n            open_form('FormTransformer')\n            print(\"Switching to Play Against Transformer\")\n            self.set_event_handler('show', self.form_show)\n\n    def update_board(self):\n        \"\"\"\n        Updates the board's visual state by requesting an updated image from the server.\n        \"\"\"\n        try:\n            print(\"Board state before drawing:\", self.board)  # Debug: Check board state\n            image = anvil.server.call(\"draw_board\", self.board)\n            self.connect4_image.source = image           \n            print(\"Board updated successfully!\")\n            self.update_turn_indicator()\n        except Exception as e:\n            print(f\"Error in update_board: {e}\")\n            anvil.alert(f\"Error updating the board: {str(e)}\", title=\"Error\", style=\"error\")\n\n    def reset_button_click(self, **event_args):\n      \"\"\"\n      Resets the game board to the initial state and randomly selects who plays first.\n      \"\"\"\n      # Reset the board\n      self.board = [[0 for _ in range(7)] for _ in range(6)]\n      self.game_over = False  # Allow new moves\n      \n      # Update the board and reset buttons\n      self.update_board()\n      self.reset_buttons()\n      \n      # Randomly select who starts\n      self.select_first_player()\n      # self.update_turn_indicator()  # Update the turn indicator\n     \n\n    def column_button_click(self, column, **event_args):\n      \"\"\"\n      Handles a player's move and triggers the AI's move.\n      \"\"\"\n      if self.game_over:\n          anvil.alert(\"Game over! Please reset the board to play again.\", title=\"Game Over\", style=\"info\")\n          return\n  \n      row = self.get_lowest_row(column)  # Find the lowest available row\n      if row is None:\n          anvil.alert(\"Column is full! Try another column.\", title=\"Invalid Move\", style=\"error\")\n          return\n  \n      # Player move\n      self.board[row][column] = 1  # Player's move\n      self.update_cell(row, column)  # \u2705 Update only the affected cell\n  \n      print(f\"Player moved to column {column}, row {row}\")\n      print(\"Board after player move:\", self.board)  # Debug: Check board state\n  \n      if self.check_winner(1):\n          anvil.alert(\"You win!\", title=\"Victory\", style=\"success\")\n          self.game_over = True\n          return\n  \n      # Switch turn to AI\n      self.current_player = \"ai\"\n      self.update_turn_indicator()  # Update the turn indicator\n      self.trigger_cnn_move()  # Trigger the AI move\n\n\n    def trigger_cnn_move(self):\n        \"\"\"\n        Triggers the AI's move using the cnn model and ensures it is a valid move.\n        \"\"\"\n        if self.game_over:\n            return\n    \n        try:\n            self.set_column_buttons_enabled(False)  # \ud83d\udeab Disable buttons before AI moves\n    \n            for _ in range(5):  # AI tries multiple times to pick a valid column\n                cnn_move = anvil.server.call(\"get_best_move_cnn\", self.board)\n                print(\"AI (CNN) chose column\", cnn_move)\n    \n                if self.board[0][cnn_move] == 0:\n                    self.make_cnn_move(cnn_move)\n                    self.set_column_buttons_enabled(True)  # \u2705 Restore buttons\n                    return\n                else:\n                    print(f\"AI (CNN) chose a full column {cnn_move}, trying again...\")\n    \n            # If AI fails to make a valid move, pick a random valid column\n            valid_columns = [col for col in range(7) if self.board[0][col] == 0]\n            if valid_columns:\n                fallback_move = random.choice(valid_columns)\n                print(f\"AI (CNN) fallback move: {fallback_move}\")\n                self.make_cnn_move(fallback_move)\n    \n            self.set_column_buttons_enabled(True)  # \u2705 Restore buttons after move\n    \n        except Exception as e:\n            print(f\"Error during AI (CNN) move: {e}\")\n            anvil.alert(f\"Error during AI move: {str(e)}\", title=\"Error\", style=\"error\")\n            self.set_column_buttons_enabled(True)  # \u2705 Restore buttons even if error occurs\n\n  \n    def make_cnn_move(self, column):\n      \"\"\"\n      Handles the AI's move on the board and restores the column button states after the move.\n      \"\"\"\n      for row in range(5, -1, -1):  # Start from the bottom row\n          if self.board[row][column] == 0:\n              self.board[row][column] = -1  # AI's move\n              self.update_cell(row, column)  # \u2705 Update only the changed cell\n  \n              if self.check_winner(-1):\n                  anvil.alert(\"CNN wins!\", title=\"Defeat\", style=\"error\")\n                  self.game_over = True\n  \n              self.current_player = \"player\"\n              self.update_turn_indicator()\n              self.set_column_buttons_enabled(True)  # \u2705 Restore buttons\n              return\n \n\n    def check_winner(self, player):\n        \"\"\"\n        Checks if the specified player has won.\n        \"\"\"\n        for row in range(6):\n            for col in range(7):\n                if (\n                    col + 3 < 7 and all(self.board[row][col + i] == player for i in range(4)) or  # Horizontal\n                    row + 3 < 6 and all(self.board[row + i][col] == player for i in range(4)) or  # Vertical\n                    col + 3 < 7 and row + 3 < 6 and all(self.board[row + i][col + i] == player for i in range(4)) or  # Diagonal \\\n                    col - 3 >= 0 and row + 3 < 6 and all(self.board[row + i][col - i] == player for i in range(4))    # Diagonal \/\n                ):\n                    return True\n        return False\n      \n    def select_first_player(self):\n      \"\"\"\n      Randomly selects the first player and triggers the AI's move if the AI is chosen.\n      \"\"\"\n      self.current_player = random.choice([\"player\", \"ai\"])  # Randomly choose \"player\" or \"ai\"\n      print(f\"First turn: {self.current_player}\")  # Debugging: Check who starts\n\n      # \u2705 Show alert **before** making any move\n      if self.current_player == \"player\":\n          anvil.alert(\"Game reset. Your turn!\", title=\"New Game\", style=\"info\")\n          self.update_turn_indicator()\n      else:\n          anvil.alert(\"Game reset. AI's turn!\", title=\"New Game\", style=\"info\")\n          self.update_turn_indicator()\n          self.trigger_cnn_move()  # AI moves after the alert\n\n      if self.current_player == \"ai\":\n          self.trigger_cnn_move()  # AI makes the first move\n\n      \n    def draw_turn_circle(self, color):\n      \"\"\"\n      Draws a 3D-like circular turn indicator with an outer ring.\n      Uses self.current_player to determine if AI or player.\n      \"\"\"\n      canvas = self.turn_indicator_circle\n      width, height = canvas.get_width(), canvas.get_height()\n      center_x, center_y = width \/\/ 2, height \/\/ 2\n      outer_radius = max(5, (min(width, height) \/\/ 2))   # Outer ring\n      inner_radius = max(5, (min(width, height) \/\/ 2) - 5)  # Inner circle\n  \n      # \u2705 Clear the previous drawing\n      canvas.clear_rect(0, 0, width, height)  \n  \n      # Adjust outer ring color based on current player\n      if self.current_player == \"ai\":\n          outer_color = \"#7A5C12\"  # Darker brownish-gold for AI\n          inner_color = \"#C8A500\"  # Darker yellow for AI\n      else:\n          outer_color = \"#A23C2D\"  # Dark Red outer ring for player\n          inner_color = color  # Use given color for player\n  \n      # Draw outer ring\n      canvas.begin_path()\n      canvas.arc(center_x, center_y, outer_radius, 0, 2 * 3.14159)\n      canvas.fill_style = outer_color  # Dynamically chosen color\n      canvas.fill()\n  \n      # Draw inner circle (Main Color)\n      canvas.begin_path()\n      canvas.arc(center_x, center_y, inner_radius, 0, 2 * 3.14159)\n      canvas.fill_style = inner_color\n      canvas.fill()\n  \n      # Add a slight shadow effect for depth\n      canvas.shadow_offset_x = 3\n      canvas.shadow_offset_y = 3\n      canvas.shadow_blur = 5\n      canvas.shadow_color = \"rgba(0, 0, 0, 0.2)\"\n  \n      # Redraw the inner circle to ensure shadow applies correctly\n      canvas.begin_path()\n      canvas.arc(center_x, center_y, inner_radius, 0, 2 * 3.14159)\n      canvas.fill_style = inner_color\n      canvas.fill()\n  \n      # Add a black border\n      canvas.stroke_style = \"black\"\n      canvas.line_width = 2\n      canvas.stroke()\n\n  \n    def update_turn_indicator(self):\n      \"\"\"\n      Updates the turn indicator with text and a circle color.\n      \"\"\"\n      if self.current_player == \"player\":\n          self.turn_indicator_text.text = \"Player Turn\"\n          self.draw_turn_circle(\"#FF4500\")  # Player's red color\n      else:\n          self.turn_indicator_text.text = \"AI Turn\"\n          self.draw_turn_circle(\"#C8A500\")  # AI's yellow color\n      self.refresh_data_bindings()\n\n\n    # Individual column button click handlers\n    def column_button_0_click(self, **event_args):\n        self.column_button_click(0)\n\n    def column_button_1_click(self, **event_args):\n        self.column_button_click(1)\n\n    def column_button_2_click(self, **event_args):\n        self.column_button_click(2)\n\n    def column_button_3_click(self, **event_args):\n        self.column_button_click(3)\n\n    def column_button_4_click(self, **event_args):\n        self.column_button_click(4)\n\n    def column_button_5_click(self, **event_args):\n        self.column_button_click(5)\n\n    def column_button_6_click(self, **event_args):\n        self.column_button_click(6)\n      \n    def reset_buttons(self):\n      \"\"\"\n      Resets all column buttons to an unselected state and ensures they are clickable.\n      \"\"\"\n      # Clear the selection for all buttons\n      self.column_button_0.selected = False\n      self.column_button_1.selected = False\n      self.column_button_2.selected = False\n      self.column_button_3.selected = False\n      self.column_button_4.selected = False\n      self.column_button_5.selected = False\n      self.column_button_6.selected = False\n  \n      # Ensure all buttons are enabled\n      self.column_button_0.enabled = True\n      self.column_button_1.enabled = True\n      self.column_button_2.enabled = True\n      self.column_button_3.enabled = True\n      self.column_button_4.enabled = True\n      self.column_button_5.enabled = True\n      self.column_button_6.enabled = True\n  \n      # Refresh the UI bindings to reflect the changes\n      self.refresh_data_bindings()\n  \n      # Debug: Print button states\n      print(\"Button states reset:\")\n      for i in range(7):\n          print(f\"Column {i} selected: {getattr(self, f'column_button_{i}').selected}, enabled: {getattr(self, f'column_button_{i}').enabled}\")\n\n    def back_button_click(self, **event_args):\n      \"\"\"This method is called when the button is clicked\"\"\"\n      response = anvil.alert(\"Do you want to go to Info page?\", \n                       title=\"Confirmation\",\n                       buttons=[\"Yes\", \"No\"])\n      \n      if response == \"Yes\":\n          open_form('Form2')\n          print(\"User chose Yes!\")\n      elif response == \"No\":\n          print(\"User chose No!\")\n\n\n    def update_cell(self, row, column):\n        \"\"\"\n        Updates only a single cell in the UI without refreshing the whole board.\n        \"\"\"\n        try:\n            image = anvil.server.call(\"draw_board\", self.board)  # Call server to update image\n            self.connect4_image.source = image  # Update only the game image\n        except Exception as e:\n            print(f\"Error updating cell ({row}, {column}): {e}\")\n\n    def get_lowest_row(self, column):\n      \"\"\"\n      Returns the lowest available row in a column, or None if the column is full.\n      \"\"\"\n      for row in range(5, -1, -1):\n          if self.board[row][column] == 0:\n              return row\n      return None\n\n    def logout_button_click(self, **event_args):\n      \"\"\"This method is called when the button is clicked\"\"\"\n      response = anvil.alert(\"Do you want to logout?\", \n                       title=\"Confirmation\",\n                       buttons=[\"Yes\", \"No\"])\n      \n      if response == \"Yes\":\n          open_form('Form1')\n          print(\"User chose Yes!\")\n      elif response == \"No\":\n          print(\"User chose No!\")\n\n\n    def set_column_buttons_enabled(self, enabled):\n      \"\"\"\n      Enables or disables column buttons. If enabling, restore valid buttons using `reset_buttons()`.\n      \"\"\"\n      if not enabled:\n          # \ud83d\udeab Disable all buttons while AI is thinking\n          for i in range(7):\n              getattr(self, f'column_button_{i}').enabled = False\n      else:\n          # \u2705 Restore valid buttons using reset_buttons()\n          self.reset_buttons()\n\n\n        \n\n","class_name":"FormCNN","id":"1737423229453221047384454.69473"},{"components":[{"components":[{"layout_properties":{"grid_position":"WNFYYO,MXDWRM"},"name":"label_1","properties":{"bold":true,"font_size":30,"text":"Connect 4 - Transformer"},"type":"Label"},{"data_bindings":[],"event_bindings":{"change":"drop_menu_change"},"layout_properties":{"grid_position":"PQYPUJ,SZRYYI"},"name":"drop_menu","properties":{"include_placeholder":true,"items":["\"Play Against CNN\"","\"Play Against Transformer\""],"placeholder":"Choose AI Model"},"type":"DropDown"},{"components":[{"components":[],"layout_properties":{"col_xs":0,"row":"FWBEOU","width_xs":2},"name":"outlined_card_4","properties":{"border":"none","role":null},"type":"ColumnPanel"},{"layout_properties":{"col_xs":5,"row":"FWBEOU","width_xs":3},"name":"message_label","properties":{},"type":"Label"},{"components":[{"components":[{"data_bindings":[],"event_bindings":{"clicked":"column_button_0_click"},"layout_properties":{"col_xs":1,"row":"QGWUMG","width_xs":1},"name":"column_button_0","properties":{"align":"left","selected":false,"spacing":{"margin":[null,0,null,0],"padding":[null,0,0,58]},"spacing_above":"small","text":"1","visible":true},"type":"RadioButton"},{"event_bindings":{"clicked":"column_button_1_click"},"layout_properties":{"col_xs":2,"row":"QGWUMG","width_xs":1},"name":"column_button_1","properties":{"align":"center","enabled":true,"spacing":{"margin":[null,null,null,0],"padding":[null,0,null,64]},"text":"2"},"type":"RadioButton"},{"data_bindings":[],"event_bindings":{"clicked":"column_button_2_click"},"layout_properties":{"col_xs":3,"row":"QGWUMG","width_xs":1},"name":"column_button_2","properties":{"align":"center","bold":false,"spacing":{"margin":[null,0,null,0],"padding":[null,0,null,69]},"text":"3"},"type":"RadioButton"},{"data_bindings":[],"event_bindings":{"clicked":"column_button_3_click"},"layout_properties":{"col_xs":5,"row":"QGWUMG","width_xs":1},"name":"column_button_3","properties":{"align":"center","spacing":{"padding":[null,35,null,0]},"text":"4"},"type":"RadioButton"},{"event_bindings":{"clicked":"column_button_4_click"},"layout_properties":{"col_xs":6,"row":"QGWUMG","width_xs":1},"name":"column_button_4","properties":{"align":"center","spacing":{"padding":[null,66,null,2]},"text":"5"},"type":"RadioButton"},{"data_bindings":[],"event_bindings":{"clicked":"column_button_5_click"},"layout_properties":{"col_xs":7,"row":"QGWUMG","width_xs":1},"name":"column_button_5","properties":{"align":"center","spacing":{"padding":[null,21,null,4]},"text":"6"},"type":"RadioButton"},{"event_bindings":{"clicked":"column_button_6_click"},"layout_properties":{"col_xs":8,"row":"QGWUMG","width_xs":1},"name":"column_button_6","properties":{"align":"center","selected":false,"spacing":{"padding":[null,0,null,0]},"text":"7"},"type":"RadioButton"}],"layout_properties":{"grid_position":"RHWFPG,GTHIYG"},"name":"grid_panel_3","properties":{"spacing":{"margin":[null,0,null,0],"padding":[null,0,null,0]},"visible":true},"type":"GridPanel"},{"data_bindings":[],"layout_properties":{"grid_position":"LFASMN,QXUQRC"},"name":"connect4_image","properties":{"display_mode":"original_size","height":96.58203125,"horizontal_align":"center","margin":[null,null,null,0],"role":"board-style","visible":true},"type":"Image"},{"layout_properties":{"grid_position":"LFASMN,DBBTIN IXWANH,ENFNOO"},"name":"spacer_1","properties":{"height":327.8125},"type":"Spacer"},{"components":[{"layout_properties":{"grid_position":"FGFHKE,QSKVPX"},"name":"turn_indicator_text","properties":{"align":"center","bold":true,"font_size":14,"spacing_above":"small","spacing_below":"medium","visible":true},"type":"Label"},{"event_bindings":{"reset":"turn_indicator_circle_reset"},"layout_properties":{"grid_position":"NFTVTE,VLRPYX"},"name":"turn_indicator_circle","properties":{"background":"theme:Secondary Container","height":56.9296875,"role":null,"spacing_above":"medium","spacing_below":"large","visible":true},"type":"Canvas"}],"layout_properties":{"grid_position":"LFASMN,DBBTIN MPMZEB,XXEISV"},"name":"outlined_card_2","properties":{"background":"theme:Secondary Container","role":"tonal-card","wrap_on":"never"},"type":"ColumnPanel"},{"event_bindings":{"click":"reset_button_click"},"layout_properties":{"grid_position":"LFASMN,DBBTIN SNVDCY,APAPQF"},"name":"reset_button","properties":{"role":"tonal-button","bold":true,"align":"full","spacing_above":"medium","background":"theme:Secondary Container","icon":"fa:repeat","foreground":"","spacing":{"padding":[null,25,null,26]},"text":"Reset"},"type":"Button"}],"layout_properties":{"col_xs":0,"row":"WUFTMV","width_xs":12},"name":"outlined_card_1","properties":{"border":"none","col_spacing":"huge","col_widths":"{\"QXUQRC\":50,\"DBBTIN\":10}","role":"outlined-card","spacing_above":"small","wrap_on":"never"},"type":"ColumnPanel"},{"event_bindings":{"click":"back_button_click"},"layout_properties":{"col_xs":0,"row":"EIYCCD","width_xs":3},"name":"back_button","properties":{"align":"left","icon":"fa:arrow-circle-left","role":"tonal-button","text":"Back"},"type":"Button"},{"components":[],"layout_properties":{"col_xs":0,"row":"KHYEGS","width_xs":12},"name":"grid_panel_2","properties":{},"type":"GridPanel"}],"event_bindings":{},"layout_properties":{"grid_position":"BUHUPT,ELMXUE"},"name":"grid_panel_1","properties":{"role":null,"visible":true},"type":"GridPanel"}],"layout_properties":{"slot":"default"},"name":"content_panel","properties":{"col_widths":"{}"},"type":"ColumnPanel"},{"components":[{"event_bindings":{"click":"logout_button_click"},"layout_properties":{},"name":"logout_button","properties":{"align":"left","border":"none","font_size":15,"icon":"fa:cog","role":null,"text":"Logout"},"type":"Button"}],"layout_properties":{"slot":"nav-right"},"name":"navbar_links","properties":{},"type":"FlowPanel"},{"layout_properties":{"slot":"top-left-btn"},"name":"image_1","properties":{"height":"48.53125","source":"_\/theme\/Gemini_Generated_Image_18hcxc18hcxc18hc-logo.jpeg"},"type":"Image"},{"layout_properties":{"slot":"title"},"name":"label_2","properties":{"bold":true,"font_size":30,"text":"Connect 4"},"type":"Label"}],"container":{"properties":{"html":"@theme:standard-page.html"},"type":"HtmlTemplate"},"is_package":true,"code":"from ._anvil_designer import FormTransformerTemplate\nimport anvil.server\nfrom anvil import *\nimport random\n\nclass FormTransformer(FormTransformerTemplate):\n    def __init__(self, **properties):\n        self.init_components(**properties)\n        self.drop_menu.items = [\"Play Against CNN\", \"Play Against Transformer\"]\n        self.drop_menu.selected_value = \"Play Against Transformer\"  # Default value\n\n        # Initialize the game board (6x7)\n        self.board = [[0 for _ in range(7)] for _ in range(6)]  # 0: Empty, 1: Player, -1: AI\n        self.game_over = False  # Track if the game is over\n\n        # Set the first player to always be the player\n        self.current_player = \"player\"\n        self.update_board()  # \u2705 This was failing before\n        self.set_event_handler(\"show\", self.form_show)\n\n    def form_show(self, **event_args):\n        \"\"\"Called after the form is shown to ensure canvas is ready.\"\"\"\n        self.update_turn_indicator()  # Now safe to draw the circle\n\n    def update_board(self):\n        \"\"\"\n        Updates the board's visual state by requesting an updated image from the server.\n        \"\"\"\n        try:\n            print(\"Board state before drawing:\", self.board)  # Debug: Check board state\n            image = anvil.server.call(\"draw_board\", self.board)\n            self.connect4_image.source = image           \n            print(\"Board updated successfully!\")\n            self.update_turn_indicator()\n        except Exception as e:\n            print(f\"Error in update_board: {e}\")\n            anvil.alert(f\"Error updating the board: {str(e)}\", title=\"Error\", style=\"error\")\n      \n\n    def column_button_click(self, column, **event_args):\n      if self.game_over:\n          anvil.alert(\"Game over! Please reset the board to play again.\", title=\"Game Over\", style=\"info\")\n          return\n  \n      row = self.get_lowest_row(column)\n      if row is None:\n          anvil.alert(\"Column is full! Try another column.\", title=\"Invalid Move\", style=\"error\")\n          return\n  \n      self.board[row][column] = 1  # Player's move\n      self.update_cell(row, column)  # \u2705 Update only the changed cell\n      \n      if self.check_winner(1):\n          anvil.alert(\"You win!\", title=\"Victory\", style=\"success\")\n          self.game_over = True\n          return\n  \n      self.current_player = \"ai\"\n      self.update_turn_indicator()\n      self.trigger_transformer_move()\n\n\n    def trigger_transformer_move(self):\n      \"\"\"\n      Triggers the AI's move using the Transformer model and ensures it is a valid move.\n      \"\"\"\n      if self.game_over:\n          return\n  \n      try:\n          self.set_column_buttons_enabled(False)  # \ud83d\udeab Disable buttons before AI moves\n  \n          for _ in range(5):  # AI tries multiple times to pick a valid column\n              transformer_move = anvil.server.call(\"get_best_move_transformer\", self.board)\n              print(\"AI (Transformer) chose column\", transformer_move)\n  \n              if self.board[0][transformer_move] == 0:\n                  self.make_transformer_move(transformer_move)\n                  self.set_column_buttons_enabled(True)  # \u2705 Restore buttons\n                  return\n              else:\n                  print(f\"AI (Transformer) chose a full column {transformer_move}, trying again...\")\n  \n          # If AI fails to make a valid move, pick a random valid column\n          valid_columns = [col for col in range(7) if self.board[0][col] == 0]\n          if valid_columns:\n              fallback_move = random.choice(valid_columns)\n              print(f\"AI (Transformer) fallback move: {fallback_move}\")\n              self.make_transformer_move(fallback_move)\n  \n          self.set_column_buttons_enabled(True)  # \u2705 Restore buttons after move\n  \n      except Exception as e:\n          print(f\"Error during AI (Transformer) move: {e}\")\n          anvil.alert(f\"Error during AI move: {str(e)}\", title=\"Error\", style=\"error\")\n          self.set_column_buttons_enabled(True)  # \u2705 Restore buttons even if error occurs\n\n    def make_transformer_move(self, column):\n      \"\"\"\n      Handles the AI's move on the board and restores the column button states after the move.\n      \"\"\"\n      for row in range(5, -1, -1):  # Start from the bottom row\n          if self.board[row][column] == 0:\n              self.board[row][column] = -1  # AI's move\n              self.update_cell(row, column)  # \u2705 Update only the changed cell\n  \n              if self.check_winner(-1):\n                  anvil.alert(\"Transformer wins!\", title=\"Defeat\", style=\"error\")\n                  self.game_over = True\n  \n              self.current_player = \"player\"\n              self.update_turn_indicator()\n              self.set_column_buttons_enabled(True)  # \u2705 Restore buttons\n              return\n \n    def check_winner(self, player):\n        \"\"\"\n        Checks if the specified player has won.\n        \"\"\"\n        for row in range(6):\n            for col in range(7):\n                if (\n                    col + 3 < 7 and all(self.board[row][col + i] == player for i in range(4)) or  # Horizontal\n                    row + 3 < 6 and all(self.board[row + i][col] == player for i in range(4)) or  # Vertical\n                    col + 3 < 7 and row + 3 < 6 and all(self.board[row + i][col + i] == player for i in range(4)) or  # Diagonal \\\n                    col - 3 >= 0 and row + 3 < 6 and all(self.board[row + i][col - i] == player for i in range(4))    # Diagonal \/\n                ):\n                    return True\n        return False\n      \n    def select_first_player(self):\n      \"\"\"\n      Randomly selects the first player and triggers the AI's move if the AI is chosen.\n      \"\"\"\n      self.current_player = random.choice([\"player\", \"ai\"])  # Randomly choose \"player\" or \"ai\"\n      print(f\"First turn: {self.current_player}\")  # Debugging: Check who starts\n\n      # \u2705 Show alert **before** making any move\n      if self.current_player == \"player\":\n          anvil.alert(\"Game reset. Your turn!\", title=\"New Game\", style=\"info\")\n          self.update_turn_indicator()\n      else:\n          anvil.alert(\"Game reset. AI's turn!\", title=\"New Game\", style=\"info\")\n          self.update_turn_indicator()\n          self.trigger_transformer_move()  # AI moves after the alert\n\n      if self.current_player == \"ai\":\n          self.trigger_transformer_move()  # AI makes the first move\n\n\n    def draw_turn_circle(self, color):\n      \"\"\"\n      Draws a 3D-like circular turn indicator with an outer ring.\n      Uses self.current_player to determine if AI or player.\n      \"\"\"\n      canvas = self.turn_indicator_circle\n      width, height = canvas.get_width(), canvas.get_height()\n      center_x, center_y = width \/\/ 2, height \/\/ 2\n      outer_radius = max(5, (min(width, height) \/\/ 2))   # Outer ring\n      inner_radius = max(5, (min(width, height) \/\/ 2) - 5)  # Inner circle\n  \n      # \u2705 Clear the previous drawing\n      canvas.clear_rect(0, 0, width, height)  \n  \n      # Adjust outer ring color based on current player\n      if self.current_player == \"ai\":\n          outer_color = \"#7A5C12\"  # Darker brownish-gold for AI\n          inner_color = \"#C8A500\"  # Darker yellow for AI\n      else:\n          outer_color = \"#A23C2D\"  # Dark Red outer ring for player\n          inner_color = color  # Use given color for player\n  \n      # Draw outer ring\n      canvas.begin_path()\n      canvas.arc(center_x, center_y, outer_radius, 0, 2 * 3.14159)\n      canvas.fill_style = outer_color  # Dynamically chosen color\n      canvas.fill()\n  \n      # Draw inner circle (Main Color)\n      canvas.begin_path()\n      canvas.arc(center_x, center_y, inner_radius, 0, 2 * 3.14159)\n      canvas.fill_style = inner_color\n      canvas.fill()\n  \n      # Add a slight shadow effect for depth\n      canvas.shadow_offset_x = 3\n      canvas.shadow_offset_y = 3\n      canvas.shadow_blur = 5\n      canvas.shadow_color = \"rgba(0, 0, 0, 0.2)\"\n  \n      # Redraw the inner circle to ensure shadow applies correctly\n      canvas.begin_path()\n      canvas.arc(center_x, center_y, inner_radius, 0, 2 * 3.14159)\n      canvas.fill_style = inner_color\n      canvas.fill()\n  \n      # Add a black border\n      canvas.stroke_style = \"black\"\n      canvas.line_width = 2\n      canvas.stroke()\n        \n  \n    def update_turn_indicator(self):\n      \"\"\"\n      Updates the turn indicator with text and a circle color.\n      \"\"\"\n      if self.current_player == \"player\":\n          self.turn_indicator_text.text = \"Player Turn\"\n          self.draw_turn_circle(\"#FF4500\")  # Player's red color\n      else:\n          self.turn_indicator_text.text = \"AI Turn\"\n          self.draw_turn_circle(\"#C8A500\")  # AI's yellow color\n      self.refresh_data_bindings()\n      \n    def reset_buttons(self):\n      \"\"\"\n      Resets all column buttons to an unselected state and ensures they are clickable.\n      \"\"\"\n      # Clear the selection for all buttons\n      self.column_button_0.selected = False\n      self.column_button_1.selected = False\n      self.column_button_2.selected = False\n      self.column_button_3.selected = False\n      self.column_button_4.selected = False\n      self.column_button_5.selected = False\n      self.column_button_6.selected = False\n  \n      # Ensure all buttons are enabled\n      self.column_button_0.enabled = True\n      self.column_button_1.enabled = True\n      self.column_button_2.enabled = True\n      self.column_button_3.enabled = True\n      self.column_button_4.enabled = True\n      self.column_button_5.enabled = True\n      self.column_button_6.enabled = True\n  \n      # Refresh the UI bindings to reflect the changes\n      self.refresh_data_bindings()\n  \n      # Debug: Print button states\n      print(\"Button states reset:\")\n      for i in range(7):\n          print(f\"Column {i} selected: {getattr(self, f'column_button_{i}').selected}, enabled: {getattr(self, f'column_button_{i}').enabled}\")\n\n\n    def column_button_0_click(self, **event_args):\n      \"\"\"This method is called when this radio button is selected\"\"\"\n      self.column_button_click(0)\n\n    def column_button_1_click(self, **event_args):\n      \"\"\"This method is called when this radio button is selected\"\"\"\n      self.column_button_click(1)\n  \n    def column_button_2_click(self, **event_args):\n      \"\"\"This method is called when this radio button is selected\"\"\"\n      self.column_button_click(2)\n  \n    def column_button_3_click(self, **event_args):\n      \"\"\"This method is called when this radio button is selected\"\"\"\n      self.column_button_click(3)\n  \n    def column_button_4_click(self, **event_args):\n      \"\"\"This method is called when this radio button is selected\"\"\"\n      self.column_button_click(4)\n  \n    def column_button_5_click(self, **event_args):\n      \"\"\"This method is called when this radio button is selected\"\"\"\n      self.column_button_click(5)\n  \n    def column_button_6_click(self, **event_args):\n      \"\"\"This method is called when this radio button is selected\"\"\"\n      self.column_button_click(6)\n  \n    def drop_menu_change(self, **event_args):\n        \"\"\"\n        Handles dropdown menu changes.\n        \"\"\"\n        selected_option = self.drop_menu.selected_value\n        if selected_option == \"Play Against CNN\":\n            open_form('FormCNN')\n            print(\"Switching to Play Against CNN\")\n            self.set_event_handler('show', self.form_show)\n        elif selected_option == \"Play Against Transformer\":\n            open_form('FormTransformer')\n            print(\"Switching to Play Against Transformer\")\n            self.set_event_handler('show', self.form_show)\n  \n    \n    def back_button_click(self, **event_args):\n      \"\"\"This method is called when the button is clicked\"\"\"\n      response = anvil.alert(\"Do you want to go to info page\", \n                        title=\"Confirmation\",\n                        buttons=[\"Yes\", \"No\"])\n        \n      if response == \"Yes\":\n          open_form('Form2')\n          print(\"User chose Yes!\")\n      elif response == \"No\":\n          print(\"User chose No!\")\n\n  \n    def reset_button_click(self, **event_args):\n      \"\"\"\n      Resets the game board to the initial state and randomly selects who plays first.\n      \"\"\"\n        # Reset the board\n      self.board = [[0 for _ in range(7)] for _ in range(6)]\n      self.game_over = False  # Allow new moves\n        \n      # Update the board and reset buttons\n      self.update_board()\n      self.reset_buttons()\n        \n      # Randomly select who starts\n      self.select_first_player()\n      # self.update_turn_indicator()  # Update the turn indicator\n\n      \n    def update_cell(self, row, column):\n        \"\"\"\n        Updates only a single cell in the UI without refreshing the whole board.\n        \"\"\"\n        try:\n            image = anvil.server.call(\"draw_board\", self.board)  # Call server to update image\n            self.connect4_image.source = image  # Update only the game image\n        except Exception as e:\n            print(f\"Error updating cell ({row}, {column}): {e}\")\n\n    def get_lowest_row(self, column):\n      \"\"\"\n      Returns the lowest available row in a column, or None if the column is full.\n      \"\"\"\n      for row in range(5, -1, -1):\n          if self.board[row][column] == 0:\n              return row\n      return None\n\n    def logout_button_click(self, **event_args):\n      \"\"\"This method is called when the button is clicked\"\"\"\n      response = anvil.alert(\"Do you want to logout?\", \n                       title=\"Confirmation\",\n                       buttons=[\"Yes\", \"No\"])\n      \n      if response == \"Yes\":\n          open_form('Form1')\n          print(\"User chose Yes!\")\n      elif response == \"No\":\n          print(\"User chose No!\")\n\n        \n    def set_column_buttons_enabled(self, enabled):\n      \"\"\"\n      Enables or disables column buttons. If enabling, restore valid buttons using `reset_buttons()`.\n      \"\"\"\n      if not enabled:\n          # \ud83d\udeab Disable all buttons while AI is thinking\n          for i in range(7):\n              getattr(self, f'column_button_{i}').enabled = False\n      else:\n          # \u2705 Restore valid buttons using reset_buttons()\n          self.reset_buttons()\n    \n  \n  \n\n\n\n","class_name":"FormTransformer","id":"1738709376979566780931775.1205"}],"services":[{"source":"\/runtime\/services\/tables.yml","client_config":{}},{"source":"\/runtime\/services\/anvil\/users.yml","client_config":{"allow_signup":false,"confirm_email":false,"enable_automatically":false,"use_email":true}}]},"appId":"GB4NLLJQNY6VL2WO","appOrigin":"https:\/\/ambitious-grim-station.anvil.app","appStartupData":null,"ideOrigin":"https:\/\/anvil.works","runtimeVersion":3,"isCrawler":null});const loadAppAfter = window.anvil._loadAppAfter || [];loadApp.then(function() { Promise.all(loadAppAfter).then(function() {window.openForm("Form1");});});});
</script>


</body></html>